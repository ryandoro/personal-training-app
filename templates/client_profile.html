{% extends "layout.html" %}

{% block title %}
    Client Profile
{% endblock %}

{% block content %}
<div class="container">
    {% set sessions_total = client.sessions_remaining %}
    {% set sessions_booked = client.sessions_booked or 0 %}
    {% set sessions_completed = sessions_completed or 0 %}
    {% if sessions_total is not none %}
        {% set sessions_consumed = sessions_booked + sessions_completed %}
        {% set sessions_left = [sessions_total - sessions_consumed, 0]|max %}
    {% else %}
        {% set sessions_left = None %}
    {% endif %}
    <div class="row g-4">
        <div class="col-12 col-lg-4">
            <div class="card shadow-sm border-0 h-100 overflow-hidden">
                <div class="p-4 text-white rounded-3" style="background: linear-gradient(135deg, #1EA4E6 0%, #33C3F0 100%);">
                    <div class="d-flex flex-column gap-3">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('trainer_dashboard') }}"
                               class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
                            </a>
                            <a href="{{ url_for('trainer_client_agenda', client_id=client.id) }}"
                               class="btn btn-agenda btn-sm">
                                <i class="bi bi-calendar-event me-1"></i>Agenda View
                            </a>
                        </div>
                        <form method="POST"
                              action="{{ url_for('trainer_remove_client', client_id=client.id) }}"
                              onsubmit="return confirm('Remove this client from your roster? All upcoming bookings will be cleared.');"
                              class="ms-auto">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="bi bi-person-dash me-1"></i>Remove Client
                            </button>
                        </form>
                    </div>
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle d-flex align-items-center justify-content-center bg-white text-dark"
                                 style="width: 64px; height: 64px; font-weight: 700;">
                                {{ (client.name or '')[:1] ~ (client.last_name or '')[:1] or 'C' }}
                            </div>
                            <div>
                                <h2 class="mb-1 text-white">{{ client.name or 'Client' }} {{ client.last_name or '' }}</h2>
                                <div class="d-flex flex-wrap align-items-center gap-2 small">
                                    <span class="badge bg-light text-dark">@{{ client.username }}</span>
                                    {% if client.subscription_type %}
                                        <span class="badge bg-light text-dark">{{ client.subscription_type|capitalize }} Plan</span>
                                    {% endif %}
                                    {% if sessions_total is not none %}
                                        <span class="badge bg-light text-dark">{{ sessions_left }} / {{ sessions_total }} Sessions Left</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">&infin; Sessions</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="text-muted d-block small">Email</span>
                        {% if client.email %}
                            <a href="mailto:{{ client.email }}" class="fw-semibold text-decoration-none">{{ client.email }}</a>
                        {% else %}
                            <span class="fw-semibold">—</span>
                        {% endif %}
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="text-muted small text-uppercase">Workouts</div>
                                <div class="fs-4 fw-bold">{{ client.workouts_completed or 0 }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <button type="button"
                                    class="sessions-tile"
                                    data-bs-toggle="modal"
                                    data-bs-target="#sessionsModal">
                                <span class="sessions-tile__label">Sessions Left</span>
                                {% if sessions_total is not none %}
                                    <span class="sessions-tile__value">{{ sessions_left }} / {{ sessions_total }}</span>
                                {% else %}
                                    <span class="sessions-tile__value">&infin;</span>
                                {% endif %}
                                <span class="sessions-tile__note">Booked: {{ sessions_booked }} • Completed: {{ sessions_completed }}</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="text-muted small text-uppercase">Duration</div>
                                <div class="fs-6 fw-semibold" id="client-duration-display">{{ client.workout_duration or 60 }} mins</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-3 bg-light text-center">
                                <div class="text-muted small text-uppercase">Last Workout</div>
                                <div class="fs-6 fw-semibold">{{ client.last_workout_completed or '—' }}</div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    {% if injury_status == 'Yes' %}
                    <div class="alert alert-danger d-flex flex-column gap-2" role="status">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                            <div>
                                <strong>Restrictions Active</strong>
                                <div class="small">The workout generator is currently skipping these categories:</div>
                            </div>
                        </div>
                        <div>
                            {% if injury_skip_tokens %}
                                <div class="mb-2">
                                    {% for token in injury_skip_tokens %}
                                        <span class="badge bg-light text-dark me-1 mb-1">{{ token }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if injury_region_labels %}
                                <div class="mb-2">
                                    <span class="small text-uppercase text-white-50 d-block">Areas flagged:</span>
                                    {% for label in injury_region_labels %}
                                        <span class="badge bg-danger text-white me-1 mb-1">{{ label }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="mb-0">
                                <em>{{ injury_details }}</em>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if client.additional_notes %}
                        <div>
                            <span class="text-muted d-block small">Client Notes</span>
                            <div class="fw-semibold">{{ client.additional_notes }}</div>
                        </div>
                    {% endif %}

                    {% set trainer_goals_list = (client.fitness_goals or '').split(',') | map('trim') | list %}
                    {% set trainer_chip_region_slugs = ['neck','shoulders','upper_back','lower_back','elbows','wrists','hips','knees','ankles','cardio'] %}

                    <div class="card shadow-sm border-0 mt-4 collapsible-card" style="margin-bottom: -2rem;">
                        <button type="button"
                                class="collapsible-toggle"
                                data-target="trainer-settings-card"
                                aria-expanded="false">
                            <span class="collapsible-title">Training Focus &amp; Restrictions</span>
                            <i class="bi bi-chevron-down collapsible-chevron" aria-hidden="true"></i>
                        </button>
                        <div id="trainer-settings-card" class="collapsible-content" hidden>
                            <div class="card-body bg-light-subtle">
                                <form method="POST" action="{{ url_for('trainer_update_client_training_profile', client_id=client.id) }}" class="mb-4">
                                    <div class="border rounded-3 p-3 bg-light-subtle">
                                        <label class="form-label fw-bold mb-1">Training Focus</label>
                                        <p class="form-text text-muted mb-3">Adjust the goals and training level used when generating workouts.</p>

                                        <div class="mb-3">
                                            <span class="form-label d-block">Fitness goals <small>(Select up to 2)</small></span>
                                            <div class="text-danger small mb-2" id="trainer-goal-warning" style="display:none;"></div>
                                            <div class="row row-cols-1 g-1">
                                                {% for goal in ['Lose Weight','Gain Muscle','Tone Muscle','Abs','Increase Strength','Increase Endurance','Feel Better'] %}
                                                    <div class="col">
                                                        <div class="form-check">
                                                            <input class="form-check-input trainer-goal-checkbox"
                                                                   type="checkbox"
                                                                   id="trainer-goal-{{ loop.index }}"
                                                                   name="fitness_goals"
                                                                   value="{{ goal }}"
                                                                   {% if goal in trainer_goals_list %}checked{% endif %}>
                                                            <label class="form-check-label" for="trainer-goal-{{ loop.index }}">{{ goal }}</label>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Exercise history</label>
                                                <select class="form-select" name="exercise_history" required>
                                                    <option value="" disabled {% if not client.exercise_history %}selected{% endif %}>Select an option</option>
                                                    {% for option in ['No Exercise History','Exercise less than 1 year','Exercise 1-5 years','Exercise 5+ years'] %}
                                                        <option value="{{ option }}" {% if client.exercise_history == option %}selected{% endif %}>{{ option }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Weekly commitment</label>
                                                <select class="form-select" name="commitment" required>
                                                    <option value="" disabled {% if not client.commitment %}selected{% endif %}>Select an option</option>
                                                    {% for option in ['1 day per week','2 days per week','3 days per week'] %}
                                                        <option value="{{ option }}" {% if client.commitment == option %}selected{% endif %}>{{ option }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <div class="d-grid mt-3">
                                            <button type="submit" class="btn btn-primary">Save Training Focus</button>
                                        </div>
                                    </div>
                                </form>

                                <hr class="my-4">

                                <form id="trainer-injury-form" method="POST" action="{{ url_for('trainer_update_client_injury', client_id=client.id) }}">
                                    <div class="border rounded-3 p-3 bg-light-subtle">
                                        <label class="form-label fw-bold mb-1">Update Restrictions</label>
                                        <p class="form-text text-muted mb-3">Changes here update the client's workout generator and account settings.</p>

                                        <div class="d-flex flex-wrap justify-content-center gap-3 mb-3">
                                            <div class="form-check">
                                                <input type="radio"
                                                       class="form-check-input"
                                                       id="trainer-injury-status-yes"
                                                       name="injury_status"
                                                       value="Yes"
                                                       {% if injury_status == 'Yes' %}checked{% endif %}>
                                                <label class="form-check-label" for="trainer-injury-status-yes">Yes</label>
                                            </div>
                                            <div class="form-check">
                                                <input type="radio"
                                                       class="form-check-input"
                                                       id="trainer-injury-status-no"
                                                       name="injury_status"
                                                       value="No"
                                                       {% if injury_status != 'Yes' %}checked{% endif %}>
                                                <label class="form-check-label" for="trainer-injury-status-no">No</label>
                                            </div>
                                        </div>

                                        <div id="trainer-injury-fields-wrapper"
                                             class="injury-fields-wrapper {% if injury_status == 'Yes' %}expanded{% else %}collapsed{% endif %}">
                                            <div id="trainer-injury-fields"
                                                 class="injury-fields text-center"
                                                 data-initial-regions='{{ injury_regions_json | e }}'
                                                 data-cardio-prefill="{{ 'true' if cardio_restriction else 'false' }}">

                                                <p class="text-muted small mb-2">Tap the buttons to mark areas the client should avoid.</p>

                                                <div class="injury-chip-cloud mb-3">
                                                    {% for slug in trainer_chip_region_slugs %}
                                                        {% set label = slug.replace('_', ' ')|title %}
                                                        {% set is_active = (slug in injury_regions) or (slug == 'cardio' and cardio_restriction) %}
                                                        <button type="button"
                                                                class="injury-chip"
                                                                data-region="{{ slug }}"
                                                                {% if is_active %}data-active="true" aria-pressed="true"{% else %}data-active="false" aria-pressed="false"{% endif %}>
                                                            {{ label }}
                                                        </button>
                                                    {% endfor %}
                                                </div>

                                                <input type="hidden" id="trainer-cardio-restriction" name="cardio_restriction" value="{% if cardio_restriction %}yes{% endif %}">

                                                <div class="mt-3 text-center">
                                                    <label for="trainer-injury-details" class="form-label fw-bold">Restriction Notes</label>
                                                    <textarea class="form-control"
                                                              id="trainer-injury-details"
                                                              name="injury_details"
                                                              rows="3"
                                                              placeholder="Provide context for these restrictions"
                                                              {% if injury_status == 'Yes' %}required{% endif %}
                                                              {% if injury_status != 'Yes' %}disabled{% endif %}>{{ injury_details }}</textarea>
                                                </div>

                                                <div class="mt-3 text-center">
                                                    <span class="small text-muted d-block">Selected areas:</span>
                                                    <div id="trainer-injury-selected" class="injury-selected-pills mt-2 text-start"></div>
                                                </div>

                                                <input type="hidden" id="trainer-injury-input" name="injury" value='{{ injury_regions_json | e }}'>
                                            </div>
                                        </div>

                                        <div class="d-grid mt-3">
                                            <button type="submit" class="btn btn-primary">Save Restrictions</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-8 training-container client-workout">
            <div class="card border-0 shadow-lg mb-4" style="border-radius: 20px;">
                <div class="card-header border-0" style="background: linear-gradient(135deg, #1EA4E6 0%, #33C3F0 100%); border-top-left-radius: 20px; border-top-right-radius: 20px;">
                    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-center text-white">
                        <div>
                            <h5 class="mb-1 text-white">Generate Workout for {{ client.name or client.username }}</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body bg-white p-4">
                    {% set wd = client.workout_duration or 60 %}
                    <div class="mb-4">
                        <label class="form-label fw-bold text-primary d-block">Workout Duration</label>
                        <div id="trainer-duration-pills"
                             class="d-flex flex-wrap gap-2 justify-content-center"
                             data-update-url="{{ url_for('trainer_update_client_duration', client_id=client.id) }}">
                            {% for minutes in [20, 30, 45, 60] %}
                                <button type="button"
                                        class="btn duration-pill rounded-pill px-3 py-2{% if wd == minutes %} active{% endif %}"
                                        data-minutes="{{ minutes }}"
                                        aria-pressed="{{ 'true' if wd == minutes else 'false' }}"
                                        aria-label="Set duration to {{ minutes }} minutes">
                                    {{ minutes }} min
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="category" class="form-label fw-bold text-primary">Workout Categories</label>
                                <select id="category" name="category" class="form-select text-center shadow-sm bitcoin-workout" required form="generate-client-workout">
                                    <option value="" disabled selected>Select a Workout Category</option>
                                    {% for category in category_options %}
                                        {% if category != custom_workout_token and category != home_workout_token %}
                                            <option value="{{ category }}">{{ category }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    {% if client_has_premium_access %}
                                        <option value="{{ custom_workout_token }}">{{ custom_workout_token }}</option>
                                        <option value="{{ home_workout_token }}">{{ home_workout_token }}</option>
                                    {% endif %}
                                </select>
                                <div id="trainer-custom-controls" class="mt-3 text-center" hidden>
                                    <button type="button" id="trainer-custom-button" class="btn btn-outline-primary btn-sm fw-semibold px-3">
                                        Choose Categories
                                    </button>
                                    <div id="trainer-custom-summary" class="small fw-semibold text-primary mt-1 d-none"></div>
                                </div>
                                <input type="hidden"
                                       id="trainer-custom-input"
                                       name="custom_categories"
                                       form="generate-client-workout"
                                       data-custom-token="{{ custom_workout_token }}"
                                       data-home-token="{{ home_workout_token }}"
                                       data-custom-limits='{{ custom_workout_limits | tojson }}'
                                       value='{{ active_workout.custom_categories | tojson if active_workout and active_workout.custom_categories else "[]" }}'>
                                <div id="trainer-home-equipment-controls" class="mt-3 text-center" hidden>
                                    <button type="button" id="trainer-home-equipment-button" class="btn btn-outline-primary btn-sm fw-semibold px-3">
                                        Choose Equipment
                                    </button>
                                    <div id="trainer-home-equipment-feedback" class="small text-muted mt-2 d-none"></div>
                                    <div id="trainer-home-equipment-summary" class="small fw-semibold text-primary mt-1 d-none"></div>
                                </div>
                                <input type="hidden"
                                       id="trainer-home-equipment-input"
                                       name="home_equipment"
                                       form="generate-client-workout"
                                       data-options='{{ home_equipment_options | tojson }}'
                                       value='{{ active_workout.home_equipment | tojson if active_workout and active_workout.home_equipment else "[]" }}'>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid mt-3">
                        <button id="generate-client-workout-btn"
                                type="submit"
                                class="btn btn-primary fw-bold btn-lg border rounded-3 px-4"
                                style="text-shadow: 0 0 1px rgba(0,0,0,0.25); box-shadow: 0 0 12px rgba(30,164,230,0.45);"
                                form="generate-client-workout">
                            Generate Workout
                        </button>
                    </div>
                </div>
                <form id="generate-client-workout" method="POST" action="{{ url_for('generate_client_workout', client_id=client.id) }}" hidden></form>
            </div>

            <div id="active-workout-card" class="card border-0 shadow-lg" style="border-radius: 20px;" tabindex="-1">
                <div class="card-header border-0" style="background: linear-gradient(135deg, #20c997 0%, #0ABFBC 100%); border-top-left-radius: 20px; border-top-right-radius: 20px;">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center text-white">
                        <div>
                            <h5 class="mb-1 text-white">Active Workout</h5>
                            {% if active_workout and active_workout.created_at %}
                                <small class="text-white-50">Assigned {{ active_workout.created_at }}</small>
                            {% endif %}
                        </div>
                        {% if active_workout and active_workout.plan %}
                            <form method="POST" action="{{ url_for('trainer_complete_client_workout', client_id=client.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-light text-success fw-semibold btn-sm">
                                    <i class="bi bi-check-circle me-1"></i>Mark Session Completed
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body bg-white p-4">
                    {% if active_workout and active_workout.plan %}
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            {% set is_custom_variant = active_workout.category in [custom_workout_token, home_workout_token] %}
                            {% if is_custom_variant and active_workout.custom_categories %}
                                {# Render the selected custom categories in a single badge #}
                                {% set pretty_custom = [] %}
                                {% for token in active_workout.custom_categories %}
                                    {% if token %}
                                        {% set pretty = token|lower|replace('_', ' ')|title %}
                                        {% set _ = pretty_custom.append(pretty) %}
                                    {% endif %}
                                {% endfor %}
                                <span class="badge text-bg-primary">{{ pretty_custom|join(', ') }}</span>
                            {% else %}
                                <span class="badge text-bg-primary">{{ active_workout.category }}</span>
                            {% endif %}
                            {% if active_workout.duration_minutes %}
                                <span class="badge text-bg-secondary">{{ active_workout.duration_minutes }} mins</span>
                            {% endif %}
                        </div>
                        {% for block in active_workout.plan %}
                            <div class="card workout-subcategory-card shadow-sm mb-4" style="border-radius: 16px;">
                                <h6 class="workout-subcategory-title">{{ block.subcategory }}</h6>
                                <div class="mt-3">
                                    <ul class="list-unstyled mb-0">
                                        {% for exercise in block.exercises %}
                                            {% set exercise_name = exercise.name or '' %}
                                            {% set subcategory_name = block.subcategory or '' %}
                                            {% set is_cardio = subcategory_name|lower == 'cardio' %}
                                            {% set is_bodyweight = 'bodyweight' in exercise_name|lower %}
                                            {% if is_bodyweight or is_cardio %}
                                                {% set weight_display = 'Bodyweight' %}
                                            {% elif exercise.max_weight is not none %}
                                                {% set weight_display = (exercise.max_weight|string) ~ ' lbs' %}
                                            {% else %}
                                                {% set weight_display = '—' %}
                                            {% endif %}
                                            {% if exercise.max_reps is not none %}
                                                {% set reps_unit = ' min' if is_cardio else ' reps' %}
                                                {% set reps_display = (exercise.max_reps|string) ~ reps_unit %}
                                            {% else %}
                                                {% set reps_display = '—' %}
                                            {% endif %}
                                            {% set notes_text = exercise.notes or '' %}
                                            {% set has_notes = notes_text|trim %}
                                            {% set start_raw = exercise.image_exercise_start %}
                                            {% set end_raw = exercise.image_exercise_end %}
                                            {% if start_raw %}
                                                {% if start_raw[:4]|lower == 'http' %}
                                                    {% set start_src = start_raw %}
                                                {% elif start_raw.startswith('/static/') %}
                                                    {% set start_src = start_raw %}
                                                {% elif '/' in start_raw %}
                                                    {% set start_src = url_for('static', filename=start_raw.lstrip('/')) %}
                                                {% else %}
                                                    {% set start_src = url_for('static', filename='images/' ~ start_raw) %}
                                                {% endif %}
                                            {% else %}
                                                {% set start_src = None %}
                                            {% endif %}
                                            {% if end_raw %}
                                                {% if end_raw[:4]|lower == 'http' %}
                                                    {% set end_src = end_raw %}
                                                {% elif end_raw.startswith('/static/') %}
                                                    {% set end_src = end_raw %}
                                                {% elif '/' in end_raw %}
                                                    {% set end_src = url_for('static', filename=end_raw.lstrip('/')) %}
                                                {% else %}
                                                    {% set end_src = url_for('static', filename='images/' ~ end_raw) %}
                                                {% endif %}
                                            {% else %}
                                                {% set end_src = None %}
                                            {% endif %}
                                            <li class="mb-4">
                                                <div class="card shadow text-center w-100 exercise-card">
                                                    <h6 class="exercise-name">{{ exercise_name }}</h6>
                                                    {% if start_src or end_src %}
                                                    <div class="exercise-media-row d-flex justify-content-center flex-nowrap mb-3 px-2">
                                                        {% if start_src %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <p class="exercise-media-label mb-2">Start:</p>
                                                            <img src="{{ start_src }}" alt="{{ exercise.name }} start" class="clickable-img exercise-media-image" data-group="{{ exercise_name|replace(' ', '-') }}-{{ loop.index }}" data-index="0">
                                                        </div>
                                                        {% endif %}
                                                        {% if end_src %}
                                                        <div class="d-flex flex-column align-items-center">
                                                            <p class="exercise-media-label mb-2">End:</p>
                                                            <img src="{{ end_src }}" alt="{{ exercise.name }} end" class="clickable-img exercise-media-image" data-group="{{ exercise_name|replace(' ', '-') }}-{{ loop.index }}" data-index="1">
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endif %}
                                                    {% if exercise.youtube_id %}
                                                    <p class="exercise-media-label mb-2">Video Demonstration:</p>
                                                    <div class="exercise-video-wrapper mb-4">
                                                        <div class="exercise-video-shell">
                                                            <iframe class="exercise-video-frame" src="https://www.youtube.com/embed/{{ exercise.youtube_id }}?mute=1&playsinline=1" title="{{ exercise_name }} tutorial" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                    <div class="d-flex flex-column align-items-center gap-3 max-actions">
                                                        <div class="personal-best max-summary" data-id="{{ exercise.workout_id }}" data-category="{{ block.subcategory }}">
                                                            <span class="max-label text-uppercase fw-semibold">Client Max</span>
                                                            <div class="max-pill-row">
                                                                <span class="max-pill max-pill-weight">{{ weight_display }}</span>
                                                                <span class="max-times">×</span>
                                                                <span class="max-pill max-pill-reps">{{ reps_display }}</span>
                                                            </div>
                                                            <span class="personal-max-text d-none">Client Max: {{ weight_display }} × {{ reps_display }}</span>
                                                        </div>
                                                        <div class="d-flex flex-wrap justify-content-center gap-2 max-action-buttons">
                                                            <button class="btn btn-outline-secondary btn-sm max-action-btn update-pr-link" data-id="{{ exercise.workout_id }}" data-category="{{ block.subcategory }}">Update Max</button>
                                                            <button class="btn btn-outline-primary btn-sm max-action-btn toggle-description" type="button" data-id="desc-{{ exercise.workout_id }}">View Description</button>
                                                        </div>
                                                    </div>
                                                    <div id="desc-{{ exercise.workout_id }}" class="exercise-description mt-3 text-center" style="display: none;">
                                                        <p class="small text-muted mb-0">{{ exercise.description or 'No description available.' }}</p>
                                                    </div>
                                                    <div class="exercise-notes mt-3 text-start">
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <i class="bi bi-journal-text text-primary"></i>
                                                            <button class="btn btn-outline-info btn-sm edit-notes-btn" data-id="{{ exercise.workout_id }}" data-category="{{ block.subcategory }}" data-notes="{{ notes_text|urlencode }}">{{ 'Edit Notes' if has_notes else 'Add Notes' }}</button>
                                                        </div>
                                                        <div class="notes-body small" data-id="{{ exercise.workout_id }}">
                                                            {% if has_notes %}{{ notes_text|replace('\n', '<br>')|safe }}{% else %}<span class="text-muted">{{ NOTES_PLACEHOLDER }}</span>{% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="text-center mt-4">
                            <form method="POST" action="{{ url_for('trainer_complete_client_workout', client_id=client.id) }}">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check-circle me-1"></i>Mark Session Completed
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-clipboard2-heart fs-1 d-block mb-3"></i>
                            No active workout assigned yet. Generate a workout to sync with your client.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="sessionsModal" tabindex="-1" aria-labelledby="sessionsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="sessionsModalLabel">Manage Session Balance</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">
                        {% if sessions_total is not none %}
                            {{ sessions_left }} of {{ sessions_total }} session{{ sessions_total == 1 and '' or 's' }} remain. Booked: {{ sessions_booked }} • Completed: {{ sessions_completed }}.
                        {% else %}
                            This client currently has unlimited sessions. Booked: {{ sessions_booked }} • Completed: {{ sessions_completed }}.
                        {% endif %}
                    </p>
                    <form id="sessionsRemainingForm" method="POST" action="{{ url_for('trainer_update_sessions_remaining', client_id=client.id) }}">
                        <label for="sessionsRemainingInput" class="form-label">Total Sessions Assigned</label>
                        <input type="number"
                               class="form-control"
                               id="sessionsRemainingInput"
                               name="sessions_remaining"
                               min="0"
                               value="{{ sessions_total if sessions_total is not none else '' }}"
                               placeholder="Leave blank for unlimited">
                        <div class="form-text">Enter the total number of sessions purchased. Leave blank to allow unlimited sessions.</div>
                    </form>
                </div>
                <div class="modal-footer flex-column flex-md-row gap-2">
                    <button type="submit" class="btn btn-primary w-100 w-md-auto" form="sessionsRemainingForm">Save Changes</button>
                    <a href="{{ url_for('trainer_dashboard', focus='client-' ~ client.id, action='book') }}"
                       class="btn btn-outline-primary w-100 w-md-auto">
                        <i class="bi bi-calendar-event me-1"></i>Book Session
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="toastSuccess" class="toast-floating fw-bold" style="display:none; background:#d1e7dd; color:#0f5132;"></div>

    <div id="trainerCustomModal" class="modal-overlay" style="display: none;">
        <div class="modal-card custom-workout-modal selection-modal">
            <button type="button" id="trainerCustomModalClose" class="btn-close"></button>
            <h5 class="mb-2">Build Custom Gym Workout</h5>
            <p class="small text-muted mb-3" id="trainer-custom-limit-text">Select categories to get started.</p>
            <div class="selection-grid">
                {% for category in custom_workout_categories %}
                    <div class="form-check custom-workout-check selection-tile">
                        <input class="form-check-input trainer-custom-checkbox" type="checkbox" value="{{ category }}" id="trainer-custom-cat-{{ loop.index }}">
                        <label class="form-check-label fw-semibold" for="trainer-custom-cat-{{ loop.index }}">{{ category.title() }}</label>
                    </div>
                {% endfor %}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button type="button" class="btn btn-link text-decoration-none px-0" id="trainerCustomClear">Clear All</button>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="trainerCustomCancel">Cancel</button>
                    <button type="button" class="btn btn-brand" id="trainerCustomApply">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <div id="trainerHomeEquipmentModal" class="modal-overlay" style="display: none;">
        <div class="modal-card custom-workout-modal selection-modal">
            <button type="button" id="trainerHomeEquipmentModalClose" class="btn-close"></button>
            <h5 class="mb-2">Choose Home Equipment</h5>
            <p class="small text-muted mb-3">Select the equipment your client has access to.</p>
            <div class="selection-grid">
                {% for option in home_equipment_options %}
                    <div class="form-check custom-workout-check selection-tile">
                        <input class="form-check-input trainer-home-equipment-checkbox" type="checkbox" value="{{ option.token }}" id="trainer-home-equip-{{ loop.index }}">
                        <label class="form-check-label fw-semibold" for="trainer-home-equip-{{ loop.index }}">{{ option.label }}</label>
                    </div>
                {% endfor %}
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button type="button" class="btn btn-link text-decoration-none px-0" id="trainerHomeEquipmentClear">Clear All</button>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="trainerHomeEquipmentCancel">Cancel</button>
                    <button type="button" class="btn btn-brand" id="trainerHomeEquipmentApply">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <div id="prModal" class="modal fade" tabindex="-1" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Update Personal Record</h5>
                    <button type="button" class="btn-close btn-close-white" id="prModalClose" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Max Weight (lbs)</label>
                            <input type="number" class="form-control" id="maxWeightInput" step="0.5" min="0" placeholder="Max Weight (lbs)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Reps / Minutes</label>
                            <input type="number" class="form-control" id="maxRepsInput" step="1" min="0" placeholder="Reps">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closePrModal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitPrBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notesModal" class="modal fade" tabindex="-1" style="display:none; align-items:center; justify-content:center;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title">Workout Notes</h5>
                    <button type="button" class="btn-close" id="notesModalClose" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="notesTextarea" class="form-control" rows="5" placeholder="Add session notes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeNotesModal">Cancel</button>
                    <button type="button" class="btn btn-info" id="saveNotesBtn">Save Notes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="imageModal" style="
        display:none;
        position:fixed;
        inset:0;
        z-index:10000;
        background:rgba(0,0,0,0.8);
    ">
        <div id="imageModalContent" style="
            position:relative;
            width:100%;
            height:100%;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
        ">
            <div id="imageWrapper" style="
                position:relative;
                max-width:90vw;
                max-height:80vh;
                display:flex;
                align-items:center;
                justify-content:center;
            ">
                <span id="modalClose" style="position:absolute; top:-6px; right:8px; font-size:1.8rem; color:rgba(220,220,220,0.85); cursor:pointer; z-index:10001;">&times;</span>
                <img id="modalImage" style="max-width:100%; max-height:100%; display:block; border-radius:12px; box-shadow:0 18px 36px rgba(0,0,0,0.35);">
            </div>
            <div id="swipeOverlay" style="margin-top:16px; text-align:center; color:rgba(220,220,220,0.8); font-size:1.5rem; font-weight:bold; pointer-events:none; text-shadow:0 0 8px rgba(0,0,0,0.65);">&lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;</div>
        </div>
    </div>

</div>

<script>
(function(){
    const updatePrUrl = "{{ url_for('trainer_update_pr', client_id=client.id) }}";
    const updateNotesUrl = "{{ url_for('trainer_update_notes', client_id=client.id) }}";
    const NOTES_PLACEHOLDER = 'No notes yet.';

    const toast = document.getElementById('toastSuccess');
    const prModal = document.getElementById('prModal');
    const notesModal = document.getElementById('notesModal');
    const maxWeightInput = document.getElementById('maxWeightInput');
    const maxRepsInput = document.getElementById('maxRepsInput');
    const notesTextarea = document.getElementById('notesTextarea');
    const durationPillsWrap = document.getElementById('trainer-duration-pills');
    const durationDisplay = document.getElementById('client-duration-display');
    const durationBadge = document.getElementById('client-duration-badge');
    const categorySelect = document.getElementById('category');
    const generateWorkoutBtn = document.getElementById('generate-client-workout-btn');
    const generateWorkoutForm = document.getElementById('generate-client-workout');
    const trainerCustomInput = document.getElementById('trainer-custom-input');
    const trainerCustomControls = document.getElementById('trainer-custom-controls');
    const trainerCustomButton = document.getElementById('trainer-custom-button');
    const trainerCustomFeedback = document.getElementById('trainer-custom-feedback');
    const trainerCustomSummary = document.getElementById('trainer-custom-summary');
    const trainerCustomModal = document.getElementById('trainerCustomModal');
    const trainerCustomModalClose = document.getElementById('trainerCustomModalClose');
    const trainerCustomApply = document.getElementById('trainerCustomApply');
    const trainerCustomCancel = document.getElementById('trainerCustomCancel');
    const trainerCustomClear = document.getElementById('trainerCustomClear');
    const trainerCustomLimitText = document.getElementById('trainer-custom-limit-text');
    const trainerCustomCheckboxes = trainerCustomModal ? Array.from(trainerCustomModal.querySelectorAll('.trainer-custom-checkbox')) : [];
    const trainerCustomToken = trainerCustomInput ? trainerCustomInput.dataset.customToken : '';
    const trainerHomeWorkoutToken = trainerCustomInput ? trainerCustomInput.dataset.homeToken : '';
    const trainerCustomCategoryTokens = new Set(
        [trainerCustomToken, trainerHomeWorkoutToken].filter(Boolean)
    );
    const trainerHomeEquipmentControls = document.getElementById('trainer-home-equipment-controls');
    const trainerHomeEquipmentButton = document.getElementById('trainer-home-equipment-button');
    const trainerHomeEquipmentFeedback = document.getElementById('trainer-home-equipment-feedback');
    const trainerHomeEquipmentSummary = document.getElementById('trainer-home-equipment-summary');
    const trainerHomeEquipmentInput = document.getElementById('trainer-home-equipment-input');
    const trainerHomeEquipmentModal = document.getElementById('trainerHomeEquipmentModal');
    const trainerHomeEquipmentModalClose = document.getElementById('trainerHomeEquipmentModalClose');
    const trainerHomeEquipmentApply = document.getElementById('trainerHomeEquipmentApply');
    const trainerHomeEquipmentCancel = document.getElementById('trainerHomeEquipmentCancel');
    const trainerHomeEquipmentClear = document.getElementById('trainerHomeEquipmentClear');
    const trainerHomeEquipmentCheckboxes = trainerHomeEquipmentModal ? Array.from(trainerHomeEquipmentModal.querySelectorAll('.trainer-home-equipment-checkbox')) : [];
    let trainerCustomLimits = {};
    try {
        trainerCustomLimits = trainerCustomInput ? JSON.parse(trainerCustomInput.dataset.customLimits || '{}') : {};
    } catch (err) {
        console.warn('Failed to parse trainer custom workout limits.', err);
        trainerCustomLimits = {};
    }
    let trainerHomeEquipmentOptions = [];
    try {
        trainerHomeEquipmentOptions = trainerHomeEquipmentInput ? JSON.parse(trainerHomeEquipmentInput.dataset.options || '[]') : [];
    } catch (err) {
        console.warn('Failed to parse trainer home equipment options.', err);
        trainerHomeEquipmentOptions = [];
    }
    const trainerHomeEquipmentLabelMap = new Map();
    trainerHomeEquipmentOptions.forEach((option) => {
        const token = String(option?.token || '').toUpperCase();
        if (!token || trainerHomeEquipmentLabelMap.has(token)) return;
        trainerHomeEquipmentLabelMap.set(token, option?.label || option?.token || token);
    });
    let trainerDraftSelection = new Set();
    let trainerDraftHomeEquipmentSelection = new Set();
    let trainerActiveDuration = parseInt((durationDisplay?.textContent || '').replace(/[^0-9]/g, ''), 10) || 60;

    function normalizeTrainerSelection(values) {
        const seen = new Set();
        const normalized = [];
        (values || []).forEach((raw) => {
            const token = String(raw || '').trim().toUpperCase();
            if (!token || seen.has(token)) return;
            seen.add(token);
            normalized.push(token);
        });
        return normalized;
    }

    function getTrainerSelection() {
        if (!trainerCustomInput) return [];
        try {
            const parsed = JSON.parse(trainerCustomInput.value || '[]');
            const arrayValue = Array.isArray(parsed) ? parsed : [parsed];
            return normalizeTrainerSelection(arrayValue);
        } catch {
            return [];
        }
    }

    function setTrainerSelection(values) {
        if (!trainerCustomInput) return;
        const normalized = normalizeTrainerSelection(values);
        trainerCustomInput.value = JSON.stringify(normalized);
        updateTrainerCustomSummary();
        syncGenerateButtonState();
    }

    function normalizeTrainerEquipmentSelection(values) {
        const seen = new Set();
        const normalized = [];
        (values || []).forEach((raw) => {
            const token = String(raw || '').trim().toUpperCase();
            if (!token || seen.has(token)) return;
            seen.add(token);
            normalized.push(token);
        });
        return normalized;
    }

    function getTrainerHomeEquipmentSelection() {
        if (!trainerHomeEquipmentInput) return [];
        try {
            const parsed = JSON.parse(trainerHomeEquipmentInput.value || '[]');
            return normalizeTrainerEquipmentSelection(Array.isArray(parsed) ? parsed : [parsed]);
        } catch {
            return [];
        }
    }

    function setTrainerHomeEquipmentSelection(values) {
        if (!trainerHomeEquipmentInput) return;
        const normalized = normalizeTrainerEquipmentSelection(values);
        trainerHomeEquipmentInput.value = JSON.stringify(normalized);
        syncTrainerHomeEquipmentFeedback(normalized);
        syncGenerateButtonState();
    }

    function isTrainerCustomSelected() {
        const value = categorySelect?.value || '';
        return !!value && trainerCustomCategoryTokens.has(value);
    }

    function isTrainerHomeSelected() {
        const homeToken = trainerHomeWorkoutToken || '';
        return !!homeToken && (categorySelect?.value || '') === homeToken;
    }

    function getTrainerDuration() {
        return trainerActiveDuration;
    }

    function getTrainerCustomLabel() {
        if (!categorySelect || !categorySelect.value) {
            return trainerCustomToken || 'Custom Gym Workout';
        }
        if (isTrainerHomeSelected()) {
            return trainerHomeWorkoutToken || 'Custom Home Workout';
        }
        return trainerCustomToken || 'Custom Gym Workout';
    }

    function trainerSelectionBounds(minutes) {
        const key = String(minutes);
        const entry = trainerCustomLimits[key] || trainerCustomLimits[minutes] || {};
        const minRequired = Math.max(1, Number(entry.min ?? 1));
        const maxAllowed = Math.max(minRequired, Number(entry.max ?? (trainerCustomCheckboxes.length || 1)));
        return [minRequired, maxAllowed];
    }

    function isTrainerSelectionValid() {
        if (!isTrainerCustomSelected()) return true;
        const selection = getTrainerSelection();
        const [minRequired, maxAllowed] = trainerSelectionBounds(getTrainerDuration());
        return selection.length >= minRequired && selection.length <= maxAllowed;
    }

    function updateTrainerCustomSummary() {
        if (!trainerCustomControls) return;
        const isActive = isTrainerCustomSelected();
        trainerCustomControls.hidden = !isActive;
        trainerCustomControls.style.display = isActive ? 'block' : 'none';
        trainerCustomControls.style.pointerEvents = isActive ? 'auto' : 'none';
        if (trainerCustomButton) {
            trainerCustomButton.disabled = !isActive;
            trainerCustomButton.setAttribute('aria-disabled', isActive ? 'false' : 'true');
        }
        if (!isActive) {
            return;
        }

        const selection = getTrainerSelection();
        const [minRequired, maxAllowed] = trainerSelectionBounds(getTrainerDuration());
        const withinBounds = selection.length >= minRequired && selection.length <= maxAllowed;

        if (trainerCustomFeedback) {
            const rangeText = minRequired === maxAllowed
                ? `Select exactly ${minRequired}`
                : `Select ${minRequired}–${maxAllowed}`;
            trainerCustomFeedback.textContent = `${rangeText} categories for a ${getTrainerDuration()}-minute ${getTrainerCustomLabel()}.`;
            trainerCustomFeedback.classList.toggle('text-danger', !withinBounds);
        }

        if (trainerCustomSummary) {
            trainerCustomSummary.classList.remove('d-none');
            if (!selection.length) {
                trainerCustomSummary.textContent = 'No categories selected yet.';
                trainerCustomSummary.classList.add('text-muted');
            } else {
                trainerCustomSummary.textContent = `Selected: ${selection.map(normalizeTrainerLabel).join(', ')}`;
                trainerCustomSummary.classList.remove('text-muted');
            }
            trainerCustomSummary.classList.toggle('text-danger', selection.length > 0 && !withinBounds);
        }
    }

    function normalizeTrainerLabel(value) {
        return String(value || '')
            .toLowerCase()
            .replace(/_/g, ' ')
            .replace(/\b\w/g, (char) => char.toUpperCase());
    }

    function formatTrainerEquipmentLabel(token) {
        return trainerHomeEquipmentLabelMap.get(token) || normalizeTrainerLabel(token);
    }

    function syncTrainerHomeEquipmentFeedback(selection) {
        if (!trainerHomeEquipmentFeedback) return;
        const tokens = Array.isArray(selection) ? selection : getTrainerHomeEquipmentSelection();
        if (!isTrainerHomeSelected()) {
            trainerHomeEquipmentFeedback.classList.add('d-none');
            trainerHomeEquipmentFeedback.classList.remove('text-danger');
            trainerHomeEquipmentFeedback.textContent = '';
            if (trainerHomeEquipmentSummary) {
                trainerHomeEquipmentSummary.classList.add('d-none');
                trainerHomeEquipmentSummary.textContent = '';
            }
            return;
        }
        if (!tokens.length) {
            trainerHomeEquipmentFeedback.classList.add('text-danger');
            trainerHomeEquipmentFeedback.innerHTML = '<span class="fw-semibold">No equipment selected yet.</span>';
            trainerHomeEquipmentFeedback.classList.remove('d-none');
            if (trainerHomeEquipmentSummary) {
                trainerHomeEquipmentSummary.classList.add('d-none');
                trainerHomeEquipmentSummary.textContent = '';
            }
            return;
        }
        trainerHomeEquipmentFeedback.classList.remove('text-danger');
        trainerHomeEquipmentFeedback.classList.add('d-none');
        trainerHomeEquipmentFeedback.textContent = '';
        if (trainerHomeEquipmentSummary) {
            const pretty = tokens.map((token) => formatTrainerEquipmentLabel(token)).join(', ');
            trainerHomeEquipmentSummary.textContent = `Selected: ${pretty}`;
            trainerHomeEquipmentSummary.classList.remove('d-none');
        }
    }

    function updateTrainerHomeEquipmentControls() {
        if (!trainerHomeEquipmentControls) return;
        const isHome = isTrainerHomeSelected();
        trainerHomeEquipmentControls.hidden = !isHome;
        trainerHomeEquipmentControls.style.display = isHome ? 'block' : 'none';
        trainerHomeEquipmentControls.style.pointerEvents = isHome ? 'auto' : 'none';
        if (trainerHomeEquipmentButton) {
            trainerHomeEquipmentButton.disabled = !isHome;
            trainerHomeEquipmentButton.setAttribute('aria-disabled', isHome ? 'false' : 'true');
        }
        if (!isHome && trainerHomeEquipmentSummary) {
            trainerHomeEquipmentSummary.classList.add('d-none');
            trainerHomeEquipmentSummary.textContent = '';
        }
        syncTrainerHomeEquipmentFeedback();
    }

    function syncTrainerModalCheckboxes() {
        if (!trainerCustomCheckboxes.length) return;
        trainerCustomCheckboxes.forEach((checkbox) => {
            checkbox.checked = trainerDraftSelection.has(checkbox.value);
        });
    }

    function updateTrainerModalStatus() {
        if (!trainerCustomLimitText) return;
        const [minRequired, maxAllowed] = trainerSelectionBounds(getTrainerDuration());
        const selected = trainerDraftSelection.size;
        const rangeText = minRequired === maxAllowed
            ? `Select exactly ${minRequired}`
            : `Select ${minRequired}–${maxAllowed}`;
        trainerCustomLimitText.textContent = `${rangeText} categories in your preferred order (${selected} selected).`;
        const valid = selected >= minRequired && selected <= maxAllowed;
        trainerCustomLimitText.classList.toggle('text-danger', !valid);
    }

    function flashTrainerModalWarning() {
        if (!trainerCustomLimitText) return;
        trainerCustomLimitText.classList.add('text-danger');
        trainerCustomLimitText.classList.add('fw-semibold');
        setTimeout(() => trainerCustomLimitText.classList.remove('fw-semibold'), 800);
    }

    function openTrainerCustomModal() {
        if (!trainerCustomModal) return;
        trainerDraftSelection = new Set(getTrainerSelection());
        syncTrainerModalCheckboxes();
        updateTrainerModalStatus();
        trainerCustomModal.style.display = 'flex';
        requestAnimationFrame(() => trainerCustomModal.classList.add('show'));
    }

    function closeTrainerCustomModal() {
        if (!trainerCustomModal) return;
        trainerCustomModal.classList.remove('show');
        trainerCustomModal.style.display = 'none';
        trainerDraftSelection = new Set(getTrainerSelection());
        syncTrainerModalCheckboxes();
        updateTrainerModalStatus();
    }

    function syncTrainerHomeEquipmentCheckboxes() {
        if (!trainerHomeEquipmentCheckboxes.length) return;
        trainerHomeEquipmentCheckboxes.forEach((checkbox) => {
            const token = (checkbox.value || '').toUpperCase();
            checkbox.checked = trainerDraftHomeEquipmentSelection.has(token);
        });
    }

    function openTrainerHomeEquipmentModal() {
        if (!trainerHomeEquipmentModal) return;
        trainerDraftHomeEquipmentSelection = new Set(getTrainerHomeEquipmentSelection());
        syncTrainerHomeEquipmentCheckboxes();
        trainerHomeEquipmentModal.style.display = 'flex';
        requestAnimationFrame(() => trainerHomeEquipmentModal.classList.add('show'));
    }

    function closeTrainerHomeEquipmentModal() {
        if (!trainerHomeEquipmentModal) return;
        trainerHomeEquipmentModal.classList.remove('show');
        trainerHomeEquipmentModal.style.display = 'none';
    }

    function handleTrainerDurationChange(minutes) {
        if (!trainerCustomInput) return;
        trainerActiveDuration = parseInt(minutes, 10) || trainerActiveDuration;
        const selection = getTrainerSelection();
        const [minRequired, maxAllowed] = trainerSelectionBounds(trainerActiveDuration);
        let nextSelection = selection;

        if (selection.length > maxAllowed) {
            nextSelection = selection.slice(0, maxAllowed);
            setTrainerSelection(nextSelection);
            if (trainerCustomFeedback) {
                trainerCustomFeedback.classList.add('text-danger');
                setTimeout(() => trainerCustomFeedback.classList.remove('text-danger'), 1200);
            }
        } else {
            setTrainerSelection(selection);
        }

        if (trainerCustomModal && trainerCustomModal.classList.contains('show')) {
            trainerDraftSelection = new Set(nextSelection);
            syncTrainerModalCheckboxes();
            updateTrainerModalStatus();
        }

        if (selection.length < minRequired) {
            updateTrainerCustomSummary();
        }
    }
    const trainerGoalCheckboxes = document.querySelectorAll('.trainer-goal-checkbox');
    const trainerGoalWarning = document.getElementById('trainer-goal-warning');

    let currentWorkoutId = null;

    function safeParseJSON(value, fallback) {
        if (!value) return Array.isArray(fallback) ? fallback : [];
        try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) return parsed;
            if (parsed && typeof parsed === 'object') return Object.values(parsed);
            return Array.isArray(fallback) ? fallback : [];
        } catch {
            return Array.isArray(fallback) ? fallback : [];
        }
    }

    function normalizeRegionSlug(value) {
        return String(value || '')
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '');
    }

    function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showToast(message, variant = 'success') {
        if (!toast) return;
        toast.textContent = message;
        toast.style.display = 'block';
        if (variant === 'success') {
            toast.style.background = '#d1e7dd';
            toast.style.color = '#0f5132';
            toast.style.border = '1px solid #5cb85c';
        } else {
            toast.style.background = '#f8d7da';
            toast.style.color = '#842029';
        }
        setTimeout(() => { toast.style.display = 'none'; }, 3000);
    }

    function openModal(modal) {
        if (!modal) return;
        modal.classList.add('show');
        modal.style.display = 'flex';
    }

    function closeModal(modal) {
        if (!modal) return;
        modal.classList.remove('show');
        modal.style.display = 'none';
    }

    function setDurationUi(minutes, pills) {
        if (pills && pills.length) {
            pills.forEach(btn => {
                const isActive = String(btn.dataset.minutes) === String(minutes);
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
            });
        }
        trainerActiveDuration = parseInt(minutes, 10) || trainerActiveDuration;
        if (durationDisplay) {
            durationDisplay.textContent = `${minutes} mins`;
        }
        if (durationBadge) {
            durationBadge.textContent = `Duration ${minutes} mins`;
        }
    }

    function syncSelectStyle() {
        if (!categorySelect) return;
        categorySelect.classList.toggle('select-orange', !!categorySelect.value);
        updateTrainerCustomSummary();
        updateTrainerHomeEquipmentControls();
    }

    function syncGenerateButtonState() {
        if (!generateWorkoutBtn) return;
        const hasCategory = !!(categorySelect && categorySelect.value);
        const isLoading = generateWorkoutBtn.dataset.loading === 'true';
        const customValid = isTrainerSelectionValid();
        const equipmentValid = !isTrainerHomeSelected() || getTrainerHomeEquipmentSelection().length > 0;
        generateWorkoutBtn.disabled = !hasCategory || isLoading || !customValid || !equipmentValid;
    }

    function setGenerateButtonLoading(isLoading) {
        if (!generateWorkoutBtn) return;
        generateWorkoutBtn.dataset.loading = isLoading ? 'true' : 'false';
        generateWorkoutBtn.textContent = isLoading ? 'Generating...' : 'Generate Workout';
        syncGenerateButtonState();
    }

    function bindTrainerGoalLimit() {
        if (!trainerGoalCheckboxes || !trainerGoalCheckboxes.length) return;
        trainerGoalCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
                const checked = Array.from(trainerGoalCheckboxes).filter(cb => cb.checked);
                if (checked.length > 2) {
                    checkbox.checked = false;
                    if (trainerGoalWarning) {
                        trainerGoalWarning.style.display = 'block';
                        trainerGoalWarning.textContent = 'You can only select up to 2 goals.';
                    }
                } else if (trainerGoalWarning) {
                    trainerGoalWarning.style.display = checked.length ? 'none' : 'block';
                    if (!checked.length) {
                        trainerGoalWarning.textContent = 'Select at least 1 goal.';
                    }
                }
            });
        });

        const trainerGoalsForm = trainerGoalCheckboxes[0]?.closest('form');
        if (trainerGoalsForm) {
            trainerGoalsForm.addEventListener('submit', (event) => {
                const checked = Array.from(trainerGoalCheckboxes).filter(cb => cb.checked);
                if (!checked.length || checked.length > 2) {
                    event.preventDefault();
                    if (trainerGoalWarning) {
                        trainerGoalWarning.style.display = 'block';
                        trainerGoalWarning.textContent = checked.length ? 'You can only select up to 2 goals.' : 'Select at least 1 goal.';
                    }
                }
            });
        }
    }

    function bindDurationPills() {
        if (!durationPillsWrap) return;
        const updateUrl = durationPillsWrap.dataset.updateUrl || '';
        if (!updateUrl) return;

        const pills = Array.from(durationPillsWrap.querySelectorAll('.duration-pill'));
        if (!pills.length) return;

        let activeMinutes = pills.find(btn => btn.classList.contains('active'))?.dataset.minutes || String((durationDisplay?.textContent || '').replace(/[^0-9]/g, '') || '60');

        pills.forEach(btn => {
            btn.addEventListener('click', () => {
                const minutes = btn.dataset.minutes;
                if (!minutes || minutes === activeMinutes) return;

                const previous = activeMinutes;
                setDurationUi(minutes, pills);
                activeMinutes = minutes;
                handleTrainerDurationChange(minutes);

                fetch(updateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workout_duration: minutes })
                })
                .then(res => res.json().catch(() => ({})))
                .then(data => {
                    if (!data || !data.success) {
                        activeMinutes = previous;
                        setDurationUi(previous, pills);
                        handleTrainerDurationChange(previous);
                        alert(data?.error || 'Could not update workout duration.');
                        return;
                    }
                    showToast('Duration updated!');
                })
                .catch(() => {
                    activeMinutes = previous;
                    setDurationUi(previous, pills);
                     handleTrainerDurationChange(previous);
                    alert('Network error while updating duration.');
                });
            });
        });
    }

    function setupTrainerInjuryForm() {
        const form = document.getElementById('trainer-injury-form');
        const fields = document.getElementById('trainer-injury-fields');
        if (!form || !fields) return;

        const wrapper = document.getElementById('trainer-injury-fields-wrapper');
        const yesRadio = document.getElementById('trainer-injury-status-yes');
        const noRadio = document.getElementById('trainer-injury-status-no');
        const chips = Array.from(fields.querySelectorAll('.injury-chip'));
        const injuryInput = document.getElementById('trainer-injury-input');
        const cardioInput = document.getElementById('trainer-cardio-restriction');
        const selectedContainer = document.getElementById('trainer-injury-selected');
        const textarea = document.getElementById('trainer-injury-details');

        const labels = new Map();
        chips.forEach((chip) => labels.set(chip.dataset.region, chip.textContent.trim()));

        const state = { regions: new Set() };

        function loadInitialState() {
            const initialRegions = safeParseJSON(fields.dataset.initialRegions, []);
            initialRegions.forEach((region) => {
                const slug = normalizeRegionSlug(region);
                if (slug) state.regions.add(slug);
            });
            if (fields.dataset.cardioPrefill === 'true') state.regions.add('cardio');
        }

        function syncHiddenFields() {
            if (injuryInput) {
                injuryInput.value = JSON.stringify(Array.from(state.regions));
            }
            if (cardioInput) {
                const restrictCardio = state.regions.has('cardio');
                cardioInput.value = restrictCardio ? 'yes' : '';
                cardioInput.disabled = false;
            }
        }

        function syncChips() {
            chips.forEach((chip) => {
                const slug = chip.dataset.region;
                const active = state.regions.has(slug);
                chip.classList.toggle('active', active);
                chip.dataset.active = active ? 'true' : 'false';
                chip.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
        }

        function prettyLabel(slug) {
            return labels.get(slug) || slug.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function syncSelectedList() {
            if (!selectedContainer) return;
            selectedContainer.innerHTML = '';
            if (!state.regions.size) {
                selectedContainer.innerHTML =
                    '<span class="badge bg-secondary-subtle text-muted">No areas selected</span>';
                return;
            }
            state.regions.forEach((slug) => {
                const pill = document.createElement('span');
                pill.className = 'badge injury-pill bg-bitcoin text-dark me-1 mb-1';
                pill.textContent = prettyLabel(slug);
                selectedContainer.appendChild(pill);
            });
        }

        function syncAll() {
            syncHiddenFields();
            syncChips();
            syncSelectedList();
        }

        function clearInjurySection() {
            state.regions.clear();
            syncAll();
            if (textarea) {
                textarea.value = '';
            }
        }

        function toggleInjuryFields(enabled) {
            if (wrapper) {
                wrapper.classList.toggle('expanded', enabled);
                wrapper.classList.toggle('collapsed', !enabled);
            }
            fields.classList.toggle('is-disabled', !enabled);

            setTimeout(() => {
                chips.forEach((chip) => (chip.disabled = !enabled));
                if (textarea) {
                    textarea.disabled = !enabled;
                    textarea.required = enabled;
                }
            }, 200);

            if (!enabled) {
                clearInjurySection();
            }
        }

        function toggleRegion(slug) {
            const normalized = normalizeRegionSlug(slug);
            if (!normalized) return;
            if (state.regions.has(normalized)) {
                state.regions.delete(normalized);
            } else {
                state.regions.add(normalized);
            }
            syncAll();
        }

        chips.forEach((chip) => {
            chip.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                toggleRegion(chip.dataset.region);
            });
            chip.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    toggleRegion(chip.dataset.region);
                }
            });
        });

        yesRadio?.addEventListener('change', () => {
            if (yesRadio.checked) {
                toggleInjuryFields(true);
            }
        });
        noRadio?.addEventListener('change', () => {
            if (noRadio.checked) {
                toggleInjuryFields(false);
            }
        });

        loadInitialState();
        syncAll();

        requestAnimationFrame(() => {
            const enabled = !!(yesRadio && yesRadio.checked);
            toggleInjuryFields(enabled);
        });
    }

    function bindImageClickEvents() {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImage');
        const overlay = document.getElementById('swipeOverlay');
        const closeIcon = document.getElementById('modalClose');
        if (!modal || !modalImg) return;

        let currentGroup = null;
        let currentIndex = 0;
        let groupImages = [];

        function showModal(src) {
            if (!src) return;
            modalImg.src = src;
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            if (overlay) overlay.style.opacity = groupImages.length > 1 ? '0.85' : '0';
        }

        function hideModal() {
            modal.style.display = 'none';
            modalImg.src = '';
            if (overlay) overlay.style.opacity = '0';
        }

        document.querySelectorAll('.clickable-img').forEach(img => {
            img.addEventListener('click', () => {
                const group = img.dataset.group;
                const index = Number(img.dataset.index || '0');
                groupImages = Array.from(document.querySelectorAll(`.clickable-img[data-group="${group}"]`));
                if (!groupImages.length) return;
                currentGroup = group;
                currentIndex = index % groupImages.length;
                showModal(groupImages[currentIndex].src || '');
            });
        });

        modal.addEventListener('click', (event) => {
            if (event.target.id === 'imageModal' || event.target.id === 'modalClose') {
                hideModal();
            }
        });
        closeIcon?.addEventListener('click', hideModal);
        modalImg.addEventListener('click', hideModal);

        modal.addEventListener('touchstart', (event) => {
            modal.dataset.touchStartX = event.changedTouches[0].screenX;
        });

        modal.addEventListener('touchend', (event) => {
            const startX = Number(modal.dataset.touchStartX || '0');
            const deltaX = event.changedTouches[0].screenX - startX;
            if (Math.abs(deltaX) < 50 || groupImages.length < 2) return;
            currentIndex = (currentIndex + (deltaX < 0 ? 1 : -1) + groupImages.length) % groupImages.length;
            const nextImg = groupImages[currentIndex];
            if (nextImg?.src) showModal(nextImg.src);
        });
    }

    function handleUpdatePrClick(event) {
        const target = event.target.closest('.update-pr-link');
        if (!target) return;
        event.preventDefault();
        currentWorkoutId = target.dataset.id;
        const categoryLabel = (target.dataset.category || '').toLowerCase();
        const isCardio = categoryLabel === 'cardio';
        const personalBest = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"]`);
        const weightSpan = personalBest?.querySelector('.max-pill-weight');
        const repsSpan = personalBest?.querySelector('.max-pill-reps');
        const weightText = weightSpan ? weightSpan.textContent.trim() : '';
        const repsText = repsSpan ? repsSpan.textContent.trim() : '';
        const isBodyweight = weightText.toLowerCase().includes('bodyweight');

        if (maxWeightInput) {
            maxWeightInput.disabled = isBodyweight || isCardio;
            if (maxWeightInput.disabled) {
                maxWeightInput.value = '';
                maxWeightInput.placeholder = isCardio ? 'Cardio' : 'Bodyweight';
            } else {
                const numericWeight = parseFloat(weightText.replace(/[^0-9.]+/g, ''));
                maxWeightInput.value = Number.isFinite(numericWeight) ? numericWeight : '';
                maxWeightInput.placeholder = 'Max Weight (lbs)';
            }
        }

        if (maxRepsInput) {
            const repsNumeric = parseInt(repsText.replace(/[^0-9]+/g, ''), 10);
            maxRepsInput.value = Number.isFinite(repsNumeric) ? repsNumeric : '';
            maxRepsInput.placeholder = isCardio ? 'Minutes' : 'Reps';
            maxRepsInput.dataset.isCardio = isCardio ? '1' : '0';
        }

        openModal(prModal);
    }

    function handleSavePr() {
        if (!currentWorkoutId) return;
        const payload = { workout_id: currentWorkoutId };
        if (maxWeightInput && !maxWeightInput.disabled && maxWeightInput.value !== '') {
            payload.max_weight = parseFloat(maxWeightInput.value);
        }
        if (maxRepsInput && maxRepsInput.value !== '') {
            payload.max_reps = parseInt(maxRepsInput.value, 10);
        }

        fetch(updatePrUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert(data.error || 'Unable to update max.');
                return;
            }
            const personalBest = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"]`);
            if (personalBest) {
                const weightSpan = personalBest.querySelector('.max-pill-weight');
                const repsSpan = personalBest.querySelector('.max-pill-reps');
                const summary = personalBest.querySelector('.personal-max-text');

                const isCardio = maxRepsInput?.dataset.isCardio === '1';
                const isBodyweight = maxWeightInput?.disabled;
                const returnedWeight = data.max_weight;
                const returnedReps = data.max_reps;

                if (weightSpan) {
                    if (isBodyweight) {
                        weightSpan.textContent = maxWeightInput?.placeholder || (isCardio ? 'Cardio' : 'Bodyweight');
                    } else if (returnedWeight !== null && returnedWeight !== undefined) {
                        weightSpan.textContent = `${parseFloat(returnedWeight).toFixed(1)} lbs`;
                    } else {
                        weightSpan.textContent = '—';
                    }
                }

                if (repsSpan) {
                    if (returnedReps !== null && returnedReps !== undefined) {
                        repsSpan.textContent = isCardio ? `${parseInt(returnedReps, 10)} min` : `${parseInt(returnedReps, 10)} reps`;
                    } else {
                        repsSpan.textContent = '—';
                    }
                }

                if (summary && weightSpan && repsSpan) {
                    summary.textContent = `Client Max: ${weightSpan.textContent} × ${repsSpan.textContent}`;
                }
            }
            closeModal(prModal);
            showToast('Personal record updated!');
        })
        .catch(() => alert('Unable to update max right now.'));
    }

    function handleNotesClick(event) {
        const target = event.target.closest('.edit-notes-btn');
        if (!target) return;
        event.preventDefault();
        currentWorkoutId = target.dataset.id;
        const existing = decodeURIComponent(target.dataset.notes || '');
        if (notesTextarea) {
            notesTextarea.value = existing;
        }
        openModal(notesModal);
    }

    function handleSaveNotes() {
        if (!currentWorkoutId) return;
        const notesValue = notesTextarea ? notesTextarea.value.trim() : '';
        fetch(updateNotesUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ workout_id: currentWorkoutId, notes: notesValue })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert(data.error || 'Unable to update notes.');
                return;
            }
            const notesBody = document.querySelector(`.notes-body[data-id="${currentWorkoutId}"]`);
            const triggers = document.querySelectorAll(`.edit-notes-btn[data-id="${currentWorkoutId}"]`);
            const displayHtml = notesValue ? escapeHtml(notesValue).replace(/\n/g, '<br>') : `<span class="text-muted">${escapeHtml(NOTES_PLACEHOLDER)}</span>`;
            if (notesBody) {
                notesBody.innerHTML = displayHtml;
            }
            triggers.forEach(btn => {
                btn.dataset.notes = encodeURIComponent(notesValue);
                btn.textContent = notesValue ? 'Edit Notes' : 'Add Notes';
            });
            closeModal(notesModal);
            showToast('Notes updated!');
        })
        .catch(() => alert('Unable to update notes right now.'));
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupTrainerInjuryForm();
        bindTrainerGoalLimit();
        bindImageClickEvents();
        initTrainerSettingsCollapsible();

        document.body.addEventListener('click', handleUpdatePrClick);
        document.body.addEventListener('click', handleNotesClick);

        const toggleDescription = (event) => {
            const target = event.target.closest('.toggle-description');
            if (!target) return;
            const descId = target.dataset.id;
            const descEl = document.getElementById(descId);
            if (!descEl) return;
            const isHidden = descEl.style.display === '' || descEl.style.display === 'none';
            if (isHidden) {
                descEl.style.display = 'block';
                descEl.style.maxHeight = '0px';
                descEl.style.overflow = 'hidden';
                descEl.style.transition = 'max-height 0.3s ease-out';
                requestAnimationFrame(() => {
                    descEl.style.maxHeight = descEl.scrollHeight + 'px';
                });
                target.textContent = 'Hide Description';
            } else {
                descEl.style.maxHeight = '0px';
                setTimeout(() => {
                    descEl.style.display = 'none';
                }, 300);
                target.textContent = 'View Description';
            }
        };

        document.body.addEventListener('click', toggleDescription);

        function initTrainerSettingsCollapsible() {
            const toggles = document.querySelectorAll('.collapsible-toggle');
            toggles.forEach((toggle) => {
                const targetId = toggle.dataset.target;
                if (!targetId) return;
                const content = document.getElementById(targetId);
                if (!content) return;

                toggle.addEventListener('click', () => {
                    const expanded = toggle.getAttribute('aria-expanded') === 'true';
                    if (expanded) {
                        collapseTrainerSection(content, toggle);
                    } else {
                        expandTrainerSection(content, toggle);
                    }
                });
            });
        }

        function expandTrainerSection(content, toggle) {
            content.hidden = false;
            content.style.maxHeight = 'none';
            const height = content.scrollHeight;
            content.style.maxHeight = '0px';
            content.offsetHeight;
            content.style.maxHeight = `${height}px`;
            toggle.setAttribute('aria-expanded', 'true');

            const onTransitionEnd = (event) => {
                if (event.propertyName !== 'max-height') return;
                content.style.maxHeight = 'none';
                content.removeEventListener('transitionend', onTransitionEnd);
            };
            content.addEventListener('transitionend', onTransitionEnd);
        }

        function collapseTrainerSection(content, toggle) {
            if (content.style.maxHeight === 'none') {
                content.style.maxHeight = `${content.scrollHeight}px`;
            }
            content.offsetHeight;
            content.style.maxHeight = '0px';
            toggle.setAttribute('aria-expanded', 'false');

            const onTransitionEnd = (event) => {
                if (event.propertyName !== 'max-height') return;
                content.hidden = true;
                content.removeEventListener('transitionend', onTransitionEnd);
            };
            content.addEventListener('transitionend', onTransitionEnd);
        }

        document.getElementById('submitPrBtn')?.addEventListener('click', handleSavePr);
        document.getElementById('closePrModal')?.addEventListener('click', () => closeModal(prModal));
        document.getElementById('prModalClose')?.addEventListener('click', () => closeModal(prModal));

        document.getElementById('saveNotesBtn')?.addEventListener('click', handleSaveNotes);
        document.getElementById('closeNotesModal')?.addEventListener('click', () => closeModal(notesModal));
        document.getElementById('notesModalClose')?.addEventListener('click', () => closeModal(notesModal));

        bindDurationPills();

        setTrainerSelection(getTrainerSelection());
        setTrainerHomeEquipmentSelection(getTrainerHomeEquipmentSelection());
        handleTrainerDurationChange(trainerActiveDuration);

        syncSelectStyle();
        syncGenerateButtonState();

        if (categorySelect) {
            categorySelect.addEventListener('change', () => {
                syncSelectStyle();
                syncGenerateButtonState();
                if (isTrainerCustomSelected() && !getTrainerSelection().length) {
                    openTrainerCustomModal();
                }
            });
        }

        if (trainerCustomButton) {
            trainerCustomButton.addEventListener('click', (event) => {
                event.preventDefault();
                openTrainerCustomModal();
            });
        }
        if (trainerCustomModalClose) {
            trainerCustomModalClose.addEventListener('click', () => closeTrainerCustomModal());
        }
        if (trainerCustomCancel) {
            trainerCustomCancel.addEventListener('click', (event) => {
                event.preventDefault();
                closeTrainerCustomModal();
            });
        }
        if (trainerCustomModal) {
            trainerCustomModal.addEventListener('click', (event) => {
                if (event.target === trainerCustomModal) {
                    closeTrainerCustomModal();
                }
            });
        }
        if (trainerCustomApply) {
            trainerCustomApply.addEventListener('click', () => {
                setTrainerSelection(Array.from(trainerDraftSelection));
                closeTrainerCustomModal();
            });
        }
        if (trainerCustomClear) {
            trainerCustomClear.addEventListener('click', (event) => {
                event.preventDefault();
                trainerDraftSelection = new Set();
                syncTrainerModalCheckboxes();
                updateTrainerModalStatus();
            });
        }
        trainerCustomCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
                const [, maxAllowed] = trainerSelectionBounds(getTrainerDuration());
                if (checkbox.checked) {
                    if (trainerDraftSelection.size >= maxAllowed) {
                        checkbox.checked = false;
                        flashTrainerModalWarning();
                        return;
                    }
                    trainerDraftSelection.add(checkbox.value);
                } else {
                    trainerDraftSelection.delete(checkbox.value);
                }
                updateTrainerModalStatus();
            });
        });

        if (trainerHomeEquipmentButton) {
            trainerHomeEquipmentButton.addEventListener('click', (event) => {
                event.preventDefault();
                if (trainerHomeEquipmentButton.disabled) return;
                openTrainerHomeEquipmentModal();
            });
        }
        if (trainerHomeEquipmentModalClose) {
            trainerHomeEquipmentModalClose.addEventListener('click', () => closeTrainerHomeEquipmentModal());
        }
        if (trainerHomeEquipmentCancel) {
            trainerHomeEquipmentCancel.addEventListener('click', (event) => {
                event.preventDefault();
                closeTrainerHomeEquipmentModal();
            });
        }
        if (trainerHomeEquipmentModal) {
            trainerHomeEquipmentModal.addEventListener('click', (event) => {
                if (event.target === trainerHomeEquipmentModal) {
                    closeTrainerHomeEquipmentModal();
                }
            });
        }
        if (trainerHomeEquipmentApply) {
            trainerHomeEquipmentApply.addEventListener('click', () => {
                setTrainerHomeEquipmentSelection(Array.from(trainerDraftHomeEquipmentSelection));
                closeTrainerHomeEquipmentModal();
            });
        }
        if (trainerHomeEquipmentClear) {
            trainerHomeEquipmentClear.addEventListener('click', (event) => {
                event.preventDefault();
                trainerDraftHomeEquipmentSelection = new Set();
                syncTrainerHomeEquipmentCheckboxes();
            });
        }
        trainerHomeEquipmentCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', () => {
                const token = (checkbox.value || '').toUpperCase();
                if (!token) return;
                if (checkbox.checked) {
                    trainerDraftHomeEquipmentSelection.add(token);
                } else {
                    trainerDraftHomeEquipmentSelection.delete(token);
                }
            });
        });

        if (generateWorkoutBtn) {
            generateWorkoutBtn.dataset.loading = generateWorkoutBtn.dataset.loading || 'false';
        }

        generateWorkoutForm?.addEventListener('submit', (event) => {
            if (!categorySelect?.value) {
                event.preventDefault();
                syncGenerateButtonState();
                return;
            }
            if (isTrainerCustomSelected() && !isTrainerSelectionValid()) {
                event.preventDefault();
                syncGenerateButtonState();
                alert(`Select categories within the allowed range for this ${getTrainerCustomLabel()}.`);
                return;
            }
            if (isTrainerHomeSelected() && !getTrainerHomeEquipmentSelection().length) {
                event.preventDefault();
                syncGenerateButtonState();
                alert('Select at least one piece of equipment for this Custom Home Workout.');
                return;
            }
            // Defer to avoid blocking native submit behaviour
            requestAnimationFrame(() => setGenerateButtonLoading(true));
        });

        const params = new URLSearchParams(window.location.search);
        if (params.get('focus') === 'active') {
            requestAnimationFrame(() => {
                const activeCard = document.getElementById('active-workout-card');
                if (!activeCard) return;
                activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                try {
                    activeCard.focus({ preventScroll: true });
                } catch (err) {
                    activeCard.focus();
                }
            });
            params.delete('focus');
            const query = params.toString();
            const newUrl = query ? `${window.location.pathname}?${query}${window.location.hash}` : `${window.location.pathname}${window.location.hash}`;
            history.replaceState({}, document.title, newUrl);
        }
    });
})();
</script>
{% endblock %}
