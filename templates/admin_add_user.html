{% extends "layout.html" %}

{% block title %}
Add New User
{% endblock %}

{% block content %}
<div class="experience-container experience-container--wide">
  <div class="surface-card">
    <div class="surface-hero surface-hero--dashboard text-center">
      <div class="d-flex flex-wrap justify-content-center gap-2 w-100 mb-3 surface-hero__actions">
        <a href="{{ url_for('admin_users') }}"
           class="btn btn-outline-secondary hero-action bg-white bg-opacity-10 text-white border-white">
          <i class="bi bi-arrow-left me-1"></i>Back to Users
        </a>
      </div>
      <div class="d-flex flex-column align-items-center gap-2 w-100">
        <div class="surface-hero__icon">
          <i class="bi bi-person-plus-fill"></i>
        </div>
        <h2 class="surface-hero__title mb-1">Add New User</h2>
        <p class="surface-hero__subtitle">
          Invite teammates, trainers, or members and share the onboarding link instantly.
        </p>
      </div>
    </div>

    <div class="surface-body surface-body--dense">
      {% if invite_url %}
        <div class="alert alert-info mb-0" role="alert">
          Invite link created:
          <input type="text" class="form-control mt-2" value="{{ invite_url }}" readonly onclick="this.select()">
          <div class="form-text">Share this link directly. It expires in {{ invite_expires_in or '48 hours' }}.</div>
        </div>
      {% endif %}

      <form method="POST"
            action="{{ url_for('admin_invite_user') }}"
            id="inviteForm"
            class="surface-section surface-section--flat">
        {# If you use CSRF: <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}

        <div class="surface-section__header">
          <div class="surface-section__icon">
            <i class="bi bi-envelope-paper"></i>
          </div>
          <div>
            <h5 class="surface-section__title mb-1">Invite Details</h5>
            <p class="surface-section__subtitle mb-0">
              Provide the basics so FitBaseAI can prep their welcome email.
            </p>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="name" class="form-label fw-semibold">First Name</label>
            <input type="text"
                   class="form-control"
                   id="name"
                   name="name"
                   value="{{ request.form.get('name','') }}"
                   placeholder="First Name">
          </div>

          <div class="col-md-6">
            <label for="last_name" class="form-label fw-semibold">Last Name</label>
            <input type="text"
                   class="form-control"
                   id="last_name"
                   name="last_name"
                   value="{{ request.form.get('last_name','') }}"
                   placeholder="Last Name">
          </div>

          <div class="col-md-6">
            <label for="email" class="form-label fw-semibold">Email <span class="text-danger">*</span></label>
            <input type="email"
                   class="form-control"
                   id="email"
                   name="email"
                   required
                   value="{{ request.form.get('email','') }}"
                   placeholder="name@example.com">
            <div class="form-text">We’ll send the invite to this address.</div>
          </div>

          <div class="col-md-6">
            <label for="role" class="form-label fw-semibold">Role</label>
            <select class="form-select" id="role" name="role">
              {% set role_val = request.form.get('role','user') %}
              <option value="user" {{ 'selected' if role_val == 'user' else '' }}>User</option>
              <option value="trainer" {{ 'selected' if role_val == 'trainer' else '' }}>Trainer</option>
              <option value="admin" {{ 'selected' if role_val == 'admin' else '' }}>Admin</option>
            </select>
          </div>

          <div class="col-md-6">
            <label for="subscription_type" class="form-label fw-semibold">Subscription</label>
            {% set sub_val = request.form.get('subscription_type','free') %}
            <select class="form-select" id="subscription_type" name="subscription_type">
              <option value="free" {{ 'selected' if sub_val == 'free' else '' }}>Free</option>
              <option value="premium" {{ 'selected' if sub_val == 'premium' else '' }}>Premium</option>
              <option value="pro" {{ 'selected' if sub_val == 'pro' else '' }}>Pro</option>
            </select>
          </div>

          <div class="col-12">
            <label for="admin_note" class="form-label fw-semibold">Optional note to include</label>
            <textarea class="form-control"
                      id="admin_note"
                      name="admin_note"
                      rows="3"
                      placeholder="E.g., Welcome! I set you up with a Trainer role so you can start building programs.">{{ request.form.get('admin_note','') }}</textarea>
          </div>
        </div>

        <input type="hidden" name="action" id="inviteAction" value="copy_link">

        <div class="surface-actions surface-actions--between surface-actions--stacked mt-4">
          <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">Back</a>
          <div class="surface-actions__button-group d-flex flex-wrap gap-2">
            <button type="submit" data-action="send_invite" class="btn btn-brand">
              Create &amp; Send Invite
            </button>
            <button type="submit" data-action="copy_link" class="btn btn-brand-outline">
              Create &amp; Copy Invite Link
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('inviteForm');
    const actionField = document.getElementById('inviteAction');

    form.addEventListener('submit', (e) => {
      if (!form.checkValidity()) return;

      if (e.submitter && e.submitter.dataset.action) {
        actionField.value = e.submitter.dataset.action;
      }

      setTimeout(() => {
        e.submitter.innerText = 'Working…';
        e.submitter.disabled = true;
      }, 0);

      const buttons = form.querySelectorAll('button[type="submit"]');
      buttons.forEach((b) => {
        if (b !== e.submitter) {
          b.disabled = true;
          b.innerText = 'Working…';
        }
      });
    });
  });
</script>
{% endblock %}
