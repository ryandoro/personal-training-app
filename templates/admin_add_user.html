{% extends "layout.html" %}

{% block title %}
Add New User
{% endblock %}

{% block content %}
<div class="container">
  <div class="card w-100 shadow-sm p-4 border border-2 rounded-3 mt-4 mb-4" style="border-color: #ced4da;">
    <div class="card-body">
      <h2 class="text-center text-white mb-4" style="background-color: #1EA4E6;">Add New User</h2>

      <form method="POST" action="{{ url_for('admin_invite_user') }}" id="inviteForm">
        {# If you use CSRF: <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"> #}

        <div class="row g-3">
          <!-- First Name -->
          <div class="col-md-6">
            <label for="name" class="form-label">First Name</label>
            <input type="text" class="form-control" id="name" name="name"
                   value="{{ request.form.get('name','') }}">
          </div>

          <!-- Last Name -->
          <div class="col-md-6">
            <label for="last_name" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="last_name" name="last_name"
                   value="{{ request.form.get('last_name','') }}">
          </div>

          <!-- Email (required) -->
          <div class="col-md-6">
            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
            <input type="email" class="form-control" id="email" name="email" required
                   value="{{ request.form.get('email','') }}"
                   placeholder="name@example.com">
            <div class="form-text">We’ll send the invite to this address.</div>
          </div>

          <!-- Role -->
          <div class="col-md-6">
            <label for="role" class="form-label">Role</label>
            <select class="form-select" id="role" name="role">
              {% set role_val = request.form.get('role','user') %}
              <option value="user" {{ 'selected' if role_val == 'user' else '' }}>User</option>
              <option value="trainer" {{ 'selected' if role_val == 'trainer' else '' }}>Trainer</option>
              <option value="admin" {{ 'selected' if role_val == 'admin' else '' }}>Admin</option>
            </select>
          </div>

          <!-- Subscription -->
          <div class="col-md-6">
            <label for="subscription_type" class="form-label">Subscription</label>
            {% set sub_val = request.form.get('subscription_type','free') %}
            <select class="form-select" id="subscription_type" name="subscription_type">
              <option value="free" {{ 'selected' if sub_val == 'free' else '' }}>Free</option>
              <option value="premium" {{ 'selected' if sub_val == 'premium' else '' }}>Premium</option>
              <option value="pro" {{ 'selected' if sub_val == 'pro' else '' }}>Pro</option>
            </select>
          </div>

          <!-- Optional note to user (goes in invite email) -->
          <div class="col-12">
            <label for="admin_note" class="form-label">Note to include in invite (optional)</label>
            <textarea class="form-control" id="admin_note" name="admin_note" rows="2"
                      placeholder="E.g., Welcome! I set you up with a Trainer role so you can start building programs.">{{ request.form.get('admin_note','') }}</textarea>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 justify-content-between mt-4">
          <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">Back</a>

          <div class="d-flex flex-wrap gap-2">
            <!-- Create user and send the invite email immediately -->
            <button type="submit" name="action" value="send_invite" class="btn btn-primary">
              Create &amp; Send Invite
            </button>

            <!-- Create user and return an invite URL (no email sent) -->
            <button type="submit" name="action" value="copy_link" class="btn btn-outline-primary">
              Create &amp; Copy Invite Link
            </button>
          </div>
        </div>
      </form>

      {% if invite_url %}
      <div class="alert alert-info mt-3" role="alert">
        Invite link created:
        <input type="text" class="form-control mt-2" value="{{ invite_url }}" readonly onclick="this.select()">
        <div class="form-text">Share this link directly. It expires in {{ invite_expires_in or '48 hours' }}.</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Prevent double submit & add a tiny UX polish.
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('inviteForm');
    form.addEventListener('submit', (e) => {
      if (!form.checkValidity()) return;
      const buttons = form.querySelectorAll('button[type="submit"]');
      buttons.forEach(b => { b.disabled = true; b.innerText = 'Working…'; });
    });
  });
</script>
{% endblock %}
