{% extends "layout.html" %}

{% block title %}
Account Settings
{% endblock %}

{% block content %}
<div class="page-hero page-hero--scroll">
    <div class="page-card page-card--wide page-card--flush" style="background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
        <div class="page-section text-center">
            <h2 class="fw-semibold mb-0">Account Settings</h2>
        </div>

        <form method="post">
            {% if form_completed %}
                <!-- Account Info -->
                <h5 class="mt-4 text-primary">Account Info</h5>
                {% for field in ['username', 'name', 'last_name', 'email'] %}
                <div class="mb-3">
                    <label class="form-label fw-bold">{{ field.replace('_', ' ').title() }}</label>
                    <input type="text" class="form-control" name="{{ field }}" value="{{ user.get(field, '') }}">
                </div>
                {% endfor %}

                <!-- Manage Stripe Subscription -->
                {% if user.subscription_type == 'premium' and (not user.trial_end_date or user.trial_end_date < current_date) %}
                    <!-- Active Premium User (not in trial) -->
                    <div class="text-center mt-4">
                        <a href="{{ url_for('customer_portal') }}" class="btn btn-brand">
                            Manage Subscription
                        </a>
                        <small class="d-block text-muted mt-2">Update your subscription anytime</small>
                    </div>
                {% else %}
                    <!-- Free or Trial user -->
                    <div class="text-center mt-4">
                        <a href="{{ url_for('upgrade') }}" class="btn btn-brand">
                            Upgrade to Premium
                        </a>
                        <small class="d-block text-muted mt-2">Unlock full access to your personalized training experience</small>
                    </div>
                {% endif %}            

                <!-- Training Info -->
                <h5 class="mt-4 text-primary">Personal & Training Info</h5>

                <!-- Age -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Age</label>
                    <input type="number" class="form-control" name="age" step="1" inputmode="numeric" value="{{ user.get('age', '') }}">
                </div>

                <!-- Weight -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Weight (Pounds)</label>
                    <input type="number" class="form-control" name="weight" step="0.1" min="0" max="999.9" inputmode="decimal" value="{{ user.get('weight', '') }}">
                </div>

                <!-- Height -->
                <div class="mb-3 row">
                    <label class="form-label fw-bold">Height</label>
                    <div class="col">
                        <input type="number" class="form-control" name="height_feet" placeholder="Feet" step="1" min="0" inputmode="numeric" value="{{ user.get('height_feet', '') }}">
                    </div>
                    <div class="col">
                        <input type="number" class="form-control" name="height_inches" placeholder="Inches" value="{{ user.get('height_inches', '') }}" min="0" max="11" step="1" inputmode="numeric">
                    </div>
                </div>

                <!-- Gender -->
                <div class="mb-3">
                    <label class="form-label fw-bold d-block">Gender</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="gender-male" value="Male" {% if user.get('gender') == 'Male' %}checked{% endif %}>
                        <label class="form-check-label" for="gender-male">Male</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="gender" id="gender-female" value="Female" {% if user.get('gender') == 'Female' %}checked{% endif %}>
                        <label class="form-check-label" for="gender-female">Female</label>
                    </div>
                </div>

                <!-- Exercise History -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Exercise History</label>
                    <select class="form-select" name="exercise_history">
                        <option value="" disabled>Select an option</option>
                        {% for option in ['No Exercise History', 'Exercise less than 1 year', 'Exercise 1-5 years', 'Exercise 5+ years'] %}
                            <option value="{{ option }}" {% if user.get('exercise_history') == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Fitness Goals -->
                <div class="mb-3">
                    <label class="form-label fw-bold d-block">Fitness Goals <small>(Select up to 2)</small></label>
                    <small class="text-muted d-block mb-2">
                        We recommend selecting 1 or 2 goals to help keep your training focused and effective.
                    </small>
                    <div id="fitness-goals-group">
                        {% set goals_list = user.get('fitness_goals', '').split(',') | map('trim') | list %}
                        {% for goal in ['Lose Weight', 'Gain Muscle', 'Tone Muscle', 'Abs', 'Increase Strength', 'Increase Endurance', 'Feel Better'] %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="{{ goal | lower | replace(' ', '-') }}" name="fitness_goals" value="{{ goal }}"
                                {% if goal in goals_list %}checked{% endif %}>
                            <label class="form-check-label" for="{{ goal | lower | replace(' ', '-') }}">{{ goal }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="text-danger small mt-1" id="goal-warning" style="display: none;"></div>
                </div>

                {% set injury_status_value = injury_status or 'No' %}
                {% set injury_regions_json = (injury_regions | default([], true)) | tojson %}
                {% set cardio_checked = cardio_restriction %}
                {% set chip_region_slugs = ['neck','shoulders','upper_back','lower_back','elbows','wrists','hips','knees','ankles','cardio'] %}

                <!-- Injury or Restriction Intake -->
                <div class="mb-4">
                    <p class="form-label fw-bold d-block mb-1">
                        Do you currently have any injuries or medical restrictions that require you to avoid exercising certain areas of your body?
                    </p>
                    <p class="form-text text-muted">Selecting "Yes" means FitBaseAI will skip exercises involving those areas.</p>

                    <div class="d-flex flex-wrap justify-content-center gap-4 injury-radio-group">
                        <div class="form-check">
                            <input type="radio"
                                   class="form-check-input"
                                   id="injury-status-yes"
                                   name="injury_status"
                                   value="Yes"
                                   {% if injury_status_value == 'Yes' %}checked{% endif %}>
                            <label class="form-check-label" for="injury-status-yes">Yes</label>
                        </div>
                        <div class="form-check">
                            <input type="radio"
                                   class="form-check-input"
                                   id="injury-status-no"
                                   name="injury_status"
                                   value="No"
                                   {% if injury_status_value != 'Yes' %}checked{% endif %}>
                            <label class="form-check-label" for="injury-status-no">No</label>
                        </div>
                    </div>

                    <div id="injury-fields-wrapper"
                         class="injury-fields-wrapper {% if injury_status_value == 'Yes' %}expanded{% else %}collapsed{% endif %}">

                        <div id="injury-fields" class="injury-fields mt-3 text-center"
                             data-initial-regions='{{ injury_regions_json | e }}'
                             data-cardio-prefill="{{ 'true' if cardio_checked else 'false' }}">

                            <p class="text-muted small mb-2">
                                Tap the buttons below to mark areas FitBaseAI should skip.
                            </p>

                            <div class="injury-chip-cloud mb-3">
                                {% for slug in chip_region_slugs %}
                                    {% set label = slug.replace('_', ' ')|title %}
                                    <button type="button"
                                            class="injury-chip"
                                            data-region="{{ slug }}"
                                            {% if slug in injury_regions %}data-active="true" aria-pressed="true"{% else %}data-active="false" aria-pressed="false"{% endif %}>
                                        {{ label }}
                                    </button>
                                {% endfor %}
                            </div>

                            <input type="hidden" id="cardio-restriction" name="cardio_restriction" value="{% if cardio_checked %}yes{% endif %}">

                            <div class="mt-3">
                                <label for="injury-details" class="form-label fw-bold">Additional details</label>
                                <textarea class="form-control"
                                          id="injury-details"
                                          name="injury_details"
                                          rows="3"
                                          placeholder="Share notes about the injury"
                                          required>{{ injury_details }}</textarea>
                            </div>

                            <div class="mt-3">
                                <span class="small text-muted d-block">Selected areas:</span>
                                <div id="injury-selected" class="injury-selected-pills mt-2"></div>
                            </div>

                            <input type="hidden" id="injury-input" name="injury" value='{{ injury_regions_json | e }}'>
                        </div>
                    </div>
                </div>

                {% set skip_namespace = namespace(items=[]) %}
                {% if injury_excluded_categories %}
                    {% for token in injury_excluded_categories %}
                        {% if token not in skip_namespace.items %}
                            {% set _ = skip_namespace.items.append(token) %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if injury_skipped_subcategories %}
                    {% for token in injury_skipped_subcategories %}
                        {% if token not in skip_namespace.items %}
                            {% set _ = skip_namespace.items.append(token) %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                <div id="injury-alert-banner"
                     class="alert alert-success mt-2 {% if not skip_namespace.items %}d-none{% endif %}"
                     role="status"
                     data-default-categories='{{ (injury_excluded_categories | default([], true)) | tojson }}'
                     data-default-subcategories='{{ (injury_skipped_subcategories | default([], true)) | tojson }}'
                     data-default-cardio="{{ 'true' if cardio_restriction else 'false' }}">
                    <strong>Workout adjustments applied:</strong>
                    <span id="injury-alert-message">
                        {% if skip_namespace.items %}
                            Skipping {{ skip_namespace.items | join(', ') }} exercises based on your restrictions.
                        {% else %}
                            Your next workouts will consider any restrictions you add here.
                        {% endif %}
                    </span>
                </div>

                <!-- Preferred Workout Duration -->
                <div class="mb-3">
                    <label class="form-label fw-bold">What is your preferred workout duration?</label>
                    {% set wd = (user.get('workout_duration') | string) if user.get('workout_duration') is not none else '' %}
                    <select class="form-select" name="workout_duration" required>
                    <option value="" disabled {% if not wd %}selected{% endif %}>Select an option</option>
                    <option value="20" {% if wd == '20' %}selected{% endif %}>20 minutes</option>
                    <option value="30" {% if wd == '30' %}selected{% endif %}>30 minutes</option>
                    <option value="45" {% if wd == '45' %}selected{% endif %}>45 minutes</option>
                    <option value="60" {% if wd == '60' %}selected{% endif %}>60 minutes</option>
                    </select>
                </div>
  
                <!-- Commitment -->
                <div class="mb-3">
                    <label class="form-label fw-bold">How many days per week are you willing to commit to your goals?</label>
                    <select class="form-select" name="commitment">
                        <option value="" disabled>Select an option</option>
                        {% for option in ['1 day per week', '2 days per week', '3 days per week'] %}
                            <option value="{{ option }}" {% if user.get('commitment') == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Additional Notes -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Anything else you'd like to share?</label>
                    <textarea class="form-control" name="additional_notes" rows="3">{{ user.get('additional_notes', '') }}</textarea>
                </div>
            {% else %}
                <div class="alert alert-info">
                    To personalize your experience, please complete the <a href="{{ url_for('training') }}" class="alert-link">Personal Training Questionnaire</a> first.
                </div>
            {% endif %}

            <!-- Password Update -->
            <h5 class="mt-4 text-primary">Change Password (Optional)</h5>
            <div class="mb-3">
                <label class="form-label fw-bold">New Password</label>
                <input type="password" class="form-control" name="password" autocomplete="new-password">
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Confirm New Password</label>
                <input type="password" class="form-control" name="confirm_password" autocomplete="new-password">
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-brand w-100">Save Changes</button>
        </form>
    </div>
</div>

<script>
    function safeParseJSON(value, fallback) {
        if (!value) return Array.isArray(fallback) ? fallback : [];
        try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) return parsed;
            if (parsed && typeof parsed === 'object') return Object.values(parsed);
            return Array.isArray(fallback) ? fallback : [];
        } catch {
            return Array.isArray(fallback) ? fallback : [];
        }
    }

    function normalizeRegionSlug(value) {
        return String(value || '')
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '');
    }

    function updateInjuryAlertBanner(skipped) {
        const banner = document.getElementById('injury-alert-banner');
        const message = document.getElementById('injury-alert-message');
        if (!banner || !message) return;

        const tokens = new Set();
        let cardioLimited = false;

        if (skipped && typeof skipped === 'object') {
            (skipped.categories || []).forEach((token) => tokens.add(String(token).toUpperCase()));
            (skipped.subcategories || []).forEach((token) => tokens.add(String(token).toUpperCase()));
            if (skipped.cardio_restriction) cardioLimited = true;
        }

        if (cardioLimited) tokens.add('CARDIO');

        if (!tokens.size) {
            banner.classList.add('d-none');
            message.textContent = 'Your next workouts will consider any restrictions you add here.';
            return;
        }

        const pretty = Array.from(tokens)
            .map((token) => token.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()))
            .join(', ');
        message.textContent = `Skipping ${pretty} exercises based on your restrictions.`;
        banner.classList.remove('d-none');
    }

    function hydrateDefaultInjuryAlert() {
        const banner = document.getElementById('injury-alert-banner');
        if (!banner) return;

        const defaults = {
            categories: safeParseJSON(banner.dataset.defaultCategories, []),
            subcategories: safeParseJSON(banner.dataset.defaultSubcategories, []),
            cardio_restriction: banner.dataset.defaultCardio === 'true',
        };

        updateInjuryAlertBanner(defaults);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Password toggles
        const passwordFields = document.querySelectorAll('input[type="password"]');
        passwordFields.forEach(field => {
            const toggle = document.createElement('small');
            toggle.textContent = "Show";
            toggle.style.cursor = "pointer";
            toggle.style.marginLeft = "10px";
            toggle.style.userSelect = "none";
            toggle.classList.add("text-primary");

            field.parentElement.appendChild(toggle);
            toggle.addEventListener('click', () => {
                field.type = field.type === "password" ? "text" : "password";
                toggle.textContent = field.type === "password" ? "Show" : "Hide";
            });
        });

        // Fitness goal checkbox validation
        const goalCheckboxes = document.querySelectorAll('.goal-checkbox');
        const goalWarning = document.getElementById('goal-warning');
        const form = document.querySelector('form');

        // Limit checkbox selection to 2
        goalCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const checked = Array.from(goalCheckboxes).filter(c => c.checked);

                if (checked.length > 2) {
                    cb.checked = false;
                    goalWarning.style.display = 'block';
                    goalWarning.textContent = "You can only select up to 2 fitness goals.";
                } else {
                    goalWarning.style.display = 'none';
                }
            });
        });

        // Prevent form submission if fewer than 1 goal is selected
        form.addEventListener('submit', function (e) {
            const checked = Array.from(goalCheckboxes).filter(cb => cb.checked);

            if (checked.length === 0) {
                e.preventDefault();
                goalWarning.style.display = 'block';
                goalWarning.textContent = "Please select at least 1 fitness goal.";
                window.scrollTo({ top: goalWarning.offsetTop - 100, behavior: 'smooth' });
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const fields = document.getElementById('injury-fields');
        if (!fields) {
            hydrateDefaultInjuryAlert();
            return;
        }

        const yesRadio = document.getElementById('injury-status-yes');
        const noRadio = document.getElementById('injury-status-no');
        const chips = Array.from(fields.querySelectorAll('.injury-chip'));
        const injuryInput = document.getElementById('injury-input');
        const cardioInput = document.getElementById('cardio-restriction');
        const selectedContainer = document.getElementById('injury-selected');
        const textarea = document.getElementById('injury-details');

        const labels = new Map();
        chips.forEach((chip) => labels.set(chip.dataset.region, chip.textContent.trim()));
        const state = { regions: new Set() };

        function loadInitialState() {
            const initialRegions = safeParseJSON(fields.dataset.initialRegions, []);
            initialRegions.forEach((region) => {
                const slug = normalizeRegionSlug(region);
                if (slug) state.regions.add(slug);
            });
            if (fields.dataset.cardioPrefill === 'true') state.regions.add('cardio');
        }

        function syncHiddenFields() {
            injuryInput.value = JSON.stringify(Array.from(state.regions));
            const restrictCardio = state.regions.has('cardio');
            cardioInput.value = restrictCardio ? 'yes' : '';
            cardioInput.disabled = false;
        }

        function syncChips() {
            chips.forEach((chip) => {
                const slug = chip.dataset.region;
                const active = state.regions.has(slug);
                chip.classList.toggle('active', active);
                chip.dataset.active = active ? 'true' : 'false';
                chip.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
        }

        function prettyLabel(slug) {
            return labels.get(slug) || slug.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function syncSelectedList() {
            selectedContainer.innerHTML = '';
            if (!state.regions.size) {
                selectedContainer.innerHTML =
                    '<span class="badge bg-secondary-subtle text-muted">No areas selected</span>';
                return;
            }
            state.regions.forEach((slug) => {
                const pill = document.createElement('span');
                pill.className = 'badge injury-pill bg-bitcoin text-dark me-1 mb-1';
                pill.textContent = prettyLabel(slug);
                selectedContainer.appendChild(pill);
            });
        }

        function syncAll() {
            syncHiddenFields();
            syncChips();
            syncSelectedList();
        }

        function clearInjurySection() {
            state.regions.clear();
            syncAll();
            textarea.value = '';
        }

        function toggleInjuryFields(enabled) {
            const wrapper = document.getElementById('injury-fields-wrapper');

            if (wrapper) {
                wrapper.classList.toggle('expanded', enabled);
                wrapper.classList.toggle('collapsed', !enabled);
            }

            fields.classList.toggle('is-disabled', !enabled);

            setTimeout(() => {
                chips.forEach((chip) => (chip.disabled = !enabled));
                textarea.disabled = !enabled;
            }, 200);

            if (!enabled) clearInjurySection();
        }

        function toggleRegion(slug) {
            const normalized = normalizeRegionSlug(slug);
            if (!normalized) return;
            if (state.regions.has(normalized)) state.regions.delete(normalized);
            else state.regions.add(normalized);
            syncAll();
        }

        chips.forEach((chip) => {
            chip.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleRegion(chip.dataset.region);
            });
            chip.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleRegion(chip.dataset.region);
                }
            });
        });

        yesRadio.addEventListener('change', () => yesRadio.checked && toggleInjuryFields(true));
        noRadio.addEventListener('change', () => noRadio.checked && toggleInjuryFields(false));

        loadInitialState();
        syncAll();

        requestAnimationFrame(() => {
            toggleInjuryFields(!!(yesRadio && yesRadio.checked));
        });

        hydrateDefaultInjuryAlert();
    });
</script>
{% endblock %}
