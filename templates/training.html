{% extends "layout.html" %}

{% block title %}
    Personal Training
{% endblock %}

{% block content %}
<div class="container-fluid training-container px-0">
    {% if not form_completed %}   
        <div class="card shadow p-4 mb-5 rounded">
            <div class="card-body">
                <h3 class="card-title text-center fw-bold mb-4">Welcome to your personalized training journey!</h3>
            
                <p>
                    <strong>Thank you</strong> for trusting us to guide you toward becoming the strongest, healthiest version of yourself. There’s no one-size-fits-all approach to fitness, but we’ve built a simple, effective roadmap tailored to your goals.
                </p>
            
                <p>
                    These foundational exercises and instructions will help you <strong>move better, look better, and feel amazing.</strong> Your body is the only vehicle you’ve got — and we're going to take great care of it.
                </p>
            
                <p>
                    Be consistent, fuel your body right, and enjoy the process. Got questions? We're here for you.
                </p>
            
                <p>
                    <strong>Let’s get to work — your results start now!</strong>
                </p>

                <hr class="my-4">
            
                <h5 class="fw-semibold mb-3 text-center">How It Works</h5>
            
                <div class="row text-start">
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 1:</strong> Fill out your training questionnaire below so we can learn about your goals and fitness level.
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 2:</strong> Unlock your free 14-day Premium Trial and receive personalized workout plans built around your goals.
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 3:</strong> Track your progress on the homepage as you grow stronger and achieve your goals. Let's do this!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow p-4 rounded mb-5">
            <h4 class="text-center text-primary mb-4">Personal Training Questionnaire</h4>
            <div class="card-body">
                <form id="training-form" action="/training" method="post" class="needs-validation" novalidate>
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label fw-bold">First Name</label>
                        <input type="text"
                               class="form-control {{ 'is-invalid' if errors and errors.get('name') }}"
                               id="name" name="name"
                               placeholder="Enter your first name"
                               value="{{ (form_data.get('name') or '') if form_data is defined else '' }}"
                               autocomplete="given-name"
                               required>
                        <div class="invalid-feedback">
                            {{ errors.get('name') if errors and errors.get('name') else 'First name is required.' }}
                        </div>
                      </div>
                      
                    <!-- Last Name -->
                    <div class="mb-3">
                        <label for="last_name" class="form-label fw-bold">Last Name</label>
                        <input type="text"
                                class="form-control {{ 'is-invalid' if errors and errors.get('last_name') }}"
                                id="last_name" name="last_name"
                                placeholder="Enter your last name"
                                value="{{ (form_data.get('last_name') or '') if form_data is defined else '' }}"
                                autocomplete="family-name"
                                required>
                        <div class="invalid-feedback">
                            {{ errors.get('last_name') if errors and errors.get('last_name') else 'Last name is required.' }}
                        </div>
                    </div>

                    <!-- Age -->
                    <div class="mb-3">
                        <label for="age" class="form-label fw-bold">Age (Years)</label>
                        <input type="number"
                               class="form-control {{ 'is-invalid' if errors and errors.get('age') }}"
                               id="age" name="age" placeholder="Enter your age"
                               step="1" min="0" inputmode="numeric" required
                               value="{{ (form_data.get('age') or '') if form_data is defined else '' }}">
                        <div class="invalid-feedback">
                            {{ errors.get('age') if errors and errors.get('age') else 'Enter your age as a whole number (0 or more).' }}
                        </div>
                    </div>                      

                    <!-- Weight -->
                    <div class="mb-3">
                        <label for="weight" class="form-label fw-bold">Weight (Pounds)</label>
                        <input type="number"
                               class="form-control {{ 'is-invalid' if errors and errors.get('weight') }}"
                               id="weight" name="weight" placeholder="Enter your weight in pounds"
                               step="0.1" min="0" max="999.9" inputmode="decimal" required
                               value="{{ (form_data.get('weight') or '') if form_data is defined else '' }}">
                        <div class="invalid-feedback">
                            {{ errors.get('weight') if errors and errors.get('weight') else 'Enter a number between 0 and 999.9 (decimals allowed).' }}
                        </div>
                    </div>

                    <!-- Height -->
                    <div class="mb-3 row">
                        <p class="form-label fw-bold mb-2">Height</p>
                        <div class="col">
                          <input type="number"
                                 class="form-control {{ 'is-invalid' if errors and errors.get('height_feet') }}"
                                 id="height-feet" name="height_feet" placeholder="Feet"
                                 min="0" step="1" inputmode="numeric" required
                                 value="{{ (form_data.get('height_feet') or '') if form_data is defined else '' }}">
                          <div class="invalid-feedback">
                                {{ errors.get('height_feet') if errors and errors.get('height_feet') else 'Feet must be a whole number (0 or more).' }}
                          </div>
                        </div>
                        <div class="col">
                          <input type="number"
                                 class="form-control {{ 'is-invalid' if errors and errors.get('height_inches') }}"
                                 id="height-inches" name="height_inches" placeholder="Inches"
                                 min="0" max="11" step="1" inputmode="numeric" required
                                 value="{{ (form_data.get('height_inches') or '') if form_data is defined else '' }}">
                          <div class="invalid-feedback">
                                {{ errors.get('height_inches') if errors and errors.get('height_inches') else 'Inches must be a whole number from 0 to 11.' }}
                          </div>
                        </div>
                    </div>                      

                    <!-- Gender -->
                    <div class="mb-3">
                        <p class="form-label fw-bold d-block">Gender</p>
                        <div class="form-check form-check-inline">
                            <input type="radio"
                                class="form-check-input {{ 'is-invalid' if errors and errors.get('gender') }}"
                                id="male" name="gender" value="Male" required
                                {% if form_data is defined and form_data.get('gender') == 'Male' %}checked{% endif %}>
                            <label class="form-check-label" for="male">Male</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio"
                                class="form-check-input {{ 'is-invalid' if errors and errors.get('gender') }}"
                                id="female" name="gender" value="Female" required
                                {% if form_data is defined and form_data.get('gender') == 'Female' %}checked{% endif %}>
                            <label class="form-check-label" for="female">Female</label>
                        </div>
                        {% if errors and errors.get('gender') %}
                            <div class="invalid-feedback d-block">{{ errors.get('gender') }}</div>
                        {% endif %}
                    </div>

                    <!-- Exercise History -->
                    <div class="mb-3">
                        <label for="exercise-history" class="form-label fw-bold">Exercise History</label>
                        <select class="form-select {{ 'is-invalid' if errors and errors.get('exercise_history') }}"
                                id="exercise-history" name="exercise_history" required>
                            <option value="" disabled
                                {% if not (form_data is defined and form_data.get('exercise_history')) %}selected{% endif %}>
                                Select an option
                            </option>
                            {% set eh = form_data.get('exercise_history') if form_data is defined else '' %}
                            <option value="No Exercise History" {% if eh == 'No Exercise History' %}selected{% endif %}>No Exercise History</option>
                            <option value="Exercise less than 1 year" {% if eh == 'Exercise less than 1 year' %}selected{% endif %}>Exercise less than 1 year</option>
                            <option value="Exercise 1-5 years" {% if eh == 'Exercise 1-5 years' %}selected{% endif %}>Exercise 1-5 years</option>
                            <option value="Exercise 5+ years" {% if eh == 'Exercise 5+ years' %}selected{% endif %}>Exercise 5+ years</option>
                        </select>
                        <div class="invalid-feedback">
                            {{ errors.get('exercise_history') if errors and errors.get('exercise_history') else 'Please select your exercise history.' }}
                        </div>
                      </div>                      

                    <!-- Fitness Goals -->
                    <div class="mb-3">
                        <p class="form-label fw-bold d-block">Fitness Goals <small>(Select up to 2)</small></p>
                        <small class="text-muted d-block mb-2">
                            We recommend selecting 1 or 2 goals to help keep your training focused and effective.
                        </small>

                        <!-- Goal Checkboxes -->
                        {% set selected_goals = form_data.getlist('fitness_goals') if form_data is defined else [] %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="lose-weight" name="fitness_goals" value="Lose Weight"
                                    {% if 'Lose Weight' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="lose-weight">Lose Weight</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="gain-muscle" name="fitness_goals" value="Gain Muscle"
                                    {% if 'Gain Muscle' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="gain-muscle">Gain Muscle</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="tone-muscle" name="fitness_goals" value="Tone Muscle"
                                    {% if 'Tone Muscle' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="tone-muscle">Tone Muscle</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="abs" name="fitness_goals" value="Abs"
                                    {% if 'Abs' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="abs">Abs</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="strength" name="fitness_goals" value="Increase Strength"
                                    {% if 'Increase Strength' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="strength">Increase Strength</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="endurance" name="fitness_goals" value="Increase Endurance"
                                    {% if 'Increase Endurance' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="endurance">Increase Endurance</label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox {{ 'is-invalid' if errors and errors.get('fitness_goals') }}"
                                    id="feel-better" name="fitness_goals" value="Feel Better"
                                    {% if 'Feel Better' in selected_goals %}checked{% endif %}>
                            <label class="form-check-label" for="feel-better">Feel Better</label>
                        </div>

                        {% if errors and errors.get('fitness_goals') %}
                            <div class="invalid-feedback d-block">{{ errors.get('fitness_goals') }}</div>
                        {% endif %}
                    </div>

                    {% set injury_status_value = (form_data.get('injury_status') if form_data is defined else (injury_status or 'No')) %}
                    {% set injury_regions_json = (injury_regions | default([], true)) | tojson %}
                    {% if form_data is defined %}
                        {% set injury_regions_json = form_data.get('injury') or '[]' %}
                    {% endif %}
                    {% set cardio_checked = (form_data.get('cardio_restriction') == 'yes') if form_data is defined else (cardio_restriction or False) %}
                    {% set injury_details_value = (form_data.get('injury_details') if form_data is defined else (injury_details or '')) %}
                    {% set injury_error = errors.get('injury') if errors else None %}

                    <!-- Injury or Restriction Intake -->
                    <div class="mb-4">
                        <p class="form-label fw-bold d-block mb-1">
                            Do you currently have any injuries or medical restrictions that require you to avoid exercising certain areas of your body?
                        </p>
                        <p class="form-text text-muted">Selecting "Yes" means FitBaseAI will skip exercises involving those areas.</p>

                        <div class="d-flex flex-wrap justify-content-center gap-4 injury-radio-group">
                            <div class="form-check">
                                <input type="radio"
                                    class="form-check-input {{ 'is-invalid' if errors and errors.get('injury_status') or injury_error }}"
                                    id="injury-status-yes" name="injury_status" value="Yes" required
                                    {% if injury_status_value == 'Yes' %}checked{% endif %}>
                                <label class="form-check-label" for="injury-status-yes">Yes</label>
                            </div>
                            <div class="form-check">
                                <input type="radio"
                                    class="form-check-input {{ 'is-invalid' if errors and errors.get('injury_status') or injury_error }}"
                                    id="injury-status-no" name="injury_status" value="No" required
                                    {% if injury_status_value != 'Yes' %}checked{% endif %}>
                                <label class="form-check-label" for="injury-status-no">No</label>
                            </div>
                        </div>

                        {% if errors and errors.get('injury_status') %}
                            <div class="invalid-feedback d-block">{{ errors.get('injury_status') }}</div>
                        {% endif %}

                        {% set chip_region_slugs = ['neck','shoulders','upper_back','lower_back','elbows','wrists','hips','knees','ankles','cardio'] %}
                        <div id="injury-fields-wrapper"
                            class="injury-fields-wrapper {% if injury_status_value == 'Yes' %}expanded{% else %}collapsed{% endif %}">
                    
                            <div id="injury-fields" class="injury-fields mt-3 text-center"
                                data-initial-regions='{{ injury_regions_json | e }}'
                                data-cardio-prefill="{{ 'true' if cardio_checked else 'false' }}">

                                <p class="text-muted small mb-2">
                                    Tap the buttons below to mark areas FitBaseAI should skip.
                                </p>
                        
                                <div class="injury-chip-cloud mb-3 {% if injury_error %}error{% endif %}">
                                    {% for slug in chip_region_slugs %}
                                        {% set label = slug.replace('_', ' ')|title %}
                                        <button type="button"
                                                class="injury-chip"
                                                data-region="{{ slug }}"
                                                {% if slug in injury_regions %}data-active="true" aria-pressed="true"{% else %}data-active="false" aria-pressed="false"{% endif %}>
                                            {{ label }}
                                        </button>
                                    {% endfor %}
                                </div>
                                
                                {% if injury_error %}
                                    <div class="invalid-feedback d-block mb-3" style="display:block;">
                                        {{ injury_error }}
                                    </div>
                                {% endif %}

                                <input type="hidden" id="cardio-restriction" name="cardio_restriction" value="{% if cardio_checked %}yes{% endif %}">
                        
                                <div class="mt-3">
                                    <label for="injury-details" class="form-label fw-bold">Additional details</label>
                                    <textarea class="form-control {{ 'is-invalid' if errors and errors.get('injury_details') }}"
                                                id="injury-details" name="injury_details" rows="3"
                                                placeholder="Share notes about the injury"
                                                required>{{ injury_details_value }}</textarea>
                                    {% if errors and errors.get('injury_details') %}
                                        <div class="invalid-feedback">{{ errors.get('injury_details') }}</div>
                                    {% endif %}
                                </div>
                        
                                <div class="mt-3">
                                    <span class="small text-muted d-block">Selected areas:</span>
                                    <div id="injury-selected" class="injury-selected-pills mt-2"></div>
                                </div>
                        
                                <input type="hidden" id="injury-input" name="injury" value='{{ injury_regions_json | e }}'>
                            </div>
                        </div>
                   </div>                   

                    <!-- Preferred Workout Duration -->
                    <div class="mb-3">
                        <label for="workout_duration" class="form-label fw-bold">
                        What is your preferred workout duration?
                        </label>
                        <select class="form-select {{ 'is-invalid' if errors and errors.get('workout_duration') }}"
                                id="workout_duration" name="workout_duration" required>
                        {% set wd = (form_data.get('workout_duration') if form_data is defined else '') %}
                        <option value="" disabled {% if not wd %}selected{% endif %}>Select an option</option>
                        <option value="20" {% if wd == '20' %}selected{% endif %}>20 minutes</option>
                        <option value="30" {% if wd == '30' %}selected{% endif %}>30 minutes</option>
                        <option value="45" {% if wd == '45' %}selected{% endif %}>45 minutes</option>
                        <option value="60" {% if wd == '60' %}selected{% endif %}>60 minutes</option>
                        </select>
                        <div class="invalid-feedback">
                        {{ errors.get('workout_duration') if errors and errors.get('workout_duration') else 'Please choose your preferred workout length.' }}
                        </div>
                    </div>
  
                    <!-- Commitment -->
                    <div class="mb-3">
                        <label for="commitment" class="form-label fw-bold">How many days per week are you willing to commit to your goals?</label>
                        <select class="form-select {{ 'is-invalid' if errors and errors.get('commitment') }}"
                                id="commitment" name="commitment" required>
                            {% set cmt = form_data.get('commitment') if form_data is defined else '' %}
                            <option value="" disabled {% if not cmt %}selected{% endif %}>Select an option</option>
                            <option value="1 day per week" {% if cmt == '1 day per week' %}selected{% endif %}>1 day per week</option>
                            <option value="2 days per week" {% if cmt == '2 days per week' %}selected{% endif %}>2 days per week</option>
                            <option value="3 days per week" {% if cmt == '3 days per week' %}selected{% endif %}>3 days per week</option>
                        </select>
                        <div class="invalid-feedback">
                            {{ errors.get('commitment') if errors and errors.get('commitment') else 'Please select your weekly commitment.' }}
                        </div>
                    </div>                      

                    <!-- Additional Notes -->
                    <div class="mb-3">
                        <label for="additional-notes" class="form-label fw-bold">Anything else you'd like to share?</label>
                        <textarea class="form-control" id="additional-notes" name="additional_notes" rows="3">{{ (form_data.get('additional_notes') or '') if form_data is defined else '' }}</textarea>
                    </div>                      

                    <!-- Liability Waiver + Privacy Policy Agreement -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" 
                            class="form-check-input {{ 'is-invalid' if errors and errors.get('waiver') }}"
                            id="waiver" 
                            name="waiver" 
                            required>
                        <label class="form-check-label" for="waiver">
                            I acknowledge that I have read and agree to the
                            <a href="/terms" target="_blank">Terms of Service and Liability Waiver</a> 
                            and the 
                            <a href="/privacy" target="_blank">Privacy Policy</a>.
                        </label>
                        {% if errors and errors.get('waiver') %}
                            <div class="invalid-feedback d-block">{{ errors.get('waiver') }}</div>
                        {% endif %}
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100 mb-2">Submit</button>


                    <small class="text-muted d-block mb-2">
                        <i class="bi bi-info-circle"></i>
                        By clicking Submit, your <strong>free 14-day Premium Trial</strong> will begin. You'll get full access to the <strong>personalized workout generator</strong> and <strong>progress tracking</strong>—upgrade anytime during your trial to keep it.
                    </small>
                </form>
            </div>        
    {% else %} 

     
        <!-- Show guidelines and workout options after the form is submitted -->
        {% if guidelines %}
        <div class="card w-100 mx-auto shadow-sm rounded-4 mb-3 collapsible-card modern-collapsible">
            <button type="button" class="collapsible-toggle" data-target="guidelines-content" aria-expanded="false">
                <span class="collapsible-title">Guidelines</span>
                <i class="bi bi-chevron-down collapsible-chevron" aria-hidden="true"></i>
            </button>
            <div id="guidelines-content" class="collapsible-content" hidden>
                <div class="card-body">
                    {% set goal_list = fitness_goals.split(',') %}
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        <span class="meta-pill">
                            <i class="bi bi-bullseye"></i>
                            Goals:
                            <strong>
                                {% for goal in goal_list %}
                                    {{ goal.strip() }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </strong>
                        </span>
                        <span class="meta-pill meta-pill--subtle">
                            <i class="bi bi-stars"></i>
                            Personalized targets based on your inputs
                        </span>
                    </div>
                    <p class="text-muted small mb-3">
                        Use these ranges as your anchor for each exercise. Adjust within them based on how you feel day to day.
                    </p>

                    <div class="info-grid mb-4">
                        <div class="info-tile">
                            <div class="info-tile__label">Sets</div>
                            <div class="info-tile__value">{{ guidelines.Sets }}</div>
                            <div class="info-tile__meta">Per exercise</div>
                        </div>
                        <div class="info-tile">
                            <div class="info-tile__label">Repetitions</div>
                            <div class="info-tile__value">{{ guidelines.Reps }}</div>
                            <div class="info-tile__meta">Work the higher end when you feel strong</div>
                        </div>
                        <div class="info-tile">
                            <div class="info-tile__label">Rest Between Sets</div>
                            <div class="info-tile__value">{{ guidelines.Rest }}</div>
                            <div class="info-tile__meta">Shorter rest = more intensity</div>
                        </div>
                    </div>

                    <details class="modern-details mb-3">
                        <summary>
                            <i class="bi bi-lightbulb"></i>
                            Pro Tip
                        </summary>
                        <div class="modern-details__body">
                            To get the best results, aim for the lower end of the rest range and the higher end of the sets and 
                            repetitions <strong>when you're feeling strong and well-recovered</strong>. Your effort should feel like an 
                            <strong>8 out of 10</strong> — challenging, but doable with good form. If things start to feel too easy within the guidelines,
                            increase the weight or difficulty of the exercise, or shift to a different part of the rep range or time target than you used last time. 
                            That’s where real results are made: consistent, focused effort.
                        </div>
                    </details>

                    <ul class="bullet-list">
                        <li>
                            <div class="bullet-icon">
                                <i class="bi bi-bar-chart-line"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Resistance Training</div>
                                <div class="text-muted small mb-0">At least 2 non-consecutive days per week, targeting all major muscle groups.</div>
                            </div>
                        </li>
                        <li>
                            <div class="bullet-icon">
                                <i class="bi bi-activity"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Cardio Training</div>
                                <div class="text-muted small mb-0">Minimum 3 days per week. Start with 10 minutes per session and build up to 20–30 minutes as you progress.</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        {% if target_heart_rate_zone %}
        <div class="card w-100 mx-auto shadow-sm rounded-4 mb-3 collapsible-card modern-collapsible">
            <button type="button" class="collapsible-toggle" data-target="target-heart-rate-content" aria-expanded="false">
                <span class="collapsible-title">Your Target Heart Rate Zone</span>
                <i class="bi bi-chevron-down collapsible-chevron" aria-hidden="true"></i>
            </button>
            <div id="target-heart-rate-content" class="collapsible-content" hidden>
                <div class="card-body">
                    <p class="card-text">
                        Based on your age, here’s a smart range to train in to stay safe and get the most from your cardio:
                    </p>

                    <div class="metric-stack mb-3">
                        <div class="metric-chip metric-chip--accent">
                            <div class="metric-chip__icon">
                                <i class="bi bi-activity"></i>
                            </div>
                            <div>
                                <div class="metric-chip__label">Target Zone</div>
                                <div class="metric-chip__value">{{ target_heart_rate_zone.lower_bound }} - {{ target_heart_rate_zone.upper_bound }} bpm</div>
                                <div class="metric-chip__hint">Aim for this range during working sets.</div>
                            </div>
                        </div>
                        <div class="metric-chip">
                            <div class="metric-chip__icon metric-chip__icon--muted">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            <div>
                                <div class="metric-chip__label">Estimated Max</div>
                                <div class="metric-chip__value">{{ target_heart_rate_zone.max_heart_rate }} bpm</div>
                                <div class="metric-chip__hint">Approx. 220 - your age.</div>
                            </div>
                        </div>
                    </div>

                    <ul class="bullet-list">
                        <li>
                            <div class="bullet-icon">
                                <i class="bi bi-smartwatch"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Stay in the middle of your zone</div>
                                <div class="text-muted small mb-0">Track with gym equipment or a wearable (Fitbit, Garmin, Apple Watch).</div>
                            </div>
                        </li>
                        <li>
                            <div class="bullet-icon">
                                <i class="bi bi-telegram"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">Listen to your breathing</div>
                                <div class="text-muted small mb-0">Conversational pace = on target. If you can’t talk, back off slightly; if you can sing, pick it up.</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card w-100 mx-auto shadow-sm rounded-4 mb-4 collapsible-card modern-collapsible">
            <button type="button" class="collapsible-toggle" data-target="training-key-content" aria-expanded="false">
                <span class="collapsible-title">Key</span>
                <i class="bi bi-chevron-down collapsible-chevron" aria-hidden="true"></i>
            </button>
            <div id="training-key-content" class="collapsible-content" hidden>
                <div class="card-body">
                    <div class="row g-3 row-cols-1 row-cols-md-2">
                        <div class="col">
                            <div class="rule-card h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0"><i class="bi bi-check2-circle me-1"></i>5 Point Rule</h6>
                                    <span class="meta-pill meta-pill--muted">Bench setup</span>
                                </div>
                                <ol class="rule-list mb-0">
                                    <li>Left foot flat on the floor</li>
                                    <li>Right foot flat on the floor</li>
                                    <li>Butt on bench</li>
                                    <li>Upper back on bench</li>
                                    <li>Head on bench</li>
                                </ol>
                            </div>
                        </div>
                        <div class="col">
                            <div class="rule-card h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="mb-0"><i class="bi bi-check2-circle me-1"></i>4 Point Rule</h6>
                                    <span class="meta-pill meta-pill--muted">Pad/row setup</span>
                                </div>
                                <ol class="rule-list mb-0">
                                    <li>Left foot flat on the floor</li>
                                    <li>Right foot flat on the floor</li>
                                    <li>Butt on bench</li>
                                    <li>Chest/back on pad</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Choose Your Workout Card -->
        <div class="card mt-4 workout-choice-card">
            <div class="workout-choice-header">
                <h3 class="workout-choice-title mb-0">Choose Your Workout</h3>
            </div>
            <div class="row justify-content-center">
                <!-- Duration pills -->
                <div class="mb-3">
                    <p class="form-label workout-subheading">Workout Duration</p>
                    {% set wd = workout_duration or 60 %}
                    <div id="duration-pills"
                        class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for minutes in [20, 30, 45, 60] %}
                        <button type="button"
                                class="btn duration-pill rounded-pill px-3 py-2
                                    {% if wd == minutes %} active {% endif %}"
                                data-minutes="{{ minutes }}"
                                aria-pressed="{{ 'true' if wd == minutes else 'false' }}"
                                aria-label="{{ minutes }} minutes">
                        {{ minutes }} min
                        </button>
                    {% endfor %}
                    </div>
                
                    <!-- Keep a hidden input so the selection exists in form data if you ever submit -->
                    <input type="hidden" id="duration-input" name="duration" value="{{ wd }}">
                </div>
  
                <!-- Category select-->
                <div class="mb-3">
                    <label for="workout-category-select" class="form-label workout-subheading">Workout Categories</label>
                    <select id="workout-category-select" class="form-select text-center shadow-sm bitcoin-workout">
                        <option value="">Select a Workout Category</option>
                        {% for category, workouts in grouped_workouts.items() %}
                            {% if user.subscription_type == 'free' %}
                                {% if category == 'Shoulders and Abs' %}
                                    <option value="{{ category }}">{{ category }}</option>
                                {% endif %}
                            {% else %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endif %}
                        {% endfor %}
                        {% if user and user.subscription_type != 'free' %}
                            <option value="{{ custom_workout_token }}">{{ custom_workout_token }}</option>
                            {% if home_workout_token %}
                                <option value="{{ home_workout_token }}">{{ home_workout_token }}</option>
                            {% endif %}
                        {% endif %}
                    </select>
                    <div id="custom-workout-controls" class="custom-workout-controls mt-3 text-center" hidden>
                        <button type="button" id="custom-workout-button" class="btn btn-outline-primary btn-sm fw-semibold px-3">
                            Choose Categories
                        </button>
                        <div id="custom-workout-summary" class="small fw-semibold text-primary mt-1 d-none"></div>
                    </div>
                    <input type="hidden"
                           id="custom-workout-input"
                           data-custom-token="{{ custom_workout_token }}"
                           data-home-token="{{ home_workout_token }}"
                           data-custom-limits='{{ custom_workout_limits | tojson }}'
                           value="[]">
                </div>
                <div id="home-equipment-controls" class="home-equipment-controls mb-3 text-center" hidden>
                    <button type="button" id="home-equipment-button" class="btn btn-outline-primary btn-sm fw-semibold px-3">
                        Choose Equipment
                    </button>
                    <div id="home-equipment-feedback" class="small text-muted mt-2 d-none"></div>
                    <div id="home-equipment-summary" class="small fw-semibold text-primary mt-1 d-none"></div>
                </div>
                <input type="hidden" id="home-equipment-input" data-options='{{ home_equipment_options | tojson }}' value="[]">
                <div class="text-center mb-3">
                    <button id="generate-workout-btn" type="button"
                        class="btn btn-primary fw-bold btn-lg border rounded-3 px-4 generate-workout-btn"
                        disabled>
                        Generate Workout
                    </button>
                </div>
            </div>
            {% set skip_namespace = namespace(items=[]) %}
            {% if injury_excluded_categories %}
                {% for token in injury_excluded_categories %}
                    {% if token not in skip_namespace.items %}
                        {% set _ = skip_namespace.items.append(token) %}
                    {% endif %}
                {% endfor %}
            {% endif %}
            {% if injury_skipped_subcategories %}
                {% for token in injury_skipped_subcategories %}
                    {% if token not in skip_namespace.items %}
                        {% set _ = skip_namespace.items.append(token) %}
                    {% endif %}
                {% endfor %}
            {% endif %}
    
            <div id="injury-alert-banner"
                 class="alert alert-success mt-2 mb-0 {% if not skip_namespace.items %}d-none{% endif %}"
                 role="status"
                 data-default-categories='{{ (injury_excluded_categories | default([], true)) | tojson }}'
                 data-default-subcategories='{{ (injury_skipped_subcategories | default([], true)) | tojson }}'
                 data-default-cardio="{{ 'true' if cardio_restriction else 'false' }}">
                <strong>Workout adjustments applied:</strong>
                <span id="injury-alert-message">
                    {% if skip_namespace.items %}
                        Skipping {{ skip_namespace.items | join(', ') }} exercises based on your restrictions.
                    {% else %}
                        Your next workouts will consider any restrictions you add here.
                    {% endif %}
                </span>
                <a href="{{ url_for('settings') }}" 
                    class="alert-link ms-1">
                    Update restrictions
                </a>
            </div>
        </div> 

        <div id="workout-stack" class="stack">
            <!-- Workout Cards -->
            <div id="workout-details" class="mt-0">
                {% for category, workouts in grouped_workouts.items() %}
                <div id="{{ category|replace(' ', '-')|lower }}-workouts" class="d-none">
                    <div class="card shadow-sm mb-2">
                        <div class="card-header bg-primary text-white">
                            <h5 class="m-0">{{ category }}</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group">
                                {% for workout in workouts %}
                                    <li class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="ms-2 me-auto">
                                            <div class="fw-bold">{{ workout[0] }}</div>
                                            <p class="small text-muted">{{ workout[1] }}</p>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div id="custom-workout-workouts" class="d-none"></div>
                <div id="home-workout-workouts" class="d-none"></div>
            </div>

            <!-- Arrow Indicator -->
            <div id="arrow-indicator" class="text-center" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor"
                    class="down-arrow bi bi-arrow-down-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v5.793L5.354 
                        8.146a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 
                        10.293z"/>
                </svg>
            </div>

            <!-- Complete Workout Button Card -->
            <div id="complete-workout-card" class="card p-3 text-center" style="display: none;">
                <button id="complete-workout-btn" 
                        class="btn btn-lg mb-3">
                    Complete Workout
                </button>
                <div id="progress-tracking-note" class="text-muted small">
                    <em>When you finish a workout, be sure to click the button above to save it and track your progress on the homepage.</em>
                </div>
            </div>
        </div>
        
        <script>
            const categorySelect = document.getElementById('workout-category-select');
            const generateWorkoutBtn = document.getElementById('generate-workout-btn');
            const arrowIndicator = document.getElementById('arrow-indicator');
            const completeWorkoutCard = document.getElementById('complete-workout-card');
            const completeWorkoutBtn = document.getElementById('complete-workout-btn');
            const progressTrackingNote = document.getElementById('progress-tracking-note');
            const toastGenerate = document.getElementById('toastGenerate');
            const durationHiddenInput = document.getElementById('duration-input');
            const customWorkoutInput = document.getElementById('custom-workout-input');
            const customWorkoutControls = document.getElementById('custom-workout-controls');
            const customWorkoutButton = document.getElementById('custom-workout-button');
            const customWorkoutFeedback = document.getElementById('custom-workout-feedback');
            const customWorkoutSummary = document.getElementById('custom-workout-summary');
            const homeEquipmentControls = document.getElementById('home-equipment-controls');
            const homeEquipmentButton = document.getElementById('home-equipment-button');
            const homeEquipmentInput = document.getElementById('home-equipment-input');
            const homeEquipmentFeedback = document.getElementById('home-equipment-feedback');
            const homeEquipmentSummary = document.getElementById('home-equipment-summary');
            let customWorkoutModal;
            let customWorkoutModalClose;
            let customWorkoutApply;
            let customWorkoutCancel;
            let customWorkoutClear;
            let customWorkoutLimitText;
            let customCheckboxes = [];
            let homeEquipmentModal;
            let homeEquipmentModalClose;
            let homeEquipmentApply;
            let homeEquipmentCancel;
            let homeEquipmentClear;
            let homeEquipmentCheckboxes = [];
            const customToken = customWorkoutInput ? customWorkoutInput.dataset.customToken : '';
            const homeWorkoutToken = customWorkoutInput ? customWorkoutInput.dataset.homeToken : '';
            let customLimits = {};
            try {
                customLimits = customWorkoutInput ? JSON.parse(customWorkoutInput.dataset.customLimits || '{}') : {};
            } catch (err) {
                console.warn('Failed to parse custom workout limits dataset.', err);
                customLimits = {};
            }
            const homeEquipmentLabelMap = new Map();
            let homeEquipmentOptions = [];
            try {
                homeEquipmentOptions = homeEquipmentInput ? JSON.parse(homeEquipmentInput.dataset.options || '[]') : [];
            } catch (err) {
                console.warn('Failed to parse home equipment options dataset.', err);
                homeEquipmentOptions = [];
            }
            homeEquipmentOptions.forEach((option) => {
                const token = String(option?.token || '').toUpperCase();
                if (!token || homeEquipmentLabelMap.has(token)) return;
                homeEquipmentLabelMap.set(token, option?.label || option?.token || token);
            });
            const customCategoryTokens = new Set([customToken, homeWorkoutToken].filter(Boolean));
            let draftCustomSelection = new Set();
            let draftEquipmentSelection = new Set();

            let toastGenerateTimeout;

            function normalizeCustomSelection(values) {
                const seen = new Set();
                const normalized = [];
                (values || []).forEach((raw) => {
                    const token = String(raw || '').trim().toUpperCase();
                    if (!token || seen.has(token)) return;
                    seen.add(token);
                    normalized.push(token);
                });
                return normalized;
            }

            function normalizeEquipmentSelection(values) {
                const seen = new Set();
                const normalized = [];
                (values || []).forEach((raw) => {
                    const token = String(raw || '').trim().toUpperCase();
                    if (!token || seen.has(token)) return;
                    seen.add(token);
                    normalized.push(token);
                });
                return normalized;
            }

            function formatCategoryLabel(value) {
                return String(value || '')
                    .toLowerCase()
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, (char) => char.toUpperCase());
            }

            function getCustomSelection() {
                if (!customWorkoutInput) return [];
                try {
                    const parsed = JSON.parse(customWorkoutInput.value || '[]');
                    const arrayValue = Array.isArray(parsed) ? parsed : [parsed];
                    return normalizeCustomSelection(arrayValue);
                } catch {
                    return [];
                }
            }

            function setCustomSelection(values) {
                if (!customWorkoutInput) return;
                const normalized = normalizeCustomSelection(values);
                customWorkoutInput.value = JSON.stringify(normalized);
                updateCustomSummary();
                syncGenerateButtonState();
            }

            function getHomeEquipmentSelection() {
                if (!homeEquipmentInput) return [];
                try {
                    const parsed = JSON.parse(homeEquipmentInput.value || '[]');
                    const arrayValue = Array.isArray(parsed) ? parsed : [parsed];
                    return normalizeEquipmentSelection(arrayValue);
                } catch {
                    return [];
                }
            }

            function formatEquipmentLabel(token) {
                return homeEquipmentLabelMap.get(token) || formatCategoryLabel(token);
            }

            function syncHomeEquipmentFeedback(selection) {
                if (!homeEquipmentFeedback) return;
                const tokens = Array.isArray(selection) ? selection : getHomeEquipmentSelection();
                if (!isHomeSelected()) {
                    homeEquipmentFeedback.classList.add('d-none');
                    homeEquipmentFeedback.classList.remove('text-danger');
                    homeEquipmentFeedback.textContent = '';
                    if (homeEquipmentSummary) {
                        homeEquipmentSummary.classList.add('d-none');
                        homeEquipmentSummary.textContent = '';
                    }
                    return;
                }
                if (!tokens.length) {
                    homeEquipmentFeedback.classList.add('text-danger');
                    homeEquipmentFeedback.innerHTML = '<span class="fw-semibold">No equipment selected yet.</span>';
                    homeEquipmentFeedback.classList.remove('d-none');
                    if (homeEquipmentSummary) {
                        homeEquipmentSummary.classList.add('d-none');
                        homeEquipmentSummary.textContent = '';
                    }
                    return;
                }
                homeEquipmentFeedback.classList.remove('text-danger');
                homeEquipmentFeedback.classList.add('d-none');
                homeEquipmentFeedback.textContent = '';
                if (homeEquipmentSummary) {
                    const pretty = tokens.map((token) => formatEquipmentLabel(token)).join(', ');
                    homeEquipmentSummary.textContent = `Selected: ${pretty}`;
                    homeEquipmentSummary.classList.remove('d-none');
                }
            }

            function setHomeEquipmentSelection(values) {
                if (!homeEquipmentInput) return;
                const normalized = normalizeEquipmentSelection(values);
                homeEquipmentInput.value = JSON.stringify(normalized);
                syncHomeEquipmentFeedback(normalized);
                syncGenerateButtonState();
            }

            function updateHomeEquipmentControls() {
                if (!homeEquipmentControls) return;
                const isHome = isHomeSelected();
                homeEquipmentControls.hidden = !isHome;
                homeEquipmentControls.style.display = isHome ? 'block' : 'none';
                homeEquipmentControls.style.pointerEvents = isHome ? 'auto' : 'none';
                if (homeEquipmentButton) {
                    homeEquipmentButton.disabled = !isHome;
                    homeEquipmentButton.setAttribute('aria-disabled', isHome ? 'false' : 'true');
                }
                if (!isHome && homeEquipmentSummary) {
                    homeEquipmentSummary.classList.add('d-none');
                    homeEquipmentSummary.textContent = '';
                }
                syncHomeEquipmentFeedback();
            }

            function openHomeEquipmentModal() {
                if (!homeEquipmentModal) return;
                draftEquipmentSelection = new Set(getHomeEquipmentSelection());
                syncHomeEquipmentCheckboxes();
                homeEquipmentModal.style.display = 'flex';
                requestAnimationFrame(() => {
                    homeEquipmentModal.classList.add('show');
                    autosizeSelectionLabels();
                });
            }

            function closeHomeEquipmentModal() {
                if (!homeEquipmentModal) return;
                homeEquipmentModal.classList.remove('show');
                homeEquipmentModal.style.display = 'none';
            }

            function syncHomeEquipmentCheckboxes() {
                if (!homeEquipmentCheckboxes.length) return;
                homeEquipmentCheckboxes.forEach((checkbox) => {
                    const token = (checkbox.value || '').toUpperCase();
                    checkbox.checked = draftEquipmentSelection.has(token);
                });
            }

            function autosizeSelectionLabels() {
                const labels = document.querySelectorAll('.selection-modal .form-check-label');
                const MIN_FONT = 12;
                labels.forEach((label) => {
                    const availableWidth = label.clientWidth;
                    if (!availableWidth) return;
                    label.style.fontSize = '';
                    const computed = window.getComputedStyle(label);
                    let fontSize = parseFloat(computed.fontSize) || 16;
                    label.style.fontSize = `${fontSize}px`;
                    let guard = 0;
                    while (label.scrollWidth > availableWidth && fontSize > MIN_FONT && guard < 20) {
                        fontSize -= 1;
                        label.style.fontSize = `${fontSize}px`;
                        guard += 1;
                    }
                });
            }

            function requiresCategorySelection() {
                return !!(categorySelect && customCategoryTokens.has(categorySelect.value));
            }

            function isHomeSelected() {
                return !!(categorySelect && homeWorkoutToken && categorySelect.value === homeWorkoutToken);
            }

            function getActiveCustomLabel() {
                if (!categorySelect) return customToken || 'Custom Gym Workout';
                if (isHomeSelected()) {
                    return homeWorkoutToken || 'Custom Home Workout';
                }
                return customToken || 'Custom Gym Workout';
            }

            function getCurrentDuration() {
                const raw = durationHiddenInput ? durationHiddenInput.value : '';
                const parsed = parseInt(raw, 10);
                return Number.isFinite(parsed) ? parsed : 60;
            }

            function selectionBounds(minutes) {
                const key = String(minutes);
                const entry = customLimits[key] || customLimits[minutes] || {};
                const minRequired = Math.max(1, Number(entry.min ?? 1));
                const maxAllowed = Math.max(minRequired, Number(entry.max ?? (customCheckboxes.length || 1)));
                return [minRequired, maxAllowed];
            }

            function isCustomSelectionValid() {
                if (!requiresCategorySelection()) return true;
                const selection = getCustomSelection();
                const [minRequired, maxAllowed] = selectionBounds(getCurrentDuration());
                return selection.length >= minRequired && selection.length <= maxAllowed;
            }

            function updateCustomSummary() {
                if (!customWorkoutControls) return;
                const isActive = requiresCategorySelection();
                customWorkoutControls.hidden = !isActive;
                customWorkoutControls.style.display = isActive ? 'block' : 'none';
                customWorkoutControls.style.pointerEvents = isActive ? 'auto' : 'none';
                if (customWorkoutButton) {
                    customWorkoutButton.disabled = !isActive;
                    customWorkoutButton.setAttribute('aria-disabled', isActive ? 'false' : 'true');
                }
                if (!isActive) {
                    return;
                }

                const selection = getCustomSelection();
                const minutes = getCurrentDuration();
                const [minRequired, maxAllowed] = selectionBounds(minutes);
                const withinBounds = selection.length >= minRequired && selection.length <= maxAllowed;

                if (customWorkoutFeedback) {
                    const rangeText = minRequired === maxAllowed
                        ? `Select exactly ${minRequired}`
                        : `Select ${minRequired}–${maxAllowed}`;
                    const label = getActiveCustomLabel();
                    customWorkoutFeedback.textContent = `${rangeText} categories for a ${minutes}-minute ${label}.`;
                    customWorkoutFeedback.classList.toggle('text-danger', !withinBounds);
                }

                if (customWorkoutSummary) {
                    customWorkoutSummary.classList.remove('d-none');
                    if (!selection.length) {
                        customWorkoutSummary.textContent = 'No categories selected yet.';
                        customWorkoutSummary.classList.add('text-muted');
                    } else {
                        customWorkoutSummary.textContent = `Selected: ${selection.map(formatCategoryLabel).join(', ')}`;
                        customWorkoutSummary.classList.remove('text-muted');
                    }
                    customWorkoutSummary.classList.toggle('text-danger', selection.length > 0 && !withinBounds);
                }
            }

            function syncModalCheckboxes() {
                if (!customCheckboxes.length) return;
                customCheckboxes.forEach((checkbox) => {
                    checkbox.checked = draftCustomSelection.has(checkbox.value);
                });
            }

            function updateModalStatus() {
                if (!customWorkoutLimitText) return;
                const minutes = getCurrentDuration();
                const [minRequired, maxAllowed] = selectionBounds(minutes);
                const selected = draftCustomSelection.size;
                const rangeText = minRequired === maxAllowed
                    ? `Select exactly ${minRequired}`
                    : `Select ${minRequired}–${maxAllowed}`;
                customWorkoutLimitText.textContent = `${rangeText} categories in your preferred order (${selected} selected).`;
                const valid = selected >= minRequired && selected <= maxAllowed;
                customWorkoutLimitText.classList.toggle('text-danger', !valid);
            }

            function flashModalWarning() {
                if (!customWorkoutLimitText) return;
                customWorkoutLimitText.classList.add('text-danger');
                customWorkoutLimitText.classList.add('fw-semibold');
                setTimeout(() => customWorkoutLimitText.classList.remove('fw-semibold'), 800);
            }

            function openCustomModal() {
                if (!customWorkoutModal) return;
                draftCustomSelection = new Set(getCustomSelection());
                syncModalCheckboxes();
                updateModalStatus();
                customWorkoutModal.style.display = 'flex';
                requestAnimationFrame(() => {
                    customWorkoutModal.classList.add('show');
                    autosizeSelectionLabels();
                });
            }

            function closeCustomModal() {
                if (!customWorkoutModal) return;
                customWorkoutModal.classList.remove('show');
                customWorkoutModal.style.display = 'none';
                draftCustomSelection = new Set(getCustomSelection());
                syncModalCheckboxes();
                updateModalStatus();
            }

            function handleDurationChange(minutes) {
                if (!customWorkoutInput) return;
                const selection = getCustomSelection();
                const [minRequired, maxAllowed] = selectionBounds(minutes);
                let nextSelection = selection;

                if (selection.length > maxAllowed) {
                    nextSelection = selection.slice(0, maxAllowed);
                    setCustomSelection(nextSelection);
                    if (customWorkoutFeedback) {
                        customWorkoutFeedback.classList.add('text-danger');
                        setTimeout(() => customWorkoutFeedback.classList.remove('text-danger'), 1200);
                    }
                } else {
                    setCustomSelection(selection);
                }

                if (customWorkoutModal && customWorkoutModal.classList.contains('show')) {
                    draftCustomSelection = new Set(nextSelection);
                    syncModalCheckboxes();
                    updateModalStatus();
                }

                if (selection.length < minRequired) {
                    updateCustomSummary();
                }
            }

            initCollapsibleCards();

            function initCollapsibleCards() {
                const toggles = document.querySelectorAll('.collapsible-toggle');
                toggles.forEach(toggle => {
                    const targetId = toggle.dataset.target;
                    if (!targetId) return;
                    const content = document.getElementById(targetId);
                    if (!content) return;

                    toggle.addEventListener('click', () => {
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        if (isExpanded) {
                            collapseCollapsible(content, toggle);
                        } else {
                            expandCollapsible(content, toggle);
                        }
                    });
                });
            }

            function expandCollapsible(content, toggle) {
                content.hidden = false;
                content.style.maxHeight = 'none';
                const sectionHeight = content.scrollHeight;
                content.style.maxHeight = '0px';
                content.offsetHeight; // force reflow so transition triggers
                content.style.maxHeight = sectionHeight + 'px';
                toggle.setAttribute('aria-expanded', 'true');

                const onTransitionEnd = (event) => {
                    if (event.propertyName !== 'max-height') return;
                    content.style.maxHeight = 'none';
                    content.removeEventListener('transitionend', onTransitionEnd);
                };
                content.addEventListener('transitionend', onTransitionEnd);
            }

            function collapseCollapsible(content, toggle) {
                if (content.style.maxHeight === 'none') {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
                content.offsetHeight; // force reflow before collapsing
                content.style.maxHeight = '0px';
                toggle.setAttribute('aria-expanded', 'false');

                const onTransitionEnd = (event) => {
                    if (event.propertyName !== 'max-height') return;
                    content.hidden = true;
                    content.removeEventListener('transitionend', onTransitionEnd);
                };
                content.addEventListener('transitionend', onTransitionEnd);
            }

            function showGenerateToast(message) {
                if (!toastGenerate) return;
                toastGenerate.textContent = message;
                toastGenerate.style.display = 'block';
                if (toastGenerateTimeout) {
                    clearTimeout(toastGenerateTimeout);
                }
                toastGenerateTimeout = setTimeout(() => {
                    toastGenerate.style.display = 'none';
                }, 2500);
            }

            function syncSelectStyle() {
                if (!categorySelect) return;
                categorySelect.classList.toggle('select-orange', !!categorySelect.value);
                updateCustomSummary();
                updateHomeEquipmentControls();
            }

            function syncGenerateButtonState() {
                if (!generateWorkoutBtn) return;
                const hasCategory = !!(categorySelect && categorySelect.value);
                const isLoading = generateWorkoutBtn.dataset.loading === 'true';
                const customValid = isCustomSelectionValid();
                const equipmentValid = !isHomeSelected() || getHomeEquipmentSelection().length > 0;
                generateWorkoutBtn.disabled = !hasCategory || isLoading || !customValid || !equipmentValid;
            }

            function setGenerateButtonLoading(isLoading) {
                if (!generateWorkoutBtn) return;
                generateWorkoutBtn.dataset.loading = isLoading ? 'true' : 'false';
                generateWorkoutBtn.textContent = isLoading ? 'Generating...' : 'Generate Workout';
                syncGenerateButtonState();
            }

            function clearWorkoutView() {
                document.querySelectorAll('#workout-details > div').forEach(div => div.classList.add('d-none'));
                if (arrowIndicator) arrowIndicator.style.display = 'none';
                if (completeWorkoutCard) completeWorkoutCard.style.display = 'none';
                if (completeWorkoutBtn) {
                    delete completeWorkoutBtn.dataset.category;
                    completeWorkoutBtn.textContent = 'Complete Workout';
                }
                if (progressTrackingNote) {
                    progressTrackingNote.style.display = 'none';
                }
            }

            const NOTES_PLACEHOLDER = '';

            function escapeHtml(value) {
                if (value === undefined || value === null) {
                    return '';
                }
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function buildExerciseHtml(subcategoryName, exercise, index) {
                const exerciseName = exercise.name || '';
                const safeExerciseName = escapeHtml(exerciseName);
                const isCardio = (subcategoryName || '').toLowerCase() === 'cardio';
                const isBodyweight = exerciseName.toLowerCase().includes('bodyweight');
                const uniqueKey = exercise.workout_id ?? `${subcategoryName}-${index}`;
                const descId = `desc-${String(uniqueKey).replace(/[^a-zA-Z0-9_-]/g, '-')}`;
                const hasWeight = exercise.max_weight !== null && exercise.max_weight !== undefined;
                const hasReps = exercise.max_reps !== null && exercise.max_reps !== undefined;
                const weightValue = hasWeight ? Number(exercise.max_weight) : null;
                const weightDisplay = (isBodyweight || isCardio)
                    ? 'Bodyweight'
                    : (Number.isFinite(weightValue) ? `${weightValue.toFixed(1)} lbs` : (hasWeight ? `${exercise.max_weight} lbs` : '—'));
                const repsDisplay = hasReps
                    ? (isCardio ? `${exercise.max_reps} min` : `${exercise.max_reps} reps`)
                    : '—';
                const summaryValue = (isBodyweight || isCardio)
                    ? `Bodyweight × ${repsDisplay}`
                    : `${weightDisplay} × ${repsDisplay}`;
                const youtubeSection = exercise.youtube_id ? `
                        <p class="exercise-media-label mb-2">Video Demonstration:</p>
                        <div class="exercise-video-wrapper mb-4">
                            <div class="exercise-video-shell">
                                <iframe
                                    class="exercise-video-frame"
                                    src="https://www.youtube.com/embed/${exercise.youtube_id}?mute=1&playsinline=1"
                                    title="${safeExerciseName} tutorial"
                                    allow="autoplay; encrypted-media"
                                    allowfullscreen>
                                </iframe>
                            </div>
                        </div>
                ` : '';

                const workoutIdAttr = exercise.workout_id ?? '';
                const categoryAttr = (subcategoryName || '').replace(/"/g, '&quot;');
                const description = escapeHtml(exercise.description || 'No description available.');
                const rawNotes = typeof exercise.notes === 'string' ? exercise.notes : '';
                const hasNotes = rawNotes.trim().length > 0;
                const notesDisplay = hasNotes
                    ? escapeHtml(rawNotes).replace(/\n/g, '<br>')
                    : `<span class="text-muted">${escapeHtml(NOTES_PLACEHOLDER)}</span>`;
                const encodedNotes = encodeURIComponent(rawNotes);
                const notesButtonLabel = hasNotes ? 'Edit Notes' : 'Add Notes';

                return `
                    <li class="mb-4">
                        <div class="card shadow text-center w-100 exercise-card">
                            <h6 class="exercise-name">${safeExerciseName}</h6>
                            <div class="exercise-media-row d-flex justify-content-center flex-nowrap mb-3 px-2">
                                <div class="d-flex flex-column align-items-center">
                                    <p class="exercise-media-label mb-2">Start:</p>
                                    <img src="/static/images/${exercise.image_exercise_start}"
                                        alt="Start of ${safeExerciseName}"
                                        class="clickable-img exercise-media-image"
                                        data-group="${safeExerciseName}" data-index="0">
                                </div>
                                <div class="d-flex flex-column align-items-center">
                                    <p class="exercise-media-label mb-2">End:</p>
                                    <img src="/static/images/${exercise.image_exercise_end}"
                                        alt="End of ${safeExerciseName}"
                                        class="clickable-img exercise-media-image"
                                        data-group="${safeExerciseName}" data-index="1">
                                </div>
                            </div>
                            ${youtubeSection}
                            <div class="d-flex flex-column align-items-center gap-3 max-actions">
                                <div class="personal-best max-summary" data-id="${workoutIdAttr}" data-category="${categoryAttr}">
                                    <span class="max-label text-uppercase fw-semibold">Your Max</span>
                                    <div class="max-pill-row">
                                        <span class="max-pill max-pill-weight">${weightDisplay}</span>
                                        <span class="max-times">×</span>
                                        <span class="max-pill max-pill-reps">${repsDisplay}</span>
                                    </div>
                                    <span class="personal-max-text d-none">Your Max: ${summaryValue}</span>
                                </div>
                                <div class="d-flex flex-wrap justify-content-center gap-2 max-action-buttons">
                                    <button class="btn btn-outline-secondary btn-sm max-action-btn update-pr-link"
                                        data-id="${workoutIdAttr}"
                                        data-category="${categoryAttr}">
                                        Update Max
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm max-action-btn toggle-description"
                                        type="button"
                                        data-id="${descId}">
                                        View Description
                                    </button>
                                </div>
                            </div>
                            <div id="${descId}" class="exercise-description mt-3 text-center" style="display: none;">
                                <p class="small text-muted mb-0">${description}</p>
                            </div>
                            <div class="exercise-notes mt-3 text-start">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <i class="bi bi-journal-text text-primary"></i>
                                    <button class="btn btn-outline-info btn-sm edit-notes-btn"
                                        data-id="${workoutIdAttr}"
                                        data-category="${categoryAttr}"
                                        data-notes="${encodedNotes}">
                                        ${notesButtonLabel}
                                    </button>
                                </div>
                                <div class="notes-body small" data-id="${workoutIdAttr}">${notesDisplay}</div>
                            </div>
                        </div>
                    </li>
                `;
            }

            function buildWorkoutHtml(selectedCategory, workoutData, displayLabel) {
                const heading = displayLabel || selectedCategory;
                const safeHeading = escapeHtml(heading);
                const sections = workoutData.map(subcategory => `
                    <div class="card workout-subcategory-card shadow-sm">
                        <h6 class="workout-subcategory-title">${subcategory.subcategory}</h6>
                        <div class="mt-3">
                            <ul class="list-unstyled mb-0">
                                ${subcategory.exercises.map((exercise, idx) => buildExerciseHtml(subcategory.subcategory, exercise, idx)).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="card w-100 mb-0 shadow-sm workout-card" style="padding: 18px; background: rgba(255, 255, 255, 0.68); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
                        <div class="workout-category-header">
                            <h5 class="workout-category-title text-white">${safeHeading}</h5>
                        </div>
                        <div class="card-body px-0 px-sm-2 px-md-3">
                            <div class="workout-subcategory-stack">
                                ${sections}
                            </div>
                        </div>
                    </div>
                `;
            }

            function renderWorkout(selectedCategory, workoutData, options = {}) {
                clearWorkoutView();
                if (!selectedCategory || !Array.isArray(workoutData) || workoutData.length === 0) {
                    return;
                }

                const safeId = `${selectedCategory.replaceAll(' ', '-').toLowerCase()}-workouts`;
                let targetId = safeId;
                if (selectedCategory === customToken) {
                    targetId = 'custom-workout-workouts';
                } else if (selectedCategory === homeWorkoutToken) {
                    targetId = 'home-workout-workouts';
                }
                const categoryDiv = document.getElementById(targetId);
                if (!categoryDiv) return;

                const customSelection = Array.isArray(options.customCategories) ? options.customCategories : [];
                const usesCustomHeading = customCategoryTokens.has(selectedCategory);
                const displayLabel = (usesCustomHeading && customSelection.length)
                    ? customSelection
                        .map((token) => formatCategoryLabel(token))
                        .filter((value, index, array) => array.indexOf(value) === index)
                        .join(', ')
                    : selectedCategory;

                categoryDiv.innerHTML = buildWorkoutHtml(selectedCategory, workoutData, displayLabel);
                categoryDiv.classList.remove('d-none');

                if (arrowIndicator) arrowIndicator.style.display = 'block';
                if (completeWorkoutCard) completeWorkoutCard.style.display = 'block';
                if (completeWorkoutBtn) {
                    completeWorkoutBtn.dataset.category = selectedCategory;
                    if (usesCustomHeading && customSelection.length) {
                        const pretty = customSelection
                            .map((token) => formatCategoryLabel(token))
                            .filter((value, index, array) => array.indexOf(value) === index)
                            .join(', ');
                        completeWorkoutBtn.textContent = `Complete ${pretty} Workout`;
                    } else {
                        completeWorkoutBtn.textContent = `Complete ${selectedCategory} Workout`;
                    }
                }
                if (progressTrackingNote) {
                    progressTrackingNote.style.display = 'block';
                }

                bindImageClickEvents();
            }

            window.renderWorkout = renderWorkout;

            async function hydrateActiveWorkout() {
                try {
                    const response = await fetch('/get_active_workout');
                    if (!response.ok) return;
                    const data = await response.json();
                    if (data.success && data.workout) {
                        if (categorySelect) {
                            categorySelect.value = data.category || '';
                            if (customCategoryTokens.has(data.category) && Array.isArray(data.custom_categories)) {
                                setCustomSelection(data.custom_categories);
                            }
                        }
                        if (data.category === homeWorkoutToken && Array.isArray(data.home_equipment)) {
                            setHomeEquipmentSelection(data.home_equipment);
                        } else if (homeEquipmentInput) {
                            setHomeEquipmentSelection([]);
                        }
                        renderWorkout(
                            data.category,
                            data.workout,
                            { customCategories: data.custom_categories, homeEquipment: data.home_equipment }
                        );
                        updateInjuryAlertBanner(data.skipped);
                    } else {
                        renderWorkout(null, []);
                        updateInjuryAlertBanner(null);
                    }
                } catch (err) {
                    console.error('Failed to load active workout:', err);
                    updateInjuryAlertBanner(null);
                } finally {
                    syncSelectStyle();
                    syncGenerateButtonState();
                }
            }

            async function handleGenerateClick() {
                if (!categorySelect || !categorySelect.value) {
                    alert('Please select a workout category first.');
                    return;
                }

                if (!isCustomSelectionValid()) {
                    alert(`Select categories within the allowed range for your ${getActiveCustomLabel()}.`);
                    return;
                }
                if (isHomeSelected() && !getHomeEquipmentSelection().length) {
                    alert('Select at least one piece of equipment for your Custom Home Workout.');
                    return;
                }

                const selectedCategory = categorySelect.value;
                setGenerateButtonLoading(true);

                try {
                    let url = `/generate_workout?category=${encodeURIComponent(selectedCategory)}`;
                    if (requiresCategorySelection()) {
                        const selection = getCustomSelection();
                        if (!selection.length) {
                            alert(`Choose at least one category for your ${getActiveCustomLabel()}.`);
                            setGenerateButtonLoading(false);
                            return;
                        }
                        selection.forEach((token) => {
                            url += `&custom_categories=${encodeURIComponent(token)}`;
                        });
                    }
                        if (selectedCategory === homeWorkoutToken) {
                            const equipmentTokens = getHomeEquipmentSelection();
                            if (!equipmentTokens.length) {
                                alert('Select at least one piece of equipment for your Custom Home Workout.');
                                setGenerateButtonLoading(false);
                                return;
                        }
                        equipmentTokens.forEach((token) => {
                            url += `&home_equipment=${encodeURIComponent(token)}`;
                        });
                    }

                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.success) {
                        if (customCategoryTokens.has(data.category) && Array.isArray(data.custom_categories)) {
                            setCustomSelection(data.custom_categories);
                        }
                        if (data.category === homeWorkoutToken && Array.isArray(data.home_equipment)) {
                            setHomeEquipmentSelection(data.home_equipment);
                        }
                        renderWorkout(
                            data.category || selectedCategory,
                            data.workout,
                            { customCategories: data.custom_categories, homeEquipment: data.home_equipment }
                        );
                        showGenerateToast(`⚡ New ${data.category || selectedCategory} workout generated.`);
                        updateInjuryAlertBanner(data.skipped);
                        syncSelectStyle();
                        syncGenerateButtonState();
                    } else {
                        alert(data.error || 'Could not generate workout. Please try again.');
                    }
                } catch (err) {
                    console.error('Error fetching workout:', err);
                    alert('An error occurred. Please try again.');
                } finally {
                    setGenerateButtonLoading(false);
                }
            }

            if (generateWorkoutBtn) {
                generateWorkoutBtn.addEventListener('click', handleGenerateClick);
            }

            if (categorySelect) {
                categorySelect.addEventListener('change', () => {
                    syncSelectStyle();
                    syncGenerateButtonState();
                    if (requiresCategorySelection() && !getCustomSelection().length) {
                        setTimeout(() => openCustomModal(), 50);
                    }
                    updateHomeEquipmentControls();
                });
            }

            function bindCustomModalEvents() {
                if (customWorkoutButton) {
                    customWorkoutButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        openCustomModal();
                    });
                }
                if (customWorkoutModalClose) {
                    customWorkoutModalClose.addEventListener('click', () => closeCustomModal());
                }
                if (customWorkoutCancel) {
                    customWorkoutCancel.addEventListener('click', (event) => {
                        event.preventDefault();
                        closeCustomModal();
                    });
                }
                if (customWorkoutModal) {
                    customWorkoutModal.addEventListener('click', (event) => {
                        if (event.target === customWorkoutModal) {
                            closeCustomModal();
                        }
                    });
                }
                if (customWorkoutApply) {
                    customWorkoutApply.addEventListener('click', () => {
                        setCustomSelection(Array.from(draftCustomSelection));
                        closeCustomModal();
                    });
                }
                if (customWorkoutClear) {
                    customWorkoutClear.addEventListener('click', (event) => {
                        event.preventDefault();
                        draftCustomSelection = new Set();
                        syncModalCheckboxes();
                        updateModalStatus();
                    });
                }
                customCheckboxes.forEach((checkbox) => {
                    checkbox.addEventListener('change', () => {
                        const [, maxAllowed] = selectionBounds(getCurrentDuration());
                        if (checkbox.checked) {
                            if (draftCustomSelection.size >= maxAllowed) {
                                checkbox.checked = false;
                                flashModalWarning();
                                return;
                            }
                            draftCustomSelection.add(checkbox.value);
                        } else {
                            draftCustomSelection.delete(checkbox.value);
                        }
                        updateModalStatus();
                    });
                });
            }

            function bindHomeEquipmentModalEvents() {
                if (homeEquipmentButton) {
                    homeEquipmentButton.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (homeEquipmentButton.disabled) return;
                        openHomeEquipmentModal();
                    });
                }
                if (homeEquipmentModalClose) {
                    homeEquipmentModalClose.addEventListener('click', () => closeHomeEquipmentModal());
                }
                if (homeEquipmentCancel) {
                    homeEquipmentCancel.addEventListener('click', (event) => {
                        event.preventDefault();
                        closeHomeEquipmentModal();
                    });
                }
                if (homeEquipmentModal) {
                    homeEquipmentModal.addEventListener('click', (event) => {
                        if (event.target === homeEquipmentModal) {
                            closeHomeEquipmentModal();
                        }
                    });
                }
                if (homeEquipmentApply) {
                    homeEquipmentApply.addEventListener('click', () => {
                        setHomeEquipmentSelection(Array.from(draftEquipmentSelection));
                        closeHomeEquipmentModal();
                    });
                }
                if (homeEquipmentClear) {
                    homeEquipmentClear.addEventListener('click', (event) => {
                        event.preventDefault();
                        draftEquipmentSelection = new Set();
                        syncHomeEquipmentCheckboxes();
                    });
                }
                homeEquipmentCheckboxes.forEach((checkbox) => {
                    checkbox.addEventListener('change', () => {
                        const token = (checkbox.value || '').toUpperCase();
                        if (!token) return;
                        if (checkbox.checked) {
                            draftEquipmentSelection.add(token);
                        } else {
                            draftEquipmentSelection.delete(token);
                        }
                    });
                });
            }

            function cacheCustomModalElements() {
                customWorkoutModal = document.getElementById('customWorkoutModal');
                customWorkoutModalClose = document.getElementById('customWorkoutModalClose');
                customWorkoutApply = document.getElementById('customWorkoutApply');
                customWorkoutCancel = document.getElementById('customWorkoutCancel');
                customWorkoutClear = document.getElementById('customWorkoutClear');
                customWorkoutLimitText = document.getElementById('custom-workout-limit-text');
                customCheckboxes = customWorkoutModal ? Array.from(customWorkoutModal.querySelectorAll('.custom-workout-checkbox')) : [];
            }

            function cacheHomeEquipmentModalElements() {
                homeEquipmentModal = document.getElementById('homeEquipmentModal');
                homeEquipmentModalClose = document.getElementById('homeEquipmentModalClose');
                homeEquipmentApply = document.getElementById('homeEquipmentApply');
                homeEquipmentCancel = document.getElementById('homeEquipmentCancel');
                homeEquipmentClear = document.getElementById('homeEquipmentClear');
                homeEquipmentCheckboxes = homeEquipmentModal
                    ? Array.from(homeEquipmentModal.querySelectorAll('.home-equipment-checkbox'))
                    : [];
            }

            document.addEventListener('DOMContentLoaded', () => {
                cacheCustomModalElements();
                bindCustomModalEvents();
                cacheHomeEquipmentModalElements();
                bindHomeEquipmentModalEvents();
            });

            window.addEventListener('resize', () => {
                const customVisible = customWorkoutModal && customWorkoutModal.classList.contains('show');
                const homeVisible = homeEquipmentModal && homeEquipmentModal.classList.contains('show');
                if (customVisible || homeVisible) {
                    autosizeSelectionLabels();
                }
            });

            syncHomeEquipmentFeedback();
            updateHomeEquipmentControls();
            syncSelectStyle();
            syncGenerateButtonState();
            handleDurationChange(getCurrentDuration());
            hydrateActiveWorkout();

            if (completeWorkoutBtn) {
                completeWorkoutBtn.addEventListener('click', async () => {
                    if (completeWorkoutBtn.dataset.submitting === 'true') {
                        return;
                    }
                    completeWorkoutBtn.dataset.submitting = 'true';
                    try {
                        const response = await fetch('/complete_workout', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ category: completeWorkoutBtn.dataset.category })
                        });

                        const data = await response.json();
                        if (data.success) {
                            alert('Workout marked as complete!');
                            window.location.href = '/';
                        } else {
                            alert(data.error || 'An error occurred. Please try again.');
                        }
                    } catch (err) {
                        console.error('Error completing workout:', err);
                        alert('An error occurred. Please try again.');
                    } finally {
                        completeWorkoutBtn.dataset.submitting = 'false';
                    }
                });
            }
        </script>

        <!-- Custom Workout Modal -->
        <div id="customWorkoutModal" class="modal-overlay" style="display: none;">
            <div class="modal-card custom-workout-modal selection-modal">
                <button type="button" id="customWorkoutModalClose" class="btn-close"></button>
                <h5 class="mb-2">Build Your Custom Gym Workout</h5>
                <p class="small text-muted mb-3" id="custom-workout-limit-text">Select categories to get started.</p>
                <div class="selection-grid">
                    {% for category in custom_workout_categories %}
                        <div class="form-check custom-workout-check selection-tile">
                            <input class="form-check-input custom-workout-checkbox" type="checkbox" value="{{ category }}" id="custom-cat-{{ loop.index }}">
                            <label class="form-check-label fw-semibold" for="custom-cat-{{ loop.index }}">{{ category.title() }}</label>
                        </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button type="button" class="btn btn-link text-decoration-none px-0" id="customWorkoutClear">Clear All</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="customWorkoutCancel">Cancel</button>
                        <button type="button" class="btn btn-brand" id="customWorkoutApply">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Equipment Modal -->
        <div id="homeEquipmentModal" class="modal-overlay" style="display: none;">
            <div class="modal-card custom-workout-modal selection-modal">
                <button type="button" id="homeEquipmentModalClose" class="btn-close"></button>
                <h5 class="mb-2">Choose Home Equipment</h5>
                <p class="small text-muted mb-3">Select the equipment you have access to for this Custom Home Workout.</p>
                <div class="selection-grid">
                    {% for option in home_equipment_options %}
                        <div class="form-check custom-workout-check selection-tile">
                            <input class="form-check-input home-equipment-checkbox" type="checkbox" value="{{ option.token }}" id="home-equip-{{ loop.index }}">
                            <label class="form-check-label fw-semibold" for="home-equip-{{ loop.index }}">{{ option.label }}</label>
                        </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button type="button" class="btn btn-link text-decoration-none px-0" id="homeEquipmentClear">Clear All</button>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="homeEquipmentCancel">Cancel</button>
                        <button type="button" class="btn btn-brand" id="homeEquipmentApply">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Toast -->
        <div id="toastSuccess" class="toast-floating toast-success">
            Max updated!
        </div>

        <div id="toastGenerate" class="toast-floating toast-info">
            ⚡ Workout ready!
        </div>

        <!-- Max Update Modal -->
        <div id="prModal" class="modal-overlay" style="display: none;">
            <div class="modal-card">
                <button id="prModalClose" class="btn-close"></button>
                <h5 class="mb-3">Update Max</h5>
                <input type="number" id="maxWeightInput" class="form-control mb-2" placeholder="Max Weight (lbs)" title="Bodyweight exercises do not require a weight entry">
                <input type="number" id="maxRepsInput" class="form-control mb-3" placeholder="Max Reps">
                <button id="submitPrBtn" class="btn btn-brand w-100 mb-2">Save</button>
            </div>
        </div>

        <!-- Notes Modal -->
        <div id="notesModal" class="modal-overlay" style="display: none;">
            <div class="modal-card">
                <button id="notesModalClose" class="btn-close"></button>
                <h5 class="mb-3">Exercise Notes</h5>
                <textarea id="notesTextarea" class="form-control mb-3" rows="6" placeholder="Add your personal notes..."></textarea>
                <button id="saveNotesBtn" class="btn btn-brand w-100 mb-2">Save</button>
            </div>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" style="
            display:none; 
            position:fixed; 
            inset:0; 
            z-index:9999; 
            background:rgba(0,0,0,0.8);
        ">
            <div id="modalContent" style="
                position: relative; 
                width: 100%; 
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
            ">
                <div id="imageWrapper" style="
                position: relative; 
                display: inline-block; 
                max-width: 90vw; 
                max-height: 90vh;
                ">
                    <span id="modalClose" style="
                        position: absolute; 
                        top: -6px; 
                        right: 8px; 
                        font-size: 1.8rem; 
                        color: rgba(220, 220, 220, 0.85); 
                        cursor: pointer; 
                        z-index: 10001;
                    ">&times;</span>
            
                    <img id="modalImage" style="
                        max-width: 100%; 
                        max-height: 100%; 
                        cursor: pointer;
                        display: block;
                    ">
                </div>
                <div id="swipeOverlay" style="
                    margin-top: -2px;
                    text-align: center;
                    color: rgba(220, 220, 220, 0.8);
                    font-size: 1.5rem;
                    font-weight: bold;
                    opacity: 0.85;
                    text-shadow: 0 0 8px rgba(0,0,0,0.8);
                    pointer-events: none;
                    transition: opacity 0.5s ease;
                    z-index: 10000;
                ">&lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;</div>
            </div>
        </div>
        
            
        <script>
        // Toggle Description JS 
        document.addEventListener('click', function (e) {
            const toggle = e.target.closest('.toggle-description');
            if (!toggle) return;

            e.preventDefault();
            const descId = toggle.getAttribute('data-id');
            const descElement = document.getElementById(descId);

            if (!descElement) {
                console.warn("No element found for ID:", descId);
                return;
            }

            const isHidden = descElement.style.display === 'none' || descElement.style.display === '';

            if (isHidden) {
                // Slide down
                descElement.style.display = 'block';
                descElement.style.maxHeight = '0px';
                descElement.style.overflow = 'hidden';
                descElement.style.transition = 'max-height 0.3s ease-out';
                setTimeout(() => {
                    descElement.style.maxHeight = descElement.scrollHeight + 'px';
                }, 10);
                toggle.textContent = 'Hide Description';
            } else {
                // Slide up
                descElement.style.maxHeight = '0px';
                setTimeout(() => {
                    descElement.style.display = 'none'; 
                }, 300); // Match the transition duration
                toggle.textContent = 'View Description';
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            bindImageClickEvents();
        });

        // Clickable Image JS 
        function bindImageClickEvents() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            let currentGroup = null;
            let currentIndex = 0;
            let groupImages = [];

            document.querySelectorAll('.clickable-img').forEach(img => {
                img.addEventListener('click', () => {
                    console.log('Image clicked:', img.src);
                    console.log('Group:', img.dataset.group);
                    console.log('Index:', img.dataset.index);

                    currentGroup = img.dataset.group;
                    currentIndex = parseInt(img.dataset.index);
                    groupImages = Array.from(document.querySelectorAll(`.clickable-img[data-group="${currentGroup}"]`));
                    const selectedImage = groupImages[currentIndex];
                    console.log('Selected image for modal:', selectedImage);

                    showModal(selectedImage?.src || '');
                });
            });

            function showModal(src) {
                console.log('Opening modal with image src:', src);  
                if (!src) {
                    console.warn('Modal image src is missing!');
                    return;
                }
                modalImg.src = src;
                modal.style.display = 'block';
            }

            function hideModal() {
                modal.style.display = 'none';
            }

            modal.addEventListener('click', hideModal);
            modalImg.addEventListener('click', hideModal); // tap image to close

            // Swipe support
            let touchStartX = 0;

            modal.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            modal.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const deltaX = touchEndX - touchStartX;

                if (Math.abs(deltaX) > 50) {
                    // swipe left/right
                    if (deltaX > 0) {
                        // swipe right: previous
                        currentIndex = (currentIndex - 1 + groupImages.length) % groupImages.length;
                    } else {
                        // swipe left: next
                        currentIndex = (currentIndex + 1) % groupImages.length;
                    }
                    showModal(groupImages[currentIndex].src);
                }
            });
        }


        // Video Clickable JS 
        document.addEventListener('click', function (e) {
            const video = e.target;
            if (video.tagName === 'VIDEO' && video.classList.contains('video-clickable')) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                }
            }
        });


        // Update Max JS 
        document.addEventListener('DOMContentLoaded', function () {
            let currentWorkoutId = null;

            // Open modal when clicking "Update Max"
            document.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('update-pr-link')) {
                    e.preventDefault();

                    currentWorkoutId = e.target.dataset.id;
                    const bestWrapper = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"]`);
                    const categoryLabel = (e.target.dataset.category || '').toLowerCase();
                    const isCardio = categoryLabel === 'cardio';
                    const weightSpan = bestWrapper?.querySelector('.max-pill-weight');
                    const repsSpan = bestWrapper?.querySelector('.max-pill-reps');
                    const weightText = weightSpan ? weightSpan.textContent.trim() : '';
                    const repsText = repsSpan ? repsSpan.textContent.trim() : '';
                    const isBodyweight = weightText.toLowerCase().includes('bodyweight');
                    const treatAsBodyweight = isBodyweight || isCardio;

                    const weightInput = document.getElementById('maxWeightInput');
                    const numericWeight = parseFloat(weightText.replace(/[^0-9.]+/g, ''));
                    weightInput.value = (!treatAsBodyweight && Number.isFinite(numericWeight)) ? numericWeight : '';
                    weightInput.disabled = treatAsBodyweight;
                    if (treatAsBodyweight) {
                        weightInput.placeholder = isCardio ? 'Cardio exercise' : 'Bodyweight exercise';
                    } else {
                        weightInput.placeholder = 'Max Weight (lbs)';
                    }
                    weightInput.title = weightInput.placeholder;

                    const repsInput = document.getElementById('maxRepsInput');
                    const numericReps = parseInt(repsText.replace(/[^0-9]+/g, ''), 10);
                    repsInput.value = Number.isFinite(numericReps) ? numericReps : '';
                    repsInput.placeholder = isCardio ? 'Minutes' : 'Reps';
                    repsInput.title = repsInput.placeholder;

                    const modal = document.getElementById('prModal');
                    modal.classList.add('show');
                    modal.style.display = 'flex';
                }

                // Close modal when clicking the "X" button
                if (e.target.id === 'prModalClose') {
                    const modal = document.getElementById('prModal');
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
            });

            // Handle modal "Save" button
            document.getElementById('submitPrBtn').addEventListener('click', function () {
                const maxWeightInput = document.getElementById('maxWeightInput');
                const maxRepsInput = document.getElementById('maxRepsInput');

                const maxWeight = parseFloat(maxWeightInput.value);
                const maxReps = parseInt(maxRepsInput.value);
                const isCardio = document.getElementById('maxRepsInput').placeholder.toLowerCase().includes('minute');

                // Validation: allow 0 weight if it's a bodyweight exercise (disabled input)
                if (isNaN(maxReps) || (maxWeightInput.disabled === false && isNaN(maxWeight))) {
                    alert("Please enter valid values.");
                    return;
                }

                fetch('/update_pr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workout_id: currentWorkoutId,
                        max_weight: maxWeight,
                        max_reps: maxReps
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const bestWrapper = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"]`);
                        if (bestWrapper) {
                            const weightSpan = bestWrapper.querySelector('.max-pill-weight');
                            const repsSpan = bestWrapper.querySelector('.max-pill-reps');
                            const hiddenSummary = bestWrapper.querySelector('.personal-max-text');
                            const displayReps = isCardio
                                ? `${maxReps} min`
                                : `${maxReps} reps`;
                            const weightLabel = maxWeightInput.disabled
                                ? 'Bodyweight'
                                : `${parseFloat(maxWeight).toFixed(1)} lbs`;

                            if (weightSpan) weightSpan.textContent = weightLabel;
                            if (repsSpan) repsSpan.textContent = displayReps;
                            if (hiddenSummary) hiddenSummary.textContent = `Your Max: ${weightLabel} × ${displayReps}`;
                        }
                        // Hide modal
                        const modal = document.getElementById('prModal');
                        modal.classList.remove('show');
                        modal.style.display = 'none';

                        // Show toast
                        const toast = document.getElementById('toastSuccess');
                        toast.textContent = 'Max updated!';
                        toast.style.display = 'block';
                        toast.style.background = "#d1e7dd";
                        toast.style.color = "#0f5132";
                        toast.style.border = '1px solid #5cb85c';

                        setTimeout(() => {
                            toast.style.display = 'none';
                        }, 3000);
                    } else {
                        alert('Error updating max. Please try again.');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Something went wrong.');
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const notesModal = document.getElementById('notesModal');
            const notesTextarea = document.getElementById('notesTextarea');
            const saveNotesBtn = document.getElementById('saveNotesBtn');
            if (!notesModal || !notesTextarea || !saveNotesBtn) {
                return;
            }

            let currentNotesWorkoutId = null;

            document.addEventListener('click', function (e) {
                const trigger = e.target.closest('.edit-notes-btn');
                if (trigger) {
                    e.preventDefault();
                    currentNotesWorkoutId = trigger.dataset.id;
                    const stored = trigger.dataset.notes ? decodeURIComponent(trigger.dataset.notes) : '';
                    notesTextarea.value = stored;
                    notesModal.classList.add('show');
                    notesModal.style.display = 'flex';
                    return;
                }

                if (e.target && e.target.id === 'notesModalClose') {
                    notesModal.classList.remove('show');
                    notesModal.style.display = 'none';
                    currentNotesWorkoutId = null;
                }
            });

            saveNotesBtn.addEventListener('click', async () => {
                if (!currentNotesWorkoutId) {
                    notesModal.classList.remove('show');
                    notesModal.style.display = 'none';
                    return;
                }

                const noteValue = notesTextarea.value || '';
                try {
                    const response = await fetch('/update_notes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ workout_id: currentNotesWorkoutId, notes: noteValue })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        alert(data.error || 'Unable to save notes.');
                        return;
                    }

                    const normalized = data.notes || '';
                    const placeholderHtml = `<span class="text-muted">${escapeHtml(NOTES_PLACEHOLDER)}</span>`;
                    document.querySelectorAll(`.notes-body[data-id="${currentNotesWorkoutId}"]`).forEach(node => {
                        if (normalized.trim()) {
                            node.innerHTML = escapeHtml(normalized).replace(/\n/g, '<br>');
                        } else {
                            node.innerHTML = placeholderHtml;
                        }
                    });
                    document.querySelectorAll(`.edit-notes-btn[data-id="${currentNotesWorkoutId}"]`).forEach(btn => {
                        btn.dataset.notes = encodeURIComponent(normalized);
                        btn.textContent = normalized.trim() ? 'Edit Notes' : 'Add Notes';
                    });

                    const toast = document.getElementById('toastSuccess');
                    if (toast) {
                        toast.textContent = 'Notes saved!';
                        toast.style.display = 'block';
                        toast.style.background = '#d1e7dd';
                        toast.style.color = '#0f5132';
                        toast.style.border = '1px solid #5cb85c';
                        setTimeout(() => {
                            toast.style.display = 'none';
                        }, 3000);
                    }
                } catch (err) {
                    console.error('Error saving notes:', err);
                    alert('Something went wrong while saving notes.');
                    return;
                } finally {
                    notesModal.classList.remove('show');
                    notesModal.style.display = 'none';
                    currentNotesWorkoutId = null;
                }
            });
        });
        </script>
    {% endif %}
</div>
<script>
    (() => {
    'use strict';
    const form = document.getElementById('training-form') || document.querySelector('form.needs-validation');
    if (!form) return;
    form.addEventListener('submit', (e) => {
        if (!form.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        // focus first invalid control
        const firstInvalid = form.querySelector(':invalid');
        if (firstInvalid) firstInvalid.focus();
        }
        form.classList.add('was-validated');
    });
    })();

    document.addEventListener('DOMContentLoaded', () => {
        const checkboxes = document.querySelectorAll('.goal-checkbox');

        function updateCheckboxStates() {
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.disabled = checkedBoxes.length >= 2 && !cb.checked;
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCheckboxStates);
        });

        updateCheckboxStates();
    });

    // Duration pills: update preference without auto-generating workouts
    (function () {
        const pillsWrap = document.getElementById('duration-pills');
        if (!pillsWrap) return;

        const pills = pillsWrap.querySelectorAll('.duration-pill');
        const hiddenInput = document.getElementById('duration-input');
        const categorySelect = document.getElementById('workout-category-select');

        // Helpers to set visual/ARIA state
        function setActive(minutes) {
            pills.forEach(btn => {
            const isActive = String(btn.dataset.minutes) === String(minutes);
            btn.classList.toggle('active', isActive);
        });
        hiddenInput.value = minutes;
        }

        // Click/tap handler
        pills.forEach(btn => {
        btn.addEventListener('click', async () => {
            const minutes = btn.dataset.minutes;
            setActive(minutes);
            handleDurationChange(parseInt(minutes, 10));

            try {
            const res = await fetch('/update_workout_duration', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workout_duration: minutes })
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.error || 'Could not update workout duration.');
                return;
            }

            // Optional toast feedback
            const toast = document.getElementById('toastSuccess');
            if (toast) {
                toast.textContent = 'Duration updated!';
                toast.style.display = 'block';
                toast.style.border = '1px solid #5cb85c';
                setTimeout(() => (toast.style.display = 'none'), 2000);
            }
            } catch (err) {
            console.error(err);
            alert('Network error while updating duration.');
            }
        });
        });
    })();

    function safeParseJSON(value, fallback) {
        if (!value) return Array.isArray(fallback) ? fallback : [];
        try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) return parsed;
            if (parsed && typeof parsed === 'object') return Object.values(parsed);
            return Array.isArray(fallback) ? fallback : [];
        } catch {
            return Array.isArray(fallback) ? fallback : [];
        }
    }

    function normalizeRegionSlug(value) {
        return String(value || '')
            .trim()
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '_')
            .replace(/^_+|_+$/g, '');
    }

    function updateInjuryAlertBanner(skipped) {
        const banner = document.getElementById('injury-alert-banner');
        const message = document.getElementById('injury-alert-message');
        if (!banner || !message) return;

        const tokens = new Set();
        let cardioLimited = false;

        if (skipped && typeof skipped === 'object') {
            (skipped.categories || []).forEach((token) => tokens.add(String(token).toUpperCase()));
            (skipped.subcategories || []).forEach((token) => tokens.add(String(token).toUpperCase()));
            if (skipped.cardio_restriction) cardioLimited = true;
        }

        if (cardioLimited) tokens.add('CARDIO');

        if (!tokens.size) {
            banner.classList.add('d-none');
            message.textContent = 'Your next workouts will consider any restrictions you add here.';
            return;
        }

        const pretty = Array.from(tokens)
            .map((token) => token.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()))
            .join(', ');
        message.textContent = `Skipping ${pretty} exercises based on your restrictions.`;
        banner.classList.remove('d-none');
    }

    function hydrateDefaultInjuryAlert() {
        const banner = document.getElementById('injury-alert-banner');
        if (!banner) return;

        const defaults = {
            categories: safeParseJSON(banner.dataset.defaultCategories, []),
            subcategories: safeParseJSON(banner.dataset.defaultSubcategories, []),
            cardio_restriction: banner.dataset.defaultCardio === 'true',
        };

        updateInjuryAlertBanner(defaults);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const fields = document.getElementById('injury-fields');
        if (!fields) return;

        const yesRadio = document.getElementById('injury-status-yes');
        const noRadio = document.getElementById('injury-status-no');
        const chips = Array.from(fields.querySelectorAll('.injury-chip'));
        const injuryInput = document.getElementById('injury-input');
        const cardioInput = document.getElementById('cardio-restriction');
        const selectedContainer = document.getElementById('injury-selected');
        const textarea = document.getElementById('injury-details');

        const labels = new Map();
        chips.forEach((chip) => labels.set(chip.dataset.region, chip.textContent.trim()));
        const state = { regions: new Set() };

        // --- Helpers ---
        function loadInitialState() {
            const initialRegions = safeParseJSON(fields.dataset.initialRegions, []);
            initialRegions.forEach((region) => {
                const slug = normalizeRegionSlug(region);
                if (slug) state.regions.add(slug);
            });
            if (fields.dataset.cardioPrefill === 'true') state.regions.add('cardio');
        }

        function syncHiddenFields() {
            injuryInput.value = JSON.stringify(Array.from(state.regions));
            const restrictCardio = state.regions.has('cardio');
            cardioInput.value = restrictCardio ? 'yes' : '';
            cardioInput.disabled = false;
        }

        function syncChips() {
            chips.forEach((chip) => {
                const slug = chip.dataset.region;
                const active = state.regions.has(slug);
                chip.classList.toggle('active', active);
                chip.dataset.active = active ? 'true' : 'false';
                chip.setAttribute('aria-pressed', active ? 'true' : 'false');
            });
        }

        function prettyLabel(slug) {
            return labels.get(slug) || slug.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function syncSelectedList() {
            selectedContainer.innerHTML = '';
            if (!state.regions.size) {
                selectedContainer.innerHTML =
                    '<span class="badge bg-secondary-subtle text-muted">No areas selected</span>';
                return;
            }
            state.regions.forEach((slug) => {
                const pill = document.createElement('span');
                pill.className = 'badge injury-pill bg-bitcoin text-dark me-1 mb-1';
                pill.textContent = prettyLabel(slug);
                selectedContainer.appendChild(pill);
            });
        }

        function syncAll() {
            syncHiddenFields();
            syncChips();
            syncSelectedList();
        }

        function clearInjurySection() {
            state.regions.clear();
            syncAll();
            textarea.value = '';
        }

        function toggleInjuryFields(enabled) {
            const wrapper = document.getElementById('injury-fields-wrapper');

            if (wrapper) {
                wrapper.classList.toggle('expanded', enabled);
                wrapper.classList.toggle('collapsed', !enabled);
            }

            // Visually disable content
            fields.classList.toggle('is-disabled', !enabled);

            // Delay disabling interactivity slightly so the fade looks smoother
            setTimeout(() => {
                chips.forEach((chip) => (chip.disabled = !enabled));
                textarea.disabled = !enabled;
            }, 200);

            // Clear if switching to "No"
            if (!enabled) clearInjurySection();
        }

        function toggleRegion(slug) {
            const normalized = normalizeRegionSlug(slug);
            if (!normalized) return;
            if (state.regions.has(normalized)) state.regions.delete(normalized);
            else state.regions.add(normalized);
            syncAll();
        }

        // --- Bind Events ---
        chips.forEach((chip) => {
            chip.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleRegion(chip.dataset.region);
            });
            chip.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleRegion(chip.dataset.region);
                }
            });
        });

        yesRadio.addEventListener('change', () => yesRadio.checked && toggleInjuryFields(true));
        noRadio.addEventListener('change', () => noRadio.checked && toggleInjuryFields(false));

        // --- Initialize ---
        loadInitialState();
        syncAll();

        // Prevent flicker — initialize *after* DOM paints
        requestAnimationFrame(() => {
            toggleInjuryFields(!!(yesRadio && yesRadio.checked));
        });

        hydrateDefaultInjuryAlert();
    });
</script>   
{% endblock %}
