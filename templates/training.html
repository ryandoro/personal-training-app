{% extends "layout.html" %}

{% block title %}
    Personal Training
{% endblock %}

{% block content %}
<div class="container-fluid training-container px-0">
    {% if not form_completed %}   
        <div class="card shadow p-4 mb-5 rounded">
            <div class="card-body">
                <h3 class="card-title text-center fw-bold mb-4">Welcome to your personalized training journey!</h3>
            
                <p>
                    Hey, it’s me Ryan — thanks for trusting me to guide you on this incredible journey to becoming the strongest, healthiest version of yourself. There’s no one-size-fits-all approach to health, but I’ve built a simple, effective roadmap tailored to your unique goals and starting point.
                </p>
            
                <p>
                    <strong>These foundational exercises and instructions will help you move better, look better, and feel amazing.</strong> Your body is the only vehicle you’ve got — and we're going to take great care of it.
                </p>
            
                <p>
                    Be consistent, stay hydrated, fuel your body right, and have some fun with it! If you ever have questions, I’m here for you. Let’s get to work — your results start now!
                </p>
            
                <hr class="my-4">
            
                <h5 class="fw-semibold mb-3 text-center">How It Works</h5>
            
                <div class="row text-start">
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 1:</strong> Fill out your training questionnaire below so I can learn about your goals and fitness level.
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 2:</strong> Get a personalized workout plan tailored just for you.
                        </div>
                    </div>
                    <div class="col-md-4 mb-2">
                        <div class="p-3 border rounded bg-light shadow-sm h-100">
                            <strong>Step 3:</strong> Track your progress on the homepage as you grow stronger and achieve your goals. Let's do this!
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow p-4 bg-light rounded mb-5">
            <h4 class="text-center fw-bold mb-4">Personal Training Questionnaire</h4>
            <div class="card-body">
                <form action="/training" method="post" class="needs-validation" novalidate>
                    <!-- Name -->
                    <div class="mb-3">
                        <label for="name" class="form-label fw-bold">First Name</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Enter your first name" required>
                    </div>
                    
                    <!-- Last Name -->
                    <div class="mb-3">
                        <label for="last_name" class="form-label fw-bold">Last Name</label>
                        <input type="text" class="form-control" id="last_name" name="last_name" placeholder="Enter your last name" required>
                    </div>

                    <!-- Age -->
                    <div class="mb-3">
                        <label for="age" class="form-label fw-bold">Age (Years)</label>
                        <input type="number" class="form-control" id="age" name="age" placeholder="Enter your age" required>
                    </div>

                    <!-- Weight -->
                    <div class="mb-3">
                        <label for="weight" class="form-label fw-bold">Weight (Pounds)</label>
                        <input type="number" class="form-control" id="weight" name="weight" placeholder="Enter your weight in pounds" required>
                    </div>

                    <!-- Height -->
                    <div class="mb-3 row">
                        <label class="form-label fw-bold">Height</label>
                        <div class="col">
                            <input type="number" class="form-control" id="height-feet" name="height_feet" placeholder="Feet" min="0" required>
                        </div>
                        <div class="col">
                            <input type="number" class="form-control" id="height-inches" name="height_inches" placeholder="Inches" min="0" max="11" required>
                        </div>
                    </div>

                    <!-- Gender -->
                    <div class="mb-3">
                        <label class="form-label fw-bold d-block">Gender</label>
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" id="male" name="gender" value="Male" required>
                            <label class="form-check-label" for="male">Male</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" id="female" name="gender" value="Female" required>
                            <label class="form-check-label" for="female">Female</label>
                        </div>
                    </div>

                    <!-- Exercise History -->
                    <div class="mb-3">
                        <label for="exercise-history" class="form-label fw-bold">Exercise History</label>
                        <select class="form-select" id="exercise-history" name="exercise_history" required>
                            <option value="" disabled selected>Select an option</option>
                            <option value="No Exercise History">No Exercise History</option>
                            <option value="Exercise less than 1 year">Exercise less than 1 year</option>
                            <option value="Exercise 1-5 years">Exercise 1-5 years</option>
                            <option value="Exercise 5+ years">Exercise 5+ years</option>
                        </select>
                    </div>

                    <!-- Fitness Goals -->
                    <div class="mb-3">
                        <label class="form-label fw-bold d-block">Fitness Goals <small>(Select up to 2)</small></label>
                        <small class="text-muted d-block mb-2">
                            We recommend selecting 1 or 2 goals to help keep your training focused and effective.
                        </small>

                        <!-- Goal Checkboxes -->
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="lose-weight" name="fitness_goals" value="Lose Weight">
                            <label class="form-check-label" for="lose-weight">Lose Weight</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="gain-muscle" name="fitness_goals" value="Gain Muscle">
                            <label class="form-check-label" for="gain-muscle">Gain Muscle</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="tone-muscle" name="fitness_goals" value="Tone Muscle">
                            <label class="form-check-label" for="tone-muscle">Tone Muscle</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="abs" name="fitness_goals" value="Abs">
                            <label class="form-check-label" for="abs">Abs</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="strength" name="fitness_goals" value="Increase Strength">
                            <label class="form-check-label" for="strength">Increase Strength</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="endurance" name="fitness_goals" value="Increase Endurance">
                            <label class="form-check-label" for="endurance">Increase Endurance</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input goal-checkbox" id="feel-better" name="fitness_goals" value="Feel Better">
                            <label class="form-check-label" for="feel-better">Feel Better</label>
                        </div>
                    </div>

                    <!-- Injury or Illness -->
                    <div class="mb-3">
                        <label class="form-label fw-bold d-block">Do you have, or have you had any recent injuries or illnesses?</label>
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" id="injury-yes" name="injury" value="Yes" required>
                            <label class="form-check-label" for="injury-yes">Yes</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio" class="form-check-input" id="injury-no" name="injury" value="No" required>
                            <label class="form-check-label" for="injury-no">No</label>
                        </div>
                    </div>

                    <!-- Injury/Illness Details -->
                    <div class="mb-3">
                        <label for="injury-details" class="form-label fw-bold">If yes, please describe your injury/illness:</label>
                        <textarea class="form-control" id="injury-details" name="injury_details" rows="3"></textarea>
                    </div>

                    <!-- Commitment -->
                    <div class="mb-3">
                        <label for="commitment" class="form-label fw-bold">How many days per week are you willing to commit to your goals?</label>
                        <select class="form-select" id="commitment" name="commitment" required>
                            <option value="" disabled selected>Select an option</option>
                            <option value="1 day per week">1 day per week</option>
                            <option value="2 days per week">2 days per week</option>
                            <option value="3 days per week">3 days per week</option>
                        </select>
                    </div>

                    <!-- Additional Notes -->
                    <div class="mb-3">
                        <label for="additional-notes" class="form-label fw-bold">Anything else you'd like to share?</label>
                        <textarea class="form-control" id="additional-notes" name="additional_notes" rows="3"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100">Submit</button>
                </form>
            </div>        
    {% else %} <!-- Show guidelines and workout options after the form is submitted -->
        <!-- Guidelines Box -->
        {% if guidelines %}
        <div class="card w-100 mx-auto shadow-sm p-3 border border-2 rounded-3 mb-4" style="border-color: #ced4da;">
            <div class="card-body">
                <h4 class="card-title text-center mb-3">Guidelines</h4>
        
                {% set goal_list = fitness_goals.split(',') %}
                <p>
                    Based on your selected goal{{ goal_list | length > 1 and 's' or '' }} —
                    <strong>
                        {% for goal in goal_list %}
                            {{ goal.strip() }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </strong> — here are your recommended targets per exercise:
                </p>
        
                <ul class="list-group p-2 border border-2 rounded-3 mb-4" style="border-color: #ced4da;">
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Sets:</strong> {{ guidelines.Sets }}
                    </li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Repetitions:</strong> {{ guidelines.Reps }}
                    </li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Rest Between Sets:</strong> {{ guidelines.Rest }}
                    </li>
                </ul>
        
                <p class="text-muted small">
                    These ranges reflect the combination of your selected goals. Adjust within the range based on how you feel each day.
                </p>
                <details class="mb-3">
                    <summary class="text-primary" style="cursor: pointer;"><strong>Pro Tip 💡</strong></summary>
                    <p class="mt-2 mb-0">
                        To get the best results, aim for the lower end of the rest range and the higher end of the sets and 
                        repetitions <strong>when you're feeling strong and well-recovered</strong>. Your effort should feel like an 
                        <strong>8 out of 10</strong> — challenging, but doable with good form. If things start to feel too easy within the guidelines,
                        increase the weight or difficulty of the exercise, or shift to a different part of the rep range or time target than you used last time. 
                        That’s where real results are made: consistent, focused effort.
                    </p>
                </details>

                <ul class="list-group p-2 border border-2 rounded-3" style="border-color: #ced4da;">
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Resistance Training:</strong> At least 2 non-consecutive days per week, targeting all major muscle groups.
                    </li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Cardio Training:</strong> Minimum 3 days per week. Start with 10 minutes per session and build up to 20–30 minutes as you progress.
                    </li>
                </ul>
            </div>
        </div>
        {% endif %}
        


        <hr>
        <div class="mb-4">
            <h3 class="text-center mb-3 fw-bold">Choose Your Workout</h3>
            <div class="row justify-content-center">
                <div class="mb-3">
                    <label for="workout-category-select" class="form-label fw-bold text-primary">Workout Categories</label>
                    <select id="workout-category-select" class="form-select shadow-sm border-primary">
                        <option value="">-- Select a Workout Category --</option>
                        {% for category, workouts in grouped_workouts.items() %}
                            <option value="{{ category }}">{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>                
            </div>
        </div> 
        <hr> 

        <div id="workout-details" class="mt-4">
            {% for category, workouts in grouped_workouts.items() %}
            <div id="{{ category|replace(' ', '-')|lower }}-workouts" class="d-none">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="m-0">{{ category }}</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group">
                            {% for workout in workouts %}
                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">{{ workout[0] }}</div>
                                        <p class="small text-muted">{{ workout[1] }}</p>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-4">
            <button id="complete-workout-btn" class="btn btn-success btn-lg mb-2 mx-auto" style="display: none;">
                Complete Workout
            </button>
            <div id="progress-tracking-note" class="text-muted small text-center mb-2" style="display: none;">
                <em>After clicking Complete Workout, you’ll be able to track your progress and view past workouts from the homepage.</em>
            </div>
        </div>
        <hr>

        <script>
            const categorySelect = document.getElementById('workout-category-select');
            const workoutDetails = document.getElementById('workout-details');
            const completeWorkoutBtn = document.getElementById('complete-workout-btn');
        
            // Initially hide the "Complete Workout" button and progress tracking note 
            completeWorkoutBtn.style.display = 'none';
            document.getElementById('progress-tracking-note').style.display = 'none';

        
            categorySelect.addEventListener('change', async () => {
                const selectedCategory = categorySelect.value;
        
                // Hide all workout details
                document.querySelectorAll('#workout-details > div').forEach(div => div.classList.add('d-none'));
        
                if (selectedCategory) {
                    try {
                        // Fetch generated workout
                        const response = await fetch(`/generate_workout?category=${encodeURIComponent(selectedCategory)}`);
                        const data = await response.json();
        
                        if (data.success) {
                            // Update the DOM with generated workouts
                            const categoryDiv = document.getElementById(
                                `${selectedCategory.replaceAll(' ', '-').toLowerCase()}-workouts`
                            );
                            categoryDiv.innerHTML = `
                                <div class="card w-100 mb-4 shadow-sm p-3 border border-3 rounded-2" style="border-color: #ced4da;">
                                    <div class="card-header shadow p-3 fitbaseblue-bg text-white">
                                        <h5 class="m-0 text-uppercase">${selectedCategory}</h5>
                                    </div>
                                    <div class="card-body px-0">
                                        <ul class="list-group">
                                            ${data.workout
                                                .map(
                                                    subcategory => `
                                                    <li class="list-group-item">
                                                        <div class="card w-100 shadow-sm p-3 border border-2 rounded-3" style="border-color: #ced4da;">
                                                            <h6 class="fitbaseblue-text fw-bold fs-5 mb-3">${subcategory.subcategory}</h6>
                                                            <div class="px-0">
                                                                <ul class="list-unstyled mt-2">
                                                                    ${subcategory.exercises
                                                                        .map(
                                                                            exercise => `
                                                                                <li class="mb-4">
                                                                                    <div class="card shadow p-3 text-center border border-1 rounded-4 w-100" style="border-color: #20c997;">
                                                                                        <h6 class="fw-bold mb-3 text-uppercase" style="color: #F7931A; border-bottom: 2px solid #4D4D4D; display: inline-block; padding-bottom: 2px;">${exercise.name}</h6>
                                                                                        <div class="d-flex justify-content-center flex-nowrap gap-3 mb-3 px-2">
                                                                                            <div class="d-flex flex-column align-items-center">
                                                                                                <p class="mb-1 fw-semibold">Start:</p>
                                                                                                <img src="/static/images/${exercise.image_exercise_start}" 
                                                                                                    alt="Start: ${exercise.name}" 
                                                                                                    class="clickable-img rounded border border-2 p-1 shadow-sm"
                                                                                                    data-group="${exercise.name}" data-index="0" 
                                                                                                    style="border-color: #20c997; width: 100%; max-width: 140px;">
                                                                                            </div>
                                                                                            <div class="d-flex flex-column align-items-center">
                                                                                                <p class="mb-1 fw-semibold">End:</p>
                                                                                                <img src="/static/images/${exercise.image_exercise_end}" 
                                                                                                    alt="End: ${exercise.name}" 
                                                                                                    class="clickable-img rounded border border-2 p-1 shadow-sm"
                                                                                                    data-group="${exercise.name}" data-index="1" 
                                                                                                    style="border-color: #20c997; width: 100%; max-width: 140px;">
                                                                                            </div>
                                                                                        </div>

                                                                                        ${exercise.youtube_id ? (
                                                                                        `<p class="fw-semibold mb-1">Video Demonstration:</p>
                                                                                        <div class="d-flex justify-content-center mb-3 px-2">
                                                                                            <div style="width: 100%; max-width: 240px;">
                                                                                                <div class="bg-light rounded border shadow-sm mb-3 mx-auto" style="border-color: #20c997; padding: 5px; max-width: 240px;">
                                                                                                    <iframe
                                                                                                        style="border-color: #20c997; width: 100%; aspect-ratio: 9 / 16; border: none; display: block;"
                                                                                                        src="https://www.youtube.com/embed/${exercise.youtube_id}?playsinline=1&modestbranding=1&rel=0"
                                                                                                        title="FitBase Demo"
                                                                                                        frameborder="0"
                                                                                                        allow="fullscreen; accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                                                                                        allowfullscreen
                                                                                                    ></iframe>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>`
                                                                                        ) : ''}

                                                                                        <div class="personal-best bg-light p-3 rounded text-center mb-3 shadow-sm border border-2 mx-auto d-block" style="border-color: #20c997; width: fit-content;" data-id="${exercise.workout_id}">
                                                                                            <small class="text-muted d-block mb-1">Your Max:</small>
                                                                                            <div class="fw-bold personal-max-text">
                                                                                                ${exercise.name.toLowerCase().includes('bodyweight') || exercise.max_weight === 0
                                                                                                    ? 'Bodyweight'
                                                                                                    : (exercise.max_weight
                                                                                                        ? `${parseFloat(exercise.max_weight).toFixed(1)} lbs`
                                                                                                        : '–')
                                                                                                } × 
                                                                                                ${exercise.max_reps ? `${exercise.max_reps} reps` : '–'}
                                                                                            </div>
                                                                                            <button class="btn btn-outline-primary btn-sm mt-2 update-pr-link" data-id="${exercise.workout_id}">
                                                                                                Update Max
                                                                                            </button>
                                                                                        </div>
                                                                                        <div class="text-center">
                                                                                            <button class="btn btn-outline-primary btn-sm mt-2 toggle-description" data-id="desc-${subcategory.subcategory.replace(/\s+/g, '-')}-${exercise.workout_id}">
                                                                                                View Description
                                                                                            </button>
                                                                                            <div id="desc-${subcategory.subcategory.replace(/\s+/g, '-')}-${exercise.workout_id}" class="description text-muted mt-2" style="display: none;">
                                                                                                ${exercise.description}
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                </li>`
                                                                        )
                                                                        .join('')}
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </li>
                                                `
                                                )
                                                .join('')}
                                        </ul>
                                    </div>
                                </div>
                            `;
                            categoryDiv.classList.remove('d-none');

                            bindImageClickEvents();
        
                            // Show the "Complete Workout" button and progress tracking note 
                            completeWorkoutBtn.style.display = 'block';
                            document.getElementById('progress-tracking-note').style.display = 'block';

        
                            // Attach the selected category to the button's dataset for later use
                            completeWorkoutBtn.dataset.category = selectedCategory;
                        } else {
                            alert('Could not generate workout. Please try again.');
                            completeWorkoutBtn.style.display = 'none'; // Hide the button if no workout is generated
                        }
                    } catch (err) {
                        console.error('Error fetching workout:', err);
                        completeWorkoutBtn.style.display = 'none'; // Hide the button on error
                    }
                } else {
                    completeWorkoutBtn.style.display = 'none'; // Hide the button if no category is selected
                    document.getElementById('progress-tracking-note').style.display = 'none'; // Hide the progress tracking note if no category is selected
                }
            });
        
            // Handle the "Complete Workout" button click
            completeWorkoutBtn.addEventListener('click', async () => {
                try {
                    // Get the selected category from the dropdown
                    const selectedCategory = document.getElementById('workout-category-select').value;

                    if (!selectedCategory) {
                        alert('Please select a workout category before completing the workout.');
                        return;
                    }

                    // Send the category in the request body
                    const response = await fetch('/complete_workout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // Set content type to JSON
                        },
                        body: JSON.stringify({ category: selectedCategory }) // Include the selected category
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Workout marked as complete!');
                        window.location.href = '/';
                    } else {
                        alert(data.error || 'An error occurred. Please try again.');
                    }
                } catch (err) {
                    console.error('Error completing workout:', err);
                    alert('An error occurred. Please try again.');
                }
            });
        </script>

        <!-- Success Toast -->
        <div id="toastSuccess" class="text-success text-center fw-bold"
            style="display: none; position: fixed; top: 65px; left: 50%; transform: translateX(-50%);
                z-index: 10000; background: #d4edda; padding: 10px 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.2);">
            Max updated!
        </div>

        <!-- Max Update Modal -->
        <div id="prModal" class="modal"
            style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center;">
            <div class="bg-white p-4 rounded shadow" style="width: 90%; max-width: 400px; position: relative;">
                <button id="prModalClose" class="btn-close" style="position: absolute; top: 10px; right: 10px;"></button>
                <h5 class="mb-3">Update Max</h5>
                <input type="number" id="maxWeightInput" class="form-control mb-2" placeholder="Max Weight (lbs)" title="Bodyweight exercises do not require a weight entry">
                <input type="number" id="maxRepsInput" class="form-control mb-3" placeholder="Max Reps">
                <button id="submitPrBtn" class="btn btn-primary w-100 mb-2">Save</button>
            </div>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" style="
            display:none; 
            position:fixed; 
            inset:0; 
            z-index:9999; 
            background:rgba(0,0,0,0.8);
        ">
            <div id="modalContent" style="
                position: relative; 
                width: 100%; 
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
            ">
                <span id="modalClose" style="
                    position: absolute; 
                    top: 16px; 
                    right: 30px; 
                    font-size: 1.2rem; 
                    color: rgba(220, 220, 220, 0.85); 
                    background-color: rgba(0, 0, 0, 0.6);
                    border-radius: 50%;
                    width: 25px;
                    height: 25px;
                    line-height: 25px;
                    text-align: center;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer; 
                    z-index: 10001;
                ">&times;</span>
        
                <img id="modalImage" style="
                    max-width: 90%; 
                    max-height: 90%; 
                    cursor: pointer;
                ">
        
                <div id="swipeOverlay" style="
                    margin-top: 12px;
                    text-align: center;
                    color: rgba(220, 220, 220, 0.8);
                    font-size: 1.1rem;
                    font-weight: bold;
                    opacity: 0.85;
                    text-shadow: 0 0 8px rgba(0,0,0,0.8);
                    pointer-events: none;
                    transition: opacity 0.5s ease;
                    z-index: 10000;
                ">&lt;&nbsp;&nbsp;&nbsp;&gt;</div>
            </div>
        </div>
        
            
        <script>
        // Toggle Description JS 
        document.addEventListener('click', function (e) {
            const toggle = e.target.closest('.toggle-description');
            if (!toggle) return;

            e.preventDefault();
            const descId = toggle.getAttribute('data-id');
            const descElement = document.getElementById(descId);

            if (!descElement) {
                console.warn("No element found for ID:", descId);
                return;
            }

            const isHidden = descElement.style.display === 'none' || descElement.style.display === '';

            if (isHidden) {
                // Slide down
                descElement.style.display = 'block';
                descElement.style.maxHeight = '0px';
                descElement.style.overflow = 'hidden';
                descElement.style.transition = 'max-height 0.3s ease-out';
                setTimeout(() => {
                    descElement.style.maxHeight = descElement.scrollHeight + 'px';
                }, 10);
                toggle.textContent = 'Hide Description';
            } else {
                // Slide up
                descElement.style.maxHeight = '0px';
                setTimeout(() => {
                    descElement.style.display = 'none'; 
                }, 300); // Match the transition duration
                toggle.textContent = 'View Description';
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            bindImageClickEvents();
        });

        // Clickable Image JS 
        function bindImageClickEvents() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            let currentGroup = null;
            let currentIndex = 0;
            let groupImages = [];

            document.querySelectorAll('.clickable-img').forEach(img => {
                img.addEventListener('click', () => {
                    console.log('Image clicked:', img.src);
                    console.log('Group:', img.dataset.group);
                    console.log('Index:', img.dataset.index);

                    currentGroup = img.dataset.group;
                    currentIndex = parseInt(img.dataset.index);
                    groupImages = Array.from(document.querySelectorAll(`.clickable-img[data-group="${currentGroup}"]`));
                    const selectedImage = groupImages[currentIndex];
                    console.log('Selected image for modal:', selectedImage);

                    showModal(selectedImage?.src || '');
                });
            });

            function showModal(src) {
                console.log('Opening modal with image src:', src);  // Add this
                if (!src) {
                    console.warn('Modal image src is missing!');
                    return;
                }
                modalImg.src = src;
                modal.style.display = 'block';
            }

            function hideModal() {
                modal.style.display = 'none';
            }

            modal.addEventListener('click', hideModal);
            modalImg.addEventListener('click', hideModal); // tap image to close

            // Swipe support
            let touchStartX = 0;

            modal.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            modal.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const deltaX = touchEndX - touchStartX;

                if (Math.abs(deltaX) > 50) {
                    // swipe left/right
                    if (deltaX > 0) {
                        // swipe right: previous
                        currentIndex = (currentIndex - 1 + groupImages.length) % groupImages.length;
                    } else {
                        // swipe left: next
                        currentIndex = (currentIndex + 1) % groupImages.length;
                    }
                    showModal(groupImages[currentIndex].src);
                }
            });
        }


        // Video Clickable JS 
        document.addEventListener('click', function (e) {
            const video = e.target;
            if (video.tagName === 'VIDEO' && video.classList.contains('video-clickable')) {
                if (video.requestFullscreen) {
                    video.requestFullscreen();
                } else if (video.webkitRequestFullscreen) {
                    video.webkitRequestFullscreen();
                } else if (video.msRequestFullscreen) {
                    video.msRequestFullscreen();
                }
            }
        });


        // Update Max JS 
        document.addEventListener('DOMContentLoaded', function () {
            let currentWorkoutId = null;

            // Open modal when clicking "Update Max"
            document.addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('update-pr-link')) {
                    e.preventDefault();

                    currentWorkoutId = e.target.dataset.id;
                    const container = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"] .personal-max-text`);
                    const [weightText, repsText] = container.textContent.split('×').map(val => val.trim());

                    const isBodyweight = weightText.toLowerCase().includes('bodyweight');

                    const weightInput = document.getElementById('maxWeightInput');
                    weightInput.value = isBodyweight ? '' : (parseFloat(weightText) || '');
                    weightInput.disabled = isBodyweight;
                    weightInput.placeholder = isBodyweight 
                        ? 'Bodyweight exercise' 
                        : 'Max Weight (lbs)';
                    weightInput.title = weightInput.placeholder;

                    document.getElementById('maxRepsInput').value = parseInt(repsText) || '';


                    document.getElementById('prModal').classList.add('show');
                }

                // Close modal when clicking the "X" button
                if (e.target.id === 'prModalClose') {
                    document.getElementById('prModal').classList.remove('show');
                }
            });

            // Handle modal "Save" button
            document.getElementById('submitPrBtn').addEventListener('click', function () {
                const maxWeightInput = document.getElementById('maxWeightInput');
                const maxWeight = parseFloat(maxWeightInput.value);
                const maxReps = parseInt(document.getElementById('maxRepsInput').value);

                // Validation: allow 0 weight if it's a bodyweight exercise (disabled input)
                if (isNaN(maxReps) || (maxWeightInput.disabled === false && isNaN(maxWeight))) {
                    alert("Please enter valid values.");
                    return;
                }

                fetch('/update_pr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workout_id: currentWorkoutId,
                        max_weight: maxWeight,
                        max_reps: maxReps
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const container = document.querySelector(`.personal-best[data-id="${currentWorkoutId}"] .personal-max-text`);
                        if (container) {
                            const displayWeight = document.getElementById('maxWeightInput').disabled
                                ? 'Bodyweight'
                                : `${parseFloat(document.getElementById('maxWeightInput').value).toFixed(1)} lbs`;

                            container.textContent = `${displayWeight} × ${maxReps} reps`;
                        }
                        // Hide modal
                        document.getElementById('prModal').classList.remove('show');
                        document.getElementById('prModal').style.display = 'none';

                        // Show toast
                        const toast = document.getElementById('toastSuccess');
                        toast.style.display = 'block';

                        setTimeout(() => {
                            toast.style.display = 'none';
                        }, 2000);
                    } else {
                        alert('Error updating max. Please try again.');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Something went wrong.');
                });
            });
        });
        </script>
        
        <!-- Target Heart Rate Zone -->
        {% if target_heart_rate_zone %}
        <div class="card w-100 mx-auto shadow-sm p-3 border border-2 rounded-3 mb-4" style="border-color: #ced4da;">
            <div class="card-body">
                <h4 class="card-title text-center mb-3">Your Target Heart Rate Zone</h4>
                <p class="card-text">
                    Based on your age, the recommended heart rate ranges for your optimal cardiovascular activity are:
                </p>
                
                <ul class="list-group p-2 border border-2 rounded-3 mb-3" style="border-color: #ced4da;">
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Target Heart Rate Zone:</strong> {{ target_heart_rate_zone.lower_bound }} - {{ target_heart_rate_zone.upper_bound }} bpm
                    </li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4" style="border-color: #20c997; background-color: #ffffff;">
                        <strong>Maximum Heart Rate:</strong> {{ target_heart_rate_zone.max_heart_rate }} bpm
                    </li>
                </ul>

                <p class="mt-3 text-muted">
                    Try to keep your heart rate in the middle of your target heart rate zone. Track your heart rate during cardio exercises to stay within this range. Use gym equipment monitors
                    or a smartwatch like a Fitbit, Garmin, or Apple Watch.
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Key Section -->
        <div class="card w-100 mx-auto shadow-sm p-3 border border-2 rounded-3 mb-4" style="border-color: #ced4da;">
            <div class="card-body">
                <h4 class="card-title text-center mb-3">Key</h4>
                
                <h5><strong>5 Point Rule:</strong></h5>
                <ul class="list-group p-2 border border-2 rounded-3 mb-4" style="border-color: #ced4da;">
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">1. Left foot flat on the floor</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">2. Right foot flat on the floor</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">3. Butt on bench</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">4. Upper back on bench</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4" style="border-color: #20c997; background-color: #ffffff;">5. Head on bench</li>
                </ul>
        
                <h5><strong>4 Point Rule:</strong></h5>
                <ul class="list-group p-2 border border-2 rounded-3" style="border-color: #ced4da;">
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">1. Left foot flat on the floor</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">2. Right foot flat on the floor</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4 mb-3" style="border-color: #20c997; background-color: #ffffff;">3. Butt on bench</li>
                    <li class="list-group-item shadow-sm p-3 border border-1 rounded-4" style="border-color: #20c997; background-color: #ffffff;">4. Chest/back on pad</li>
                </ul>
            </div>
        </div>
    {% endif %}
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const checkboxes = document.querySelectorAll('.goal-checkbox');

        function updateCheckboxStates() {
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.disabled = checkedBoxes.length >= 2 && !cb.checked;
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCheckboxStates);
        });

        updateCheckboxStates();
    });
</script>    
{% endblock %}


