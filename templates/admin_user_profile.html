{% extends "layout.html" %}

{% block title %}
Edit User Profile
{% endblock %}

{% block content %}
<div class="container">
  <div class="card w-100 shadow-sm border border-2 rounded-3 mt-4 mb-4" style="border-color:#ced4da;">
    <div class="card-body p-4">

      <!-- Header / Summary -->
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
        <div class="d-flex align-items-center gap-3">
          <!-- Avatar (initials) -->
          <div class="rounded-circle d-flex align-items-center justify-content-center"
               style="width:56px;height:56px;background:#e9ecef;font-weight:700;">
            {{ (user.name or '')[:1] ~ (user.last_name or '')[:1] or 'U' }}
          </div>

          <div>
            <h3 class="mb-1">
              {{ user.name or 'Unknown' }} {{ user.last_name or '' }}
              <small class="text-muted d-block d-md-inline ms-md-2">@{{ user.username }}</small>
            </h3>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <!-- Role -->
              <span class="badge
                {% if user.role == 'admin' %} bg-danger
                {% elif user.role == 'trainer' %} bg-primary
                {% else %} bg-secondary
                {% endif %}">
                <i class="bi bi-person-badge me-1"></i>{{ (user.role or 'user')|capitalize }}
              </span>

              <!-- Subscription -->
              <span class="badge
                {% if user.subscription_type == 'premium' %} bg-success
                {% elif user.subscription_type == 'pro' %} bg-warning text-dark
                {% else %} bg-secondary
                {% endif %}">
                <i class="bi bi-gem me-1"></i>{{ (user.subscription_type or 'free')|capitalize }}
              </span>

              <!-- Email verified -->
              {% if user.email_verified %}
                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Email Verified</span>
              {% else %}
                <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Email Not Verified</span>
              {% endif %}

              <!-- Form completed -->
              {% if user.form_completed %}
                <span class="badge bg-success"><i class="bi bi-clipboard-check me-1"></i>Questionnaire Complete</span>
              {% else %}
                <span class="badge bg-secondary"><i class="bi bi-clipboard-x me-1"></i>Questionnaire Pending</span>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2">
          <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
          </a>
          <button type="submit" form="admin-user-form" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>Update User
          </button>
        </div>
      </div>

      <!-- Admin Actions: Invite & Account State -->
        <div class="d-flex flex-wrap gap-2 mt-2">
            <!-- Resend Invite (email) -->
            <form method="POST" action="{{ url_for('admin_resend_invite', user_id=user.id) }}" class="d-inline">
            <button class="btn btn-outline-primary"
                    {% if user.status not in ['invited','pending'] %}disabled title="Only for invited or pending users"{% endif %}>
                <i class="bi bi-envelope me-1"></i>Resend Invite
            </button>
            </form>
        
            <!-- Copy Invite Link (no email) -->
            <form method="POST" action="{{ url_for('admin_copy_invite', user_id=user.id) }}" class="d-inline">
            <button class="btn btn-outline-primary"
                    {% if user.status not in ['invited','pending'] %}disabled title="Only for invited or pending users"{% endif %}>
                <i class="bi bi-link-45deg me-1"></i>Copy Invite Link
            </button>
            </form>
        
            <!-- Disable / Reactivate -->
            {% if user.status == 'disabled' %}
            <form method="POST" action="{{ url_for('admin_reactivate_user', user_id=user.id) }}" class="d-inline">
                <button class="btn btn-success">
                <i class="bi bi-unlock me-1"></i>Reactivate
                </button>
            </form>
            {% else %}
            <form method="POST" action="{{ url_for('admin_disable_user', user_id=user.id) }}" class="d-inline"
                    onsubmit="return confirm('Disable this user? This will sign them out.');">
                <button class="btn btn-outline-danger">
                <i class="bi bi-lock me-1"></i>Disable
                </button>
            </form>
            {% endif %}
        </div>
        
        {% if invite_url %}
            <div class="alert alert-info mt-3" role="alert">
            Invite link created:
            <input type="text" class="form-control mt-2" value="{{ invite_url }}" readonly onclick="this.select()">
            <div class="form-text">Share this link directly. It expires in {{ invite_expires_in or '72 hours' }}.</div>
            </div>
        {% endif %}
  
      <form id="admin-user-form" method="POST">
        {% set injury_status_value = injury_status or 'No' %}
        {% set injury_regions_json = (injury_regions | default([], true)) | tojson %}
        {% set cardio_checked = cardio_restriction %}
        {% set chip_region_slugs = ['neck','shoulders','upper_back','lower_back','elbows','wrists','hips','knees','ankles','cardio'] %}
        <div class="row g-4">

          <!-- Account -->
          <div class="col-12">
            <h5 class="mb-3"><i class="bi bi-person-lines-fill me-2"></i>Account Info</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <input type="text" class="form-control" name="username" value="{{ user.username }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" value="{{ user.email or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">First Name</label>
                <input type="text" class="form-control" name="name" value="{{ user.name or '' }}">
              </div>
              <div class="col-md-6">
                <label class="form-label">Last Name</label>
                <input type="text" class="form-control" name="last_name" value="{{ user.last_name or '' }}">
              </div>
            </div>
          </div>

          <!-- Status & Access -->
          <div class="col-12">
            <hr class="my-2">
            <h5 class="mb-3"><i class="bi bi-shield-lock me-2"></i>Status & Access</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Role</label>
                <select class="form-select" name="role">
                  <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                  <option value="trainer" {% if user.role == 'trainer' %}selected{% endif %}>Trainer</option>
                  <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Subscription</label>
                <select class="form-select" name="subscription_type">
                  <option value="free" {% if user.subscription_type == 'free' %}selected{% endif %}>Free</option>
                  <option value="premium" {% if user.subscription_type == 'premium' %}selected{% endif %}>Premium</option>
                  <option value="pro" {% if user.subscription_type == 'pro' %}selected{% endif %}>Pro</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Assigned Trainer</label>
                <select class="form-select" name="trainer_id">
                  <option value="" {% if not user.trainer_id %}selected{% endif %}>No Trainer</option>
                  {% for trainer in trainers %}
                    <option value="{{ trainer.id }}" {% if user.trainer_id == trainer.id %}selected{% endif %}>
                      {% if trainer.name or trainer.last_name %}
                        {{ trainer.name or '' }} {{ trainer.last_name or '' }}
                      {% else %}
                        @{{ trainer.username }}
                      {% endif %}
                      {% if trainer.role == 'admin' %} (Admin){% else %} (Trainer){% endif %}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 d-flex align-items-center gap-2">
                <input type="checkbox" class="form-check-input" id="email_verified" name="email_verified"
                       {% if user.email_verified %}checked{% endif %}>
                <label for="email_verified" class="form-check-label">Email Verified</label>
              </div>

              <div class="col-md-6 d-flex align-items-center gap-2">
                <input type="checkbox" class="form-check-input" id="form_completed" name="form_completed"
                       {% if user.form_completed %}checked{% endif %}>
                <label for="form_completed" class="form-check-label">Questionnaire Completed</label>
              </div>
            </div>
          </div>

          <!-- Profile (Vitals) -->
          <div class="col-12">
            <hr class="my-2">
            <h5 class="mb-3"><i class="bi bi-activity me-2"></i>Vitals</h5>
            <div class="row g-3">
              <div class="col-6 col-md-3">
                <label class="form-label">Age (years)</label>
                <input type="number" class="form-control" name="age" value="{{ user.age or '' }}">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Weight (lbs)</label>
                <input type="number" class="form-control" name="weight" value="{{ user.weight or '' }}">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Height (ft)</label>
                <input type="number" class="form-control" name="height_feet" value="{{ user.height_feet or '' }}">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Height (in)</label>
                <input type="number" class="form-control" name="height_inches" value="{{ user.height_inches or '' }}">
              </div>

              <div class="col-md-6">
                <label class="form-label d-block">Gender</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="gender-male" value="Male" {% if user.gender == 'Male' %}checked{% endif %}>
                  <label class="form-check-label" for="gender-male">Male</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="gender" id="gender-female" value="Female" {% if user.gender == 'Female' %}checked{% endif %}>
                  <label class="form-check-label" for="gender-female">Female</label>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Exercise History</label>
                <select class="form-select" name="exercise_history">
                  <option value="" disabled>Select an option</option>
                  {% for option in ['No Exercise History','Exercise less than 1 year','Exercise 1-5 years','Exercise 5+ years'] %}
                    <option value="{{ option }}" {% if user.exercise_history == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <!-- Training Profile -->
          <div class="col-12">
            <hr class="my-2">
            <h5 class="mb-3"><i class="bi bi-clipboard-check me-2"></i>Training Profile</h5>
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label d-block">Fitness Goals <small>(Select up to 2)</small></label>
                <small class="text-muted d-block mb-2">We recommend selecting 1 or 2 goals to keep training focused.</small>
                <div id="fitness-goals-group">
                  {% set goals_list = ((user.fitness_goals or '')).split(',') | map('trim') | list %}
                  {% for goal in ['Lose Weight','Gain Muscle','Tone Muscle','Abs','Increase Strength','Increase Endurance','Feel Better'] %}
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input goal-checkbox"
                             id="{{ goal|lower|replace(' ','-') }}"
                             name="fitness_goals" value="{{ goal }}"
                             {% if goal in goals_list %}checked{% endif %}>
                      <label class="form-check-label" for="{{ goal|lower|replace(' ','-') }}">{{ goal }}</label>
                    </div>
                  {% endfor %}
                </div>
                <div class="text-danger small mt-1" id="goal-warning" style="display:none;"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Commitment</label>
                <select class="form-select" name="commitment">
                  <option value="" disabled>Select an option</option>
                  {% for option in ['1 day per week','2 days per week','3 days per week'] %}
                    <option value="{{ option }}" {% if user.commitment == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Workouts Completed</label>
                <input type="number" class="form-control" name="workouts_completed" value="{{ user.workouts_completed or 0 }}">
              </div>

              <div class="col-md-6">
                <label class="form-label">Sessions Remaining</label>
                <input type="number" class="form-control" name="sessions_remaining" min="0" value="{{ user.sessions_remaining if user.sessions_remaining is not none else '' }}" placeholder="Optional">
              </div>

              <div class="col-12">
                <div class="border rounded-3 p-3 bg-light-subtle">
                  <p class="form-label fw-bold mb-1">Injury or Restriction Intake</p>
                  <p class="form-text text-muted mb-3">Selecting "Yes" ensures workouts skip the selected areas.</p>

                  <div class="d-flex flex-wrap justify-content-center gap-4 mb-3">
                    <div class="form-check">
                      <input type="radio"
                             class="form-check-input"
                             id="injury-status-yes"
                             name="injury_status"
                             value="Yes"
                             {% if injury_status_value == 'Yes' %}checked{% endif %}>
                      <label class="form-check-label" for="injury-status-yes">Yes</label>
                    </div>
                    <div class="form-check">
                      <input type="radio"
                             class="form-check-input"
                             id="injury-status-no"
                             name="injury_status"
                             value="No"
                             {% if injury_status_value != 'Yes' %}checked{% endif %}>
                      <label class="form-check-label" for="injury-status-no">No</label>
                    </div>
                  </div>

                  <div id="injury-fields-wrapper"
                       class="injury-fields-wrapper {% if injury_status_value == 'Yes' %}expanded{% else %}collapsed{% endif %}">
                    <div id="injury-fields"
                         class="injury-fields text-center"
                         data-initial-regions='{{ injury_regions_json | e }}'
                         data-cardio-prefill="{{ 'true' if cardio_checked else 'false' }}">
                      <p class="text-muted small mb-2">Tap the buttons to mark areas this client should avoid.</p>
                      <div class="injury-chip-cloud mb-3">
                        {% for slug in chip_region_slugs %}
                          {% set label = slug.replace('_', ' ')|title %}
                          <button type="button"
                                  class="injury-chip"
                                  data-region="{{ slug }}"
                                  {% if slug in injury_regions %}data-active="true" aria-pressed="true"{% else %}data-active="false" aria-pressed="false"{% endif %}>
                            {{ label }}
                          </button>
                        {% endfor %}
                      </div>

                      <input type="hidden" id="cardio-restriction" name="cardio_restriction" value="{% if cardio_checked %}yes{% endif %}">

                      <div class="mt-3 text-center">
                        <label for="injury-details" class="form-label fw-bold">Additional Details</label>
                        <textarea class="form-control"
                                  id="injury-details"
                                  name="injury_details"
                                  rows="3"
                                  placeholder="Provide context for these restrictions"
                                  required>{{ injury_details }}</textarea>
                      </div>

                      <div class="mt-3 text-start">
                        <span class="small text-muted d-block">Selected areas:</span>
                        <div id="injury-selected" class="injury-selected-pills mt-2 text-start"></div>
                      </div>

                      <input type="hidden" id="injury-input" name="injury" value='{{ injury_regions_json | e }}'>
                    </div>
                  </div>

                  {% set skip_namespace = namespace(items=[]) %}
                  {% if injury_excluded_categories %}
                    {% for token in injury_excluded_categories %}
                      {% if token not in skip_namespace.items %}
                        {% set _ = skip_namespace.items.append(token) %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {% if injury_skipped_subcategories %}
                    {% for token in injury_skipped_subcategories %}
                      {% if token not in skip_namespace.items %}
                        {% set _ = skip_namespace.items.append(token) %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}

                  <div id="injury-alert-banner"
                       class="alert alert-success mt-3 {% if not skip_namespace.items %}d-none{% endif %}"
                       role="status"
                       data-default-categories='{{ (injury_excluded_categories | default([], true)) | tojson }}'
                       data-default-subcategories='{{ (injury_skipped_subcategories | default([], true)) | tojson }}'
                       data-default-cardio="{{ 'true' if cardio_checked else 'false' }}">
                      <strong>Workout adjustments applied:</strong>
                      <span id="injury-alert-message">
                        {% if skip_namespace.items %}
                          Skipping {{ skip_namespace.items | join(', ') }} exercises based on the restrictions above.
                        {% else %}
                          Update this section to configure the client's restrictions.
                        {% endif %}
                      </span>
                    </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Additional Notes</label>
                <textarea class="form-control" name="additional_notes" rows="3">{{ user.additional_notes or '' }}</textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom action bar (mobile friendly) -->
        <div class="d-flex justify-content-between flex-wrap gap-2 mt-4">
          <a href="{{ url_for('admin_users') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i>Back
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save me-1"></i>Update User
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const goalCheckboxes = document.querySelectorAll('.goal-checkbox');
  const goalWarning = document.getElementById('goal-warning');

  goalCheckboxes.forEach((cb) => {
    cb.addEventListener('change', () => {
      const checked = Array.from(goalCheckboxes).filter((c) => c.checked);
      if (checked.length > 2) {
        cb.checked = false;
        if (goalWarning) {
          goalWarning.style.display = 'block';
          goalWarning.textContent = 'You can only select up to 2 fitness goals.';
        }
      } else if (goalWarning) {
        goalWarning.style.display = 'none';
      }
    });
  });

  const injuryFields = document.getElementById('injury-fields');
  const injuryBanner = document.getElementById('injury-alert-banner');
  const injuryMessage = document.getElementById('injury-alert-message');
  const yesRadio = document.getElementById('injury-status-yes');
  const noRadio = document.getElementById('injury-status-no');
  const injuryInput = document.getElementById('injury-input');
  const cardioInput = document.getElementById('cardio-restriction');
  const selectedContainer = document.getElementById('injury-selected');
  const textarea = document.getElementById('injury-details');

  function safeParseJSON(value, fallback) {
    if (!value) return Array.isArray(fallback) ? fallback : [];
    try {
      const parsed = JSON.parse(value);
      if (Array.isArray(parsed)) return parsed;
      if (parsed && typeof parsed === 'object') return Object.values(parsed);
    } catch (_) {
      // ignore
    }
    return Array.isArray(fallback) ? fallback : [];
  }

  function normalizeRegionSlug(value) {
    return String(value || '')
      .trim()
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '_')
      .replace(/^_+|_+$/g, '');
  }

  function formatToken(token) {
    return String(token || '')
      .toLowerCase()
      .replace(/_/g, ' ')
      .replace(/\b\w/g, (c) => c.toUpperCase());
  }

  function updateInjuryAlertBanner(skipped) {
    if (!injuryBanner || !injuryMessage) return;

    const tokens = new Set();
    let cardioLimited = false;

    if (skipped && typeof skipped === 'object') {
      (skipped.categories || []).forEach((entry) => tokens.add(String(entry).toUpperCase()));
      (skipped.subcategories || []).forEach((entry) => tokens.add(String(entry).toUpperCase()));
      if (skipped.cardio_restriction) cardioLimited = true;
    }

    if (cardioLimited) tokens.add('CARDIO');

    if (!tokens.size) {
      injuryBanner.classList.add('d-none');
      injuryMessage.textContent = 'Update this section to configure the client\'s restrictions.';
      return;
    }

    const pretty = Array.from(tokens).map(formatToken).join(', ');
    injuryMessage.textContent = `Skipping ${pretty} exercises based on the restrictions above.`;
    injuryBanner.classList.remove('d-none');
  }

  function hydrateDefaultInjuryAlert() {
    if (!injuryBanner) return;
    const defaults = {
      categories: safeParseJSON(injuryBanner.dataset.defaultCategories, []),
      subcategories: safeParseJSON(injuryBanner.dataset.defaultSubcategories, []),
      cardio_restriction: injuryBanner.dataset.defaultCardio === 'true',
    };
    updateInjuryAlertBanner(defaults);
  }

  if (!injuryFields) {
    hydrateDefaultInjuryAlert();
    return;
  }

  const chips = Array.from(injuryFields.querySelectorAll('.injury-chip'));
  const labels = new Map();
  chips.forEach((chip) => labels.set(chip.dataset.region, chip.textContent.trim()));
  const state = { regions: new Set() };

  function loadInitialState() {
    const initialRegions = safeParseJSON(injuryFields.dataset.initialRegions, []);
    initialRegions.forEach((region) => {
      const slug = normalizeRegionSlug(region);
      if (slug) state.regions.add(slug);
    });
    if (injuryFields.dataset.cardioPrefill === 'true') state.regions.add('cardio');
  }

  function syncHiddenFields() {
    if (injuryInput) {
      injuryInput.value = JSON.stringify(Array.from(state.regions));
    }
    if (cardioInput) {
      const restrictCardio = state.regions.has('cardio');
      cardioInput.value = restrictCardio ? 'yes' : '';
      cardioInput.disabled = false;
    }
  }

  function syncChips() {
    chips.forEach((chip) => {
      const slug = chip.dataset.region;
      const active = state.regions.has(slug);
      chip.classList.toggle('active', active);
      chip.dataset.active = active ? 'true' : 'false';
      chip.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
  }

  function prettyLabel(slug) {
    return labels.get(slug) || slug.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
  }

  function syncSelectedList() {
    if (!selectedContainer) return;
    selectedContainer.innerHTML = '';
    if (!state.regions.size) {
      selectedContainer.innerHTML =
        '<span class="badge bg-secondary-subtle text-muted">No areas selected</span>';
      return;
    }
    state.regions.forEach((slug) => {
      const pill = document.createElement('span');
      pill.className = 'badge injury-pill bg-bitcoin text-dark me-1 mb-1';
      pill.textContent = prettyLabel(slug);
      selectedContainer.appendChild(pill);
    });
  }

  function syncAll() {
    syncHiddenFields();
    syncChips();
    syncSelectedList();
  }

  function clearInjurySection() {
    state.regions.clear();
    syncAll();
    if (textarea) textarea.value = '';
  }

  function toggleInjuryFields(enabled) {
    const wrapper = document.getElementById('injury-fields-wrapper');
    if (wrapper) {
      wrapper.classList.toggle('expanded', enabled);
      wrapper.classList.toggle('collapsed', !enabled);
    }
    injuryFields.classList.toggle('is-disabled', !enabled);
    setTimeout(() => {
      chips.forEach((chip) => (chip.disabled = !enabled));
      if (textarea) textarea.disabled = !enabled;
    }, 200);
    if (!enabled) clearInjurySection();
  }

  function toggleRegion(slug) {
    const normalized = normalizeRegionSlug(slug);
    if (!normalized) return;
    if (state.regions.has(normalized)) state.regions.delete(normalized);
    else state.regions.add(normalized);
    syncAll();
  }

  chips.forEach((chip) => {
    chip.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      toggleRegion(chip.dataset.region);
    });
    chip.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        toggleRegion(chip.dataset.region);
      }
    });
  });

  yesRadio?.addEventListener('change', () => {
    if (yesRadio.checked) toggleInjuryFields(true);
  });
  noRadio?.addEventListener('change', () => {
    if (noRadio.checked) toggleInjuryFields(false);
  });

  loadInitialState();
  syncAll();
  requestAnimationFrame(() => {
    toggleInjuryFields(!!(yesRadio && yesRadio.checked));
  });
  hydrateDefaultInjuryAlert();
});
</script>
{% endblock %}
