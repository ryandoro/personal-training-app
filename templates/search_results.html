{% extends "layout.html" %}
{% block title %}Search Results{% endblock %}

{% block content %}
<div class="page-hero page-hero--scroll">
    <div class="page-card page-card--wide page-card--flush" style="background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
        <div class="page-section text-center">
            <h2 class="fw-semibold mb-1">Your results for “{{ query }}”</h2>
            <p class="text-muted small mb-0">Review maxes, notes, and descriptions for each exercise.</p>
        </div>

        {% if results %}
            <div class="exercise-lookup-results mt-3"
                 id="exercise-lookup-results"
                 tabindex="-1"
                 data-has-query="true">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 lookup-results-grid">
                    {% for workout in results %}
                        {% set workout_id = (workout.workout_id or workout.id) %}
                        {% set workout_name = workout.name or 'Workout' %}
                        {% set workout_category = workout.category or 'General' %}
                        {% set is_cardio = workout_category|lower == 'cardio' %}
                        {% set is_bodyweight = 'bodyweight' in (workout_name|lower) %}
                        {% if is_bodyweight or is_cardio %}
                            {% set weight_display = 'Bodyweight' %}
                        {% elif workout.max_weight is not none %}
                            {% set weight_display = (workout.max_weight|string) ~ ' lbs' %}
                        {% else %}
                            {% set weight_display = '—' %}
                        {% endif %}
                        {% if workout.max_reps is not none %}
                            {% set reps_unit = ' min' if is_cardio else ' reps' %}
                            {% set reps_display = (workout.max_reps|string) ~ reps_unit %}
                        {% else %}
                            {% set reps_display = '—' %}
                        {% endif %}
                        {% set desc_id = 'search-desc-' ~ (workout_id or 'exercise') ~ '-' ~ loop.index0 %}
                        {% set notes_text = workout.notes or '' %}
                        {% set has_notes = notes_text|trim %}
                        {% set is_btn_bodyweight = (not is_cardio and is_bodyweight) %}
                        <div class="col">
                            <div class="card h-100 lookup-result-card shadow-sm" data-workout-card="{{ workout_id }}">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex justify-content-center align-items-center text-center">
                                        <h5 class="card-title text-primary fw-bold mb-0">{{ workout_name }}</h5>
                                    </div>
                                    <div class="personal-best max-summary mt-3 text-center"
                                         data-id="{{ workout_id }}"
                                         data-category="{{ workout_category }}"
                                         data-bodyweight="{{ 'true' if is_btn_bodyweight else 'false' }}">
                                        <span class="max-label text-uppercase fw-semibold d-block small text-muted">Your Max</span>
                                        <div class="max-pill-group d-inline-flex gap-2">
                                            <span class="max-pill max-pill-weight">{{ weight_display }}</span>
                                            <span class="max-pill max-pill-reps">{{ reps_display }}</span>
                                        </div>
                                        <span class="personal-max-text d-none">Your Max: {{ weight_display }} × {{ reps_display }}</span>
                                    </div>
                                    <div class="d-flex flex-column flex-sm-column gap-2 mt-3">
                                        <button class="btn btn-outline-secondary btn-sm max-action-btn update-pr-link update-max-btn"
                                                data-id="{{ workout_id }}"
                                                data-category="{{ workout_category }}"
                                                data-bodyweight="{{ 'true' if is_btn_bodyweight else 'false' }}">
                                            Update Max
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm max-action-btn toggle-description"
                                                type="button"
                                                data-id="{{ desc_id }}"
                                                data-label-show="View Description"
                                                data-label-hide="Hide Description">
                                            View Description
                                        </button>
                                    </div>
                                    <div id="{{ desc_id }}"
                                         class="exercise-description lookup-description mt-3 text-center"
                                         style="display:none;">
                                        <p class="small text-muted mb-0">{{ workout.description or 'No description available.' }}</p>
                                    </div>
                                    <div class="exercise-notes mt-3 text-start">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <i class="bi bi-journal-text text-primary"></i>
                                            <button class="btn btn-outline-info btn-sm edit-notes-btn"
                                                    data-id="{{ workout_id }}"
                                                    data-notes="{{ notes_text|urlencode }}">
                                                {{ 'Edit Notes' if has_notes else 'Add Notes' }}
                                            </button>
                                        </div>
                                        <div class="notes-body small" data-id="{{ workout_id }}">
                                            {% if has_notes %}
                                                {{ notes_text|replace('\n', '<br>')|safe }}
                                            {% else %}
                                                <span class="text-muted">{{ NOTES_PLACEHOLDER }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning text-center shadow-sm brand-alert" role="alert">
                No results found for “{{ query }}”.
            </div>
        {% endif %}
    </div>
</div>

<!-- Max Update Modal -->
<div id="updateMaxModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="btn-close" id="closeModal"></button>
        <h5 class="mb-3">Update Max</h5>
        <input type="hidden" id="modalWorkoutId">
        <input type="number" id="newWeight" class="form-control mb-2" placeholder="Max Weight (lbs)" title="Bodyweight exercises do not require a weight entry">
        <input type="number" id="newReps" class="form-control mb-3" placeholder="Max Reps">
        <button class="btn btn-brand w-100" id="saveMaxBtn">Save</button>
    </div>
</div>

<!-- Notes Modal -->
<div id="notesModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
        <button type="button" class="btn-close" id="notesModalClose"></button>
        <h5 class="mb-3">Exercise Notes</h5>
        <textarea id="notesTextarea" class="form-control mb-3" rows="5" placeholder="Add your personal notes..."></textarea>
        <button class="btn btn-brand w-100" id="saveNotesBtn">Save</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('updateMaxModal');
    const workoutIdInput = document.getElementById('modalWorkoutId');
    const weightInput = document.getElementById('newWeight');
    const repsInput = document.getElementById('newReps');
    const closeModalBtn = document.getElementById('closeModal');
    const saveMaxBtn = document.getElementById('saveMaxBtn');
    const notesModal = document.getElementById('notesModal');
    const notesTextarea = document.getElementById('notesTextarea');
    const notesModalClose = document.getElementById('notesModalClose');
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    const toast = document.getElementById('toastSuccess');
    const updatePrUrl = "{{ url_for('update_pr') }}";
    const updateNotesUrl = "{{ url_for('update_notes') }}";
    const NOTES_PLACEHOLDER = {{ NOTES_PLACEHOLDER|tojson }};
    let toastTimeout = null;
    let activeNotesWorkoutId = null;

    function escapeHtml(value) {
        const div = document.createElement('div');
        div.textContent = value ?? '';
        return div.innerHTML;
    }

    function showToast(message) {
        if (!toast) return;
        if (toastTimeout) {
            clearTimeout(toastTimeout);
        }
        toast.textContent = message;
        toast.style.display = 'block';
        toastTimeout = setTimeout(() => {
            toast.style.display = 'none';
        }, 2000);
    }

    function closePrModal() {
        if (!modal) return;
        modal.style.display = 'none';
        modal.removeAttribute('data-cardio');
        modal.removeAttribute('data-bodyweight');
        if (workoutIdInput) workoutIdInput.value = '';
        if (weightInput) {
            weightInput.value = '';
            weightInput.disabled = false;
            weightInput.placeholder = 'Max Weight (lbs)';
        }
        if (repsInput) {
            repsInput.value = '';
            repsInput.placeholder = 'Max Reps';
        }
    }

    function openPrModal(button) {
        if (!modal || !button || !workoutIdInput) return;
        const workoutId = button.dataset.id;
        const category = (button.dataset.category || '').toLowerCase();
        const isCardio = category === 'cardio';
        const isBodyweight = button.dataset.bodyweight === 'true';
        workoutIdInput.value = workoutId || '';
        modal.dataset.cardio = isCardio ? '1' : '0';
        modal.dataset.bodyweight = isBodyweight ? '1' : '0';

        const personalBest = document.querySelector(`.personal-best[data-id="${workoutId}"]`);
        const weightSpan = personalBest?.querySelector('.max-pill-weight');
        const repsSpan = personalBest?.querySelector('.max-pill-reps');
        const disableWeight = isCardio || isBodyweight;

        if (weightInput) {
            weightInput.disabled = disableWeight;
            if (disableWeight) {
                weightInput.value = '';
                weightInput.placeholder = isCardio ? 'Cardio' : 'Bodyweight';
            } else {
                const numericWeight = weightSpan ? parseFloat(weightSpan.textContent.replace(/[^0-9.]+/g, '')) : NaN;
                weightInput.value = Number.isFinite(numericWeight) ? numericWeight : '';
                weightInput.placeholder = 'Max Weight (lbs)';
            }
        }

        if (repsInput) {
            const numericReps = repsSpan ? parseInt(repsSpan.textContent.replace(/[^0-9]+/g, ''), 10) : NaN;
            repsInput.value = Number.isFinite(numericReps) ? numericReps : '';
            repsInput.placeholder = isCardio ? 'Minutes' : 'Reps';
        }

        modal.style.display = 'flex';
    }

    document.querySelectorAll('.update-max-btn').forEach((button) => {
        button.addEventListener('click', () => openPrModal(button));
    });

    closeModalBtn?.addEventListener('click', closePrModal);
    modal?.addEventListener('click', (event) => {
        if (event.target === modal) {
            closePrModal();
        }
    });

    saveMaxBtn?.addEventListener('click', async () => {
        if (!modal || !workoutIdInput) return;
        const workoutId = workoutIdInput.value;
        if (!workoutId) return;

        const isCardio = modal.dataset.cardio === '1';
        const isBodyweight = modal.dataset.bodyweight === '1';
        const repsValue = repsInput ? parseInt(repsInput.value, 10) : NaN;
        if (!Number.isFinite(repsValue)) {
            alert('Please enter a valid number of reps or minutes.');
            return;
        }

        let weightValue = null;
        if (!isCardio && !isBodyweight) {
            weightValue = weightInput ? parseFloat(weightInput.value) : NaN;
            if (!Number.isFinite(weightValue)) {
                alert('Please enter a valid weight.');
                return;
            }
        }

        const payload = { workout_id: workoutId, max_reps: repsValue };
        if (Number.isFinite(weightValue)) {
            payload.max_weight = Number(weightValue.toFixed(1));
        }

        try {
            const response = await fetch(updatePrUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!data.success) {
                alert(data.error || 'Error updating max. Please try again.');
                return;
            }

            const returnedWeight = data.max_weight;
            const returnedReps = data.max_reps;
            const personalBestBlocks = document.querySelectorAll(`.personal-best[data-id="${workoutId}"]`);
            personalBestBlocks.forEach((block) => {
                const weightSpan = block.querySelector('.max-pill-weight');
                const repsSpan = block.querySelector('.max-pill-reps');
                const summary = block.querySelector('.personal-max-text');
                const blockCategory = (block.dataset.category || '').toLowerCase();
                const treatAsBodyweight = block.dataset.bodyweight === 'true' || blockCategory === 'cardio';

                if (weightSpan) {
                    if (treatAsBodyweight) {
                        weightSpan.textContent = 'Bodyweight';
                    } else if (returnedWeight !== null && returnedWeight !== undefined) {
                        const parsedWeight = parseFloat(returnedWeight);
                        weightSpan.textContent = Number.isFinite(parsedWeight) ? `${parsedWeight.toFixed(1)} lbs` : '—';
                    } else {
                        weightSpan.textContent = '—';
                    }
                }

                if (repsSpan) {
                    if (returnedReps !== null && returnedReps !== undefined) {
                        const parsedReps = parseInt(returnedReps, 10);
                        if (Number.isFinite(parsedReps)) {
                            repsSpan.textContent = blockCategory === 'cardio' ? `${parsedReps} min` : `${parsedReps} reps`;
                        } else {
                            repsSpan.textContent = '—';
                        }
                    } else {
                        repsSpan.textContent = '—';
                    }
                }

                if (summary && weightSpan && repsSpan) {
                    summary.textContent = `Your Max: ${weightSpan.textContent} × ${repsSpan.textContent}`;
                }
            });

            closePrModal();
            showToast('Max updated!');
        } catch (error) {
            console.error(error);
            alert('Error updating max. Please try again.');
        }
    });

    document.addEventListener('click', (event) => {
        const toggle = event.target.closest('.toggle-description');
        if (toggle) {
            event.preventDefault();
            const descId = toggle.dataset.id;
            const descElement = document.getElementById(descId);
            if (!descElement) return;
            const isHidden = descElement.style.display === 'none' || descElement.style.display === '';

            if (isHidden) {
                descElement.style.display = 'block';
                descElement.style.maxHeight = '0px';
                descElement.style.overflow = 'hidden';
                descElement.style.transition = 'max-height 0.3s ease-out';
                requestAnimationFrame(() => {
                    descElement.style.maxHeight = descElement.scrollHeight + 'px';
                });
                toggle.textContent = toggle.dataset.labelHide || 'Hide Description';
            } else {
                descElement.style.maxHeight = '0px';
                setTimeout(() => {
                    descElement.style.display = 'none';
                }, 300);
                toggle.textContent = toggle.dataset.labelShow || 'View Description';
            }
        }

        const notesTrigger = event.target.closest('.edit-notes-btn');
        if (notesTrigger) {
            event.preventDefault();
            activeNotesWorkoutId = notesTrigger.dataset.id;
            const existing = notesTrigger.dataset.notes ? decodeURIComponent(notesTrigger.dataset.notes) : '';
            if (notesTextarea) {
                notesTextarea.value = existing;
            }
            if (notesModal) {
                notesModal.style.display = 'flex';
            }
        }
    });

    function closeNotesModal() {
        if (!notesModal) return;
        notesModal.style.display = 'none';
        activeNotesWorkoutId = null;
        if (notesTextarea) {
            notesTextarea.value = '';
        }
    }

    notesModalClose?.addEventListener('click', closeNotesModal);
    notesModal?.addEventListener('click', (event) => {
        if (event.target === notesModal) {
            closeNotesModal();
        }
    });

    saveNotesBtn?.addEventListener('click', async () => {
        if (!activeNotesWorkoutId) {
            closeNotesModal();
            return;
        }
        const noteValue = notesTextarea ? notesTextarea.value : '';
        try {
            const response = await fetch(updateNotesUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workout_id: activeNotesWorkoutId, notes: noteValue })
            });
            const data = await response.json();
            if (!data.success) {
                alert(data.error || 'Unable to save notes.');
                return;
            }
            const normalized = data.notes || '';
            const hasNoteContent = normalized.trim().length > 0;
            const displayHtml = hasNoteContent
                ? escapeHtml(normalized).replace(/\n/g, '<br>')
                : `<span class="text-muted">${escapeHtml(NOTES_PLACEHOLDER)}</span>`;

            document.querySelectorAll(`.notes-body[data-id="${activeNotesWorkoutId}"]`).forEach((node) => {
                node.innerHTML = displayHtml;
            });

            document.querySelectorAll(`.edit-notes-btn[data-id="${activeNotesWorkoutId}"]`).forEach((btn) => {
                btn.dataset.notes = encodeURIComponent(normalized);
                btn.textContent = hasNoteContent ? 'Edit Notes' : 'Add Notes';
            });

            closeNotesModal();
            showToast('Notes updated!');
        } catch (error) {
            console.error(error);
            alert('Unable to save notes right now.');
        }
    });
});
</script>

<!-- Success Toast -->
<div id="toastSuccess" class="toast-floating toast-success" style="display:none;">
    Success!
</div>
{% endblock %}
