{% extends "layout.html" %}
{% block title %}Search Results{% endblock %}

{% block content %}
<div class="page-hero page-hero--scroll">
    <div class="page-card page-card--wide page-card--flush">
        <div class="page-section text-center">
            <h2 class="fw-semibold mb-1">Your results for “{{ query }}”</h2>
        </div>

        {% if results %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for workout_id, name, description, category, max_weight, max_reps in results %}
                    <div class="col">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-primary fw-bold">{{ name }}</h5>
                                <p class="card-text text-muted small">{{ description }}</p>
                                <div class="mt-3">
                                    <span class="fw-semibold">Your Max:</span>
                                    {% set is_cardio = 'cardio' in category|lower %}
                                    {% set is_bodyweight = 'bodyweight' in name|lower or max_weight == 0 %}
                                    
                                    {% if is_cardio %}
                                        {% if max_reps is not none %}
                                            <span class="text-dark">Bodyweight × {{ max_reps }} min</span>
                                        {% else %}
                                            <span class="text-muted fst-italic">No max recorded</span>
                                        {% endif %}
                                    {% elif is_bodyweight %}
                                        {% if max_reps is not none %}
                                            <span class="text-dark">Bodyweight × {{ max_reps }} reps</span>
                                        {% else %}
                                            <span class="text-muted fst-italic">No max recorded</span>
                                        {% endif %}
                                    {% elif max_weight is not none and max_reps is not none %}
                                        <span class="text-dark">{{ max_weight|float|round(1) }} lbs × {{ max_reps }} reps</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">No max recorded</span>
                                    {% endif %}                                    
                                </div>
                                <div class="mt-2">                        
                                    <button class="btn btn-brand-outline btn-sm mt-2 update-max-btn" 
                                            data-id="{{ workout_id }}"
                                            data-weight="{{ max_weight or '' }}"
                                            data-reps="{{ max_reps or '' }}"
                                            data-category="{{ category }}">
                                        Update Max
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-warning text-center shadow-sm brand-alert" role="alert">
                No results found for “{{ query }}”.
            </div>
        {% endif %}
    </div>
</div>
<!-- Max Update Modal -->
    <div id="updateMaxModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <button type="button" class="btn-close" id="closeModal"></button>
            <h5 class="mb-3">Update Max</h5>
            <input type="hidden" id="modalWorkoutId">
            <input type="number" id="newWeight" class="form-control mb-2" placeholder="Max Weight (lbs)" title="Bodyweight exercises do not require a weight entry">
            <input type="number" id="newReps" class="form-control mb-3" placeholder="Max Reps">
            <button class="btn btn-brand w-100" id="saveMaxBtn">Save</button>
        </div>
    </div>
    
  
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('updateMaxModal');
            const workoutIdInput = document.getElementById('modalWorkoutId');
            const weightInput = document.getElementById('newWeight');
            const repsInput = document.getElementById('newReps');
            const closeModal = document.getElementById('closeModal');

            document.querySelectorAll('.update-max-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const workoutName = btn.closest('.card-body').querySelector('.card-title').textContent || '';
                    const category = btn.dataset.category || '';
                    const isCardio = category.toLowerCase() === 'cardio';
                    const isBodyweight = workoutName.toLowerCase().includes('bodyweight');

                    workoutIdInput.value = btn.dataset.id;
                    weightInput.disabled = isBodyweight || isCardio;
                    weightInput.placeholder = isBodyweight || isCardio ? 'Bodyweight exercise' : 'Max Weight (lbs)';
                    weightInput.title = weightInput.placeholder;
                    weightInput.value = '';

                    repsInput.placeholder = isCardio ? 'Minutes' : 'Reps';
                    repsInput.title = repsInput.placeholder;
                    repsInput.value = '';

                    try {
                        const response = await fetch(`/exercise_progress/${workoutIdInput.value}`);
                        const payload = response.ok ? await response.json() : { success: false };
                        if (payload && payload.success) {
                            const latestWeight = payload.max_weight;
                            const latestReps = payload.max_reps;

                            weightInput.value = (isBodyweight || isCardio) ? '' : (Number.isFinite(latestWeight) ? latestWeight : '');

                            repsInput.value = Number.isFinite(latestReps) ? latestReps : '';
                        }
                    } catch (err) {
                        console.error('Failed loading latest progress', err);
                        weightInput.value = '';
                        repsInput.value = '';
                    }

                    modal.style.display = 'flex';
                });
            });

            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            document.getElementById('saveMaxBtn').addEventListener('click', async () => {
                const max_weight = parseFloat(weightInput.value);
                const max_reps = parseInt(repsInput.value);
                const isBodyweight = weightInput.disabled;
                const workout_id = workoutIdInput.value;

                const btn = document.querySelector(`.update-max-btn[data-id="${workout_id}"]`);
                const category = btn?.dataset.category || '';
                const isCardio = category.toLowerCase() === 'cardio';

                if (isNaN(max_reps) || (!isBodyweight && isNaN(max_weight))) {
                    alert("Please enter valid values.");
                    return;
                }

                const response = await fetch('/update_pr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workout_id, max_weight, max_reps })
                });

                const data = await response.json();
                if (data.success) {
                    modal.style.display = 'none';
                    // Update the max text in the correct card
                    const card = document.querySelector(`.update-max-btn[data-id="${workout_id}"]`).closest('.card-body');
                    const maxTextSpan = card.querySelector('span.text-dark, span.text-muted');

                    const displayReps = isCardio
                        ? `${max_reps} min`
                        : `${max_reps} reps`;
                    let weightLabel;
                    if (isCardio || isBodyweight) {
                        weightLabel = 'Bodyweight';
                    } else {
                        weightLabel = `${max_weight.toFixed(1)} lbs`;
                    }

                    if (maxTextSpan) {
                        maxTextSpan.classList.remove('text-muted', 'fst-italic');
                        maxTextSpan.classList.add('text-dark');
                        maxTextSpan.textContent = isCardio
                            ? `Bodyweight × ${max_reps} min`
                            : (isBodyweight ? `Bodyweight × ${max_reps} reps` : `${weightLabel} × ${max_reps} reps`);
                    }

                    if (btn) {
                        btn.dataset.weight = (isCardio || isBodyweight) ? '' : max_weight.toFixed(1);
                        btn.dataset.reps = max_reps;
                    }
                    // Show success toast
                    const toast = document.getElementById('toastSuccess');
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 2000);
                } else {
                    alert("Error updating max. Please try again.");
                }
            });
        });
    </script>    

    <!-- Success Toast -->
    <div id="toastSuccess" class="toast-floating toast-success">
    Max updated!
    </div>
{% endblock %}
