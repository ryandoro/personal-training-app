{% extends "layout.html" %}

{% block title %}
    Home
{% endblock %}

{% block content %}
<div class="index-hero">
    <div class="index-card mb-0" style="background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);">
        <header class="index-header text-center">
            <div class="collab-branding">
                <span class="collab-logo-pill">
                    <img src="{{ url_for('static', filename='images/western_logo.jpeg') }}" alt="Western Racquet and Fitness Club logo" class="collab-logo">
                </span>
                <span class="collab-divider">Ã—</span>
                <span class="hero-pill">FitBase<span class="text-orange">AI</span></span>
            </div>
            {% if name %}
                <h1 class="display-5 fw-bold">Welcome back, {{ name }}!</h1>
            {% else %}
                <h1 class="display-5 fw-bold">Welcome!</h1>
            {% endif %}
            <p class="lead text-muted fst-italic">Train aware. Live ready.</p>
        </header>

        <section class="index-intro">
            <p>
                Generate custom workouts, track your progress, and see your goals come to life. Letâ€™s keep moving forward together!
            </p>
            {% if not name %}
                <p class="mt-2">
                    To get started, head over to the <a href="{{ url_for('training') }}" class="link-blue fw-semibold">training page</a> and fill out your fitness questionnaire.
                </p>
            {% endif %}
        </section>

        <section class="index-stats">
            <h2 class="section-title text-uppercase">Your Stats</h2>
            <div class="stats-grid">
                <article class="stat-card">
                    <span class="stat-label">Workouts Completed</span>
                    <span class="stat-value">{{ workouts_completed }}</span>
                </article>
                <article class="stat-card">
                    <span class="stat-label">Last Workout Completed</span>
                    {% if last_workout_completed != "No workouts completed yet" %}
                        <a class="stat-link" href="{{ url_for('workout_details', category=last_workout_completed) }}">
                            {{ last_workout_completed }}
                            <span class="stat-link-icon">â€º</span>
                        </a>
                    {% else %}
                        <span class="stat-placeholder">{{ last_workout_completed }}</span>
                    {% endif %}
                </article>
                <article class="stat-card goals-card">
                    {% set goal_list = fitness_goals.split(',') if fitness_goals else [] %}
                    <span class="stat-label">Current Goal{{ goal_list | length > 1 and 's' or '' }}</span>
                    {% if goal_list %}
                        <div class="goal-chip-row">
                            {% for goal in goal_list %}
                                <span class="goal-chip">{{ goal.strip() }}</span>
                            {% endfor %}
                        </div>
                        {% if form_completed %}
                            <button class="goal-manage-btn" data-bs-toggle="modal" data-bs-target="#updateGoalsModal">
                                <i class="bi bi-pencil me-1"></i> Update Goals
                            </button>
                        {% endif %}
                    {% else %}
                        <span class="stat-placeholder">Not set yet</span>
                    {% endif %}
                </article>
            </div>
        </section>

        <section class="index-cta text-center">
            <p class="cta-copy mb-4">Ready for your next workout? Head over to the training page and get started with your personalized plan.</p>
            <a href="/training" 
               id="launch-training"
               class="btn btn-lg btn-ignite"
               role="button"
               tabindex="0">
               Launch Training
            </a>
        </section>
    </div>
</div> 

<div class="orb-container text-center">
    <div class="orb-wrapper">
        <img id="fitbase-orb"
            src="{{ url_for('static', filename='images/fitbaseai_orb.png') }}"
            alt="FitBaseAI Energy Core">
    </div>
</div> 

<!-- Update Goals Modal -->
<div class="modal fade" id="updateGoalsModal" tabindex="-1" aria-labelledby="updateGoalsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <form method="POST" action="{{ url_for('update_goals') }}">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="updateGoalsModalLabel">Update Your Fitness Goals</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            {% set goal_options = ["Lose Weight", "Gain Muscle", "Tone Muscle", "Abs", "Increase Strength", "Increase Endurance", "Feel Better"] %}
            {% for goal in goal_options %}
                <div class="form-check">
                    <input class="form-check-input update-goal-checkbox" type="checkbox" name="fitness_goals" value="{{ goal }}" id="goal_{{ loop.index }}">
                    <label class="form-check-label" for="goal_{{ loop.index }}">
                        {{ goal }}
                    </label>
                </div>
            {% endfor %}
            <div class="text-danger small mt-2" id="goalError" style="display: none;">Please select 1 or 2 goals.</div>
            </div>
            <div class="modal-footer">
            <button type="submit" class="btn btn-brand">Save Changes</button>
            </div>
        </div>
        </form>
    </div>
    </div>        

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkboxes = document.querySelectorAll('.update-goal-checkbox');
            const goalError = document.getElementById('goalError');
        
            function updateCheckboxStates() {
                const checked = Array.from(checkboxes).filter(cb => cb.checked);
                checkboxes.forEach(cb => {
                    cb.disabled = checked.length >= 2 && !cb.checked;
                });
            }
        
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateCheckboxStates);
            });
        
            // Prevent submission if 0 or more than 2 goals selected
            const form = document.querySelector('#updateGoalsModal form');
            form.addEventListener('submit', function (e) {
                const checked = Array.from(checkboxes).filter(cb => cb.checked);
                if (checked.length < 1 || checked.length > 2) {
                    e.preventDefault();
                    goalError.style.display = 'block';
                }
            });
        
            updateCheckboxStates();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const orb = document.getElementById('fitbase-orb');
            const launchLink = document.getElementById('launch-training');
            const igniteButtons = document.querySelectorAll('.btn-ignite');

            if (orb) {
                orb.classList.remove('glow');
                orb.style.removeProperty('animation');
                orb.style.removeProperty('animationPlayState');
            }

            // ðŸ’¡ Touch highlight (mobile-friendly focus ring)
            igniteButtons.forEach(btn => {
                btn.addEventListener('touchstart', () => {
                    btn.classList.add('focus-ring');
                });
            });

            // âš¡ Orb + button ignition click/tap
            if (launchLink && orb) {
                launchLink.addEventListener('click', e => {
                    e.preventDefault();

                    // ðŸŒ€ Force reflow (ensure Safari paints paused state cleanly)
                    orb.offsetHeight;

                    // âš¡ Instantly snap to glow state â€” temporarily disable transitions
                    orb.style.transition = 'none';
                    orb.classList.add('glow');

                    // âš¡ Add focus ring simultaneously
                    launchLink.classList.add('focus-ring');

                    // ðŸ•’ Wait one animation frame, then restore transitions for natural fade
                    requestAnimationFrame(() => {
                        orb.style.transition = ''; // re-enable transitions for future animations

                        // ðŸ•“ Navigate after visible glow
                        setTimeout(() => {
                            window.location.href = launchLink.href;
                        }, 700);
                    });
                });
            }
        });
</script>
{% endblock %}
